#!/bin/bash
#
# Univention Installer
#
# Copyright 2004-2011 Univention GmbH
#
# http://www.univention.de/
#
# All rights reserved.
#
# The source code of this program is made available
# under the terms of the GNU Affero General Public License version 3
# (GNU AGPL V3) as published by the Free Software Foundation.
#
# Binary versions of this program provided by Univention to you as
# well as other copyrighted, protected or trademarked materials like
# Logos, graphics, fonts, specific documentations and configurations,
# cryptographic keys etc. are subject to a license agreement between
# you and Univention and not subject to the GNU AGPL V3.
#
# In the case you use this program under the terms of the GNU AGPL V3,
# the program is provided in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public
# License with the Debian GNU/Linux or Univention distribution in file
# /usr/share/common-licenses/AGPL-3; if not, see
# <http://www.gnu.org/licenses/>.


forceascii=`cat /proc/cmdline | grep " forceascii"`
recover=`cat /proc/cmdline | grep " recover"`
expert_partition=`cat /proc/cmdline | grep "expert_partition"`
params[${#params[@]}]="--cmdline"

# disable console blanking
setterm -powersave off
setterm -powerdown 0
setterm -blank 0

#check architecture
architecture=`uname -m`

if [ -n "$forceascii" ] ; then
	params[${#params[@]}]="--simple"
fi

if [ -n "$architecture" ] && [ "$architecture" = "ppc64" ]; then
	params[${#params[@]}]="--simple"
fi

if [ -s /.ucs-edition ]; then
	params[${#params[@]}]="--edition"
	params[${#params[@]}]="$(cat /.ucs-edition)"
fi

if [ -s /.ucs-version ]; then
	params[${#params[@]}]="--version"
	params[${#params[@]}]="$(cat /.ucs-version)"
fi

if [ -s /.ucs-name ]; then
	params[${#params[@]}]="--name"
	params[${#params[@]}]="$(cat /.ucs-name)"
fi

if [ -s /.ucs-codename ]; then
	params[${#params[@]}]="--codename"
	params[${#params[@]}]="$(cat /.ucs-codename)"
fi

if [ -s /.ucs-extension ]; then
	params[${#params[@]}]="--extension"
	params[${#params[@]}]="$(cat /.ucs-extension)"
fi

if [ -n "$expert_partition" ]; then
	params[${#params[@]}]="--expert_partition"
fi

if [ -n "$recover" ]; then


	/bin/python2.6 -OO /lib/univention-installer/main.py "${params[@]}"
	echo "Starting recover shell"
	echo ""
	/bin/sh
else
	while [ ! -e /tmp/installation_profile ]; do

		/bin/python2.6 -OO /lib/univention-installer/main.py "${params[@]}"

		if [ ! -e /tmp/installation_profile ]; then
			echo "Press Return to restart the installer program."
			read foo
			continue
		fi

		echo "" >> /tmp/installer.log
		echo "------------------------------------------" >> /tmp/installer.log
		echo " PROFILE COMPLETE - STARTING INSTALLATION" >> /tmp/installer.log
		echo "------------------------------------------" >> /tmp/installer.log
		echo "" >> /tmp/installer.log

		lib/univention-installer-scripts.d/00_scripts.sh
		for i in lib/univention-installer-scripts.d/*; do
			if [ "$i" = lib/univention-installer-scripts.d/00_scripts.sh ]; then
				continue
			fi
			if [ "$i" = lib/univention-installer-scripts.d/99_reboot.sh ]; then
				continue
			fi
			if [ "$i" = lib/univention-installer-scripts.d/95_completemsg.sh ]; then
				continue
			fi
			if [ -e /tmp/logging ]; then
				mkdir -p /instmnt/var/log/univention/
				touch /instmnt/var/log/univention/installation.log
				chown root:adm /instmnt/var/log/univention/installation.log
				chmod 640 /instmnt/var/log/univention/installation.log

				if [ -e /tmp/installer.log -a ! -e /instmnt/var/log/univention/installer.log ] ; then
					cat /tmp/installer.log >> /instmnt/var/log/univention/installer.log
					chown root:adm /instmnt/var/log/univention/installer.log
					chmod 640 /instmnt/var/log/univention/installer.log
				fi

				if [ -e /tmp/debootstrap.log.gz ]; then
					cp /tmp/debootstrap.log.gz /instmnt/var/log/univention/
					chown root:adm /instmnt/var/log/univention/debootstrap.log.gz
					chmod 640 /instmnt/var/log/univention/debootstrap.log.gz
				fi
			fi
			if [ -e /tmp/logging ]; then
				/bin/sh $i </dev/tty1 2>&1 | tee -a /instmnt/var/log/univention/installation.log
			else
				/bin/sh $i </dev/tty1 | tee -a /tmp/installer.log
			fi
		done
		if [ -e /tmp/logging ]; then
			gzip /instmnt/var/log/univention/installation.log
			gzip /instmnt/var/log/univention/installer.log
		fi
		lib/univention-installer-scripts.d/95_completemsg.sh
		lib/univention-installer-scripts.d/99_reboot.sh

	done
fi
