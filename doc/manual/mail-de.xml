<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE chapter [
	<!ENTITY % extensions SYSTEM "../stylesheets/macros.ent" >
	<!ENTITY % DocBookDTD PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
	"http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd">
	<!ENTITY % entities SYSTEM "../stylesheets/macros-de.ent" >
	%extensions;
	%DocBookDTD;
	%entities;
]>
<chapter id="mail::general">
  <title>Maildienste</title>

  <section id="mail::introduction">
	<title>Einführung</title>
	<para>
	  &ucsUCS; stellt Maildienste bereit, auf die Benutzer sowohl über
	  Standard-Mail-Clients wie Thunderbird, als auch über das Webmail-Interface Horde zugreifen
	  können.
	</para>

	<para>
	  Für den Mailempfang und -versand wird Postfix verwendet. In der Grundinstallation wird auf
	  jedem UCS-System eine für die lokale Mailzustellung ausgelegte Konfiguration
	  eingerichtet. Postfix nimmt in dieser Konfiguration E-Mails nur vom lokalen System
	  entgegen, und auch die Zustellung erfolgt nur für lokale Systembenutzer.
    </para>

	<para>
	  Durch die Installation der Mailserver-Komponente wird ein vollständiger Mailtransport
	  über SMTP umgesetzt (siehe <xref linkend="mail::installation"/>).
	  <!--Die nachfolgenden Funktionen stehen nur bei Verwendung der Mailserver-Komponente zur Verfügung.-->
	  Postfix wird bei der Installation der Komponente umkonfiguriert, so dass
	  bei eingehenden E-Mails eine Gültigkeitsüberprüfung in Form einer
	  Suche im LDAP-Verzeichnis durchgeführt wird. Das bedeutet, dass E-Mails nur für im
	  LDAP-Verzeichnis eingetragene oder über einen Alias definierte E-Mail-Adressen
	  akzeptiert werden.
	</para>

	<para>
	  Mit der Mailserver-Komponente wird ebenfalls der IMAP-Dienst
	  Dovecot auf dem System installiert. Dieser stellt E-Mailkonten für die Benutzer
	  der Domäne bereit und bietet entsprechende Schnittstellen für den Zugriff
	  durch E-Mail-Clients an.
	  Dovecot ist für den Abruf von E-Mails über IMAP und POP3 vorkonfiguriert. Der
	  Zugriff über POP3 kann durch Setzen der &ucsUCRV; <envar>mail/dovecot/pop</envar>
	  auf <literal>no</literal> deaktiviert werden. Das gleiche gilt für IMAP und
	  die &ucsUCRV; <envar>mail/dovecot/imap</envar>.
	  Auch die weitere Konfiguration der Mailserver erfolgt über &ucsUCR; (siehe
	  <xref linkend="mail::serverconfig::general"/>).

		<note>
			<para>
				Seit &ucsUCS; Version 4.0-2 wird standardmäßig Dovecot als IMAP- und
				POP3-Server verwendet. Die Integration von Cyrus ist seit &ucsUCS;
				Version 4.3-0 nicht mehr verfügbar.
			</para>
		</note>
		</para>

	<para>
	  Die Verwaltung der Benutzerdaten des Mailservers (z.B. E-Mail-Adressen oder
	  Verteiler) erfolgt über &ucsUMC; und ist in
	  <xref linkend="mail::management::general"/> dokumentiert. Benutzerdaten werden
	  in LDAP gespeichert.
	  Die Authentifizierung wird anhand der primären E-Mail-Adresse eines Benutzers
	  durchgeführt, d.h. sie muss als Benutzername in Mail-Clients eingetragen werden.
	  Sobald einem Benutzer im LDAP-Verzeichnis eine primäre E-Mail-Adresse zugeordnet wird,
	  legt ein Listener-Modul ein IMAP-Postfach auf dem Mail Home Server an.
	  Durch die Angabe eines Mail Home Servers können E-Mail-Konten der Benutzer
	  auch auf mehrere Mailserver verteilt werden (siehe <xref linkend="mail::homeserver"/>).
	</para>

	<para>
	  Optional können durch Postfix empfangene E-Mails vor der weiteren Verarbeitung
	  durch Dovecot auf Spam-Inhalte und Viren hin untersucht werden.
	  Spam-Mails werden über die Klassifizierungssoftware SpamAssassin erkannt
	  (<xref linkend="mail::spam"/>), für die Erkennung von Viren und anderer
	  Malware wird ClamAV eingesetzt (<xref linkend="mail::viren"/>).
	</para>

	<para>
	  In der Voreinstellung werden E-Mails an fremde Domänen
	  direkt dem zuständigen SMTP-Server der Domäne zugestellt.
	  Die Ermittlung erfolgt dabei durch die
	  Auflösung des MX-Records im DNS. Der Mailversand kann auch von einem
	  Relay-Host z.B. beim Internet-Provider übernommen werden
	  (siehe <xref linkend="mail::serverconfig::relay"/>).
	</para>

	<para>
	  Für den webbasierten Zugriff auf E-Mails steht das Horde-Framework zur
	  Verfügung (siehe <xref linkend="mail::horde"/>).
	  Das UCS-Mailsystem bietet keine Groupware-Funktionalität wie gemeinsam
	  genutzte Kalender oder Termineinladungen. Es existieren aber auf UCS basierende
	  Groupwaresysteme, die sich in das UCS-Managementsystem integrieren,
	  bspw. Kolab, Zarafa oder Open-Xchange. Weiterführende Informationen finden
	  sich im Univention App Center (siehe <xref linkend="software:appcenter"/>).
	</para>
  </section>

  <section id="mail::installation">
	<title>Installation</title>

	<para>
	  Ein Mailserver kann mit der Applikation <emphasis>Mailserver</emphasis> aus dem Univention App Center installiert
	  werden. Alternativ kann das Softwarepaket <package>univention-mail-server</package> installiert
	  werden. Weitere Informationen finden sich in <xref linkend="computers::softwaremanagement::installsoftware"/>.
	  Mailserver können auf allen Server-Systemrollen installiert werden. Die
	  Verwendung eines Domänencontrollers wird wg. häufiger LDAP-Zugriffe empfohlen.
	</para>

	<para>
	  Die Laufzeitdaten des Dovecot-Servers werden im Verzeichnis <filename class="directory">/var/spool/dovecot/</filename>
	  abgelegt. Falls dieses Verzeichnis auf einem NFS-Laufwerk liegen sollte,
        lesen Sie bitte <xref linkend="mail::serverconfig::nfs"/>.
	</para>

	<para>
	  Das Webmail-Interface Horde kann über das Univention App Center installiert werden (siehe
	  <xref linkend="software:appcenter"/>).
	</para>

  </section>


  <section id="mail::management::general">
	<title>Verwaltung der Mailserver-Daten</title>

	<section id="mail::management::domains">
	  <title>Verwaltung von Mail-Domänen</title>
	  <para>
		Eine Mail-Domäne ist ein gemeinsamer Namensraum für E-Mail-Adressen, Mailinglisten und
		IMAP-Gruppen-Ordner. Postfix unterscheidet bei der Zustellung von E-Mails
		zwischen lokalen und externen Domänen. Nur für E-Mail-Adressen lokaler Domänen
		wird die Mailzustellung vorgenommen.
		Der Name einer Mail-Domäne darf nur aus Kleinbuchstaben, den Ziffern
		0-9, Punkten und Bindestrichen bestehen.
	  </para>
	  <para>
		Mit UCS lassen sich mehrere Mail-Domänen verwalten. Die verwalteten Mail-Domänen
		müssen dabei nicht der DNS-Domäne des Servers entsprechen, sondern sind
		frei wählbar.
		Die auf einem Mailserver registrierten Mail-Domänen werden automatisch in
		der &ucsUCRV; <envar>mail/hosteddomains</envar> gespeichert.
	  </para>
	  <para>
		Damit auch externe Absender E-Mails an die Mitglieder der Domäne versenden
		können, müssen in der Konfiguration der autoritativen DNS-Nameserver MX-Records
		angelegt werden, die den UCS-Server als Mailserver für die Domäne
		ausweisen. Diese DNS-Anpassungen werden üblicherweise von Internet-Providern
		vorgenommen.
	  </para>
	  <para>
		Mail-Domänen werden im UMC-Modul <emphasis>E-Mail</emphasis>
		mit dem Objekttyp <guimenu>Mail-Domäne</guimenu> verwaltet.
	  </para>
	</section>

	<section id="mail::management::users">
	  <title>Zuordnung von E-Mail-Adressen zu Benutzern</title>
	  <para>
		Einem Benutzer können drei verschiedene Arten von E-Mail-Adressen zugeordnet werden:
	  </para>
	  <para>
		<itemizedlist>
		  <listitem>
			<simpara>
			  Die <emphasis>primäre E-Mail-Adresse</emphasis> wird zur Authentifizierung an Postfix
			  und Dovecot verwendet. Primäre E-Mail-Adressen müssen eindeutig sein. Pro Benutzer kann
			  nur eine primäre E-Mail-Adresse konfiguriert werden. Sie definiert auch das
			  IMAP-Postfach des Benutzers. Wenn dem Benutzer ein Mail Home Server zugeordnet ist
			  (siehe <xref linkend="mail::homeserver"/>), wird das IMAP-Postfach automatisch durch
			  ein Univention Directory Listener-Modul erstellt. Der
			  Domänenanteil der E-Mail-Adresse muss in &ucsUMC; registriert sein (siehe
			  <xref linkend="mail::management::domains"/>).
			</simpara>
		  </listitem>

		  <listitem>
			<simpara>
			  E-Mails an <emphasis>alternative E-Mail-Adressen</emphasis> werden
			  ebenfalls in das Postfach des Benutzers zugestellt. Es können beliebig
			  viele Adressen angegeben werden. Die alternativen E-Mail-Adressen müssen
			  nicht eindeutig sein; besitzen zwei Benutzer die gleiche Adresse, erhalten
			  beide Benutzer alle E-Mails, die an diese Adresse gesandt werden. Der
			  Domänenanteil der E-Mail-Adresse muss in &ucsUMC; registriert sein (siehe
			  <xref linkend="mail::management::domains"/>). Um E-Mails an
				alternative E-Mail-Adressen zu erhalten, muss ein Benutzer eine
				primäre E-Mail-Adresse besitzen.
			</simpara>
		  </listitem>

		  <listitem>
		    <simpara>
		      Wenn <emphasis>Weiterleitungs-E-Mail-Adressen</emphasis> für einen Benutzer
		      konfiguriert sind, werden E-Mails, die er über die primäre oder über alternative
		      E-Mail-Adressen empfängt, an diese weiter geleitet. Optional kann eine Kopie
		      der eingehenden Nachrichten in das Postfach des Benutzers zugestellt werden. Es können beliebig
		      viele Adressen angegeben werden. Weiterleitungs-E-Mail-Adressen müssen weder
		      eindeutig, noch muss ihr Domänenanteil in &ucsUMC; registriert sein.
		    </simpara>
		  </listitem>
		</itemizedlist>
	  </para>

	  <note>
	    <para>
		  E-Mail-Adressen können die Zeichen a-z, die Ziffern 0-9, Punkte,
		  Bindestriche und Unterstriche enthalten. Als weitere Vorgabe müssen die
		  E-Mail-Adressen mit einem Buchstaben beginnen und ein
		  <emphasis>@</emphasis>-Zeichen enthalten.
		  Um E-Mail-Adressen vergeben zu können, muss vorher mindestens eine Mail-Domäne
		  registriert werden (siehe <xref linkend="mail::management::domains"/>).
	    </para>
	  </note>

	  <para>
		E-Mail-Adressen werden im UMC-Modul <emphasis>Benutzer</emphasis> verwaltet.
		Die <guimenu>primäre E-Mail-Adresse</guimenu> wird im
		Reiter <guimenu>Allgemein</guimenu> im Untermenü <guimenu>Benutzer-Konto</guimenu>
		eingetragen.
		<guimenu>Alternative E-Mail-Adressen</guimenu> können
		unter <guimenu>Erweiterte Einstellungen &ar; Mail</guimenu> eingetragen werden.
	  </para>
	  <note>
		<para>
		Sobald das Benutzerkonto konfiguriert ist, kann eine Anmeldung am UCS-Mail-Stack (<systemitem class="service">IMAP</systemitem>/<systemitem class="service">POP3</systemitem>/<systemitem class="service">SMTP</systemitem>)
		erfolgen. Wurde das Benutzerkonto deaktiviert (oder das Passwort geändert), ist
		eine Anmeldung am Mail-Stack für eine Dauer von 5min weiterhin möglich. Der Grund hierfür
		ist der Authentifizierungscache des Mail-Stacks.
		Um den Cache zu invalidieren, führen Sie
		<programlisting language="sh">
doveadm auth cache flush
		</programlisting>
		auf dem Mailserver aus. Die Ablaufzeit des Caches kann auf dem Mailserver mit
		der &ucsUCRV; <envar>mail/dovecot/auth/cache_ttl</envar> sowie
		<envar>mail/dovecot/auth/cache_negative_ttl</envar> konfiguriert werden.
		</para>
	  </note>
	</section>

	<section id="mail::management::mailinglists">
	  <title>Verwaltung von Mailinglisten</title>
	  <para>
		Mailinglisten werden zum Austausch von E-Mails in geschlossenen Gruppen
		verwendet. Jede Mailingliste verfügt über eine eigene E-Mail-Adresse. Wird an
		diese Adresse eine E-Mail gesendet, empfangen sie alle Mitglieder der
		Mailingliste.
	  </para>

		<figure id="mail-mailinglist">
		  <title>Einrichtung einer Mailingliste</title>
		  <graphic scalefit="1" width="90%" align="center" fileref="illustrations44/mail_mailinglist_de.png"/>
		</figure>

	  <para>
		Mail-Domänen werden im UMC-Modul <emphasis>E-Mail</emphasis>
		mit dem Objekttyp <guimenu>Mailingliste</guimenu> verwaltet.
		Unter <guimenu>Name</guimenu> ist ein frei wählbarer Name der Mailingliste
		anzugeben, die Angabe einer <guimenu>Beschreibung</guimenu> ist optional.
		Als <guimenu>Mail-Adresse</guimenu> ist die E-Mail-Adresse der Mailingliste
		einzugeben. Der Domänenteil der Adresse muss dabei einer der verwalteten
		Mail-Domänen entsprechen.
		Unter <guimenu>Mitglieder</guimenu> können beliebig viele Adressen aufgenommen
		werden, im Gegensatz zu Mailgruppen (siehe
		<xref linkend="mail::management::mailgroups"/>) können hier auch externe
		E-Mail-Adressen aufgenommen werden.
		Nach dem Anlegen einer Mailingliste ist diese umgehend verfügbar.
	  </para>

	  <para>
		In der Grundeinstellung kann jeder an die Mailingliste schreiben. Um
		Missbrauch zu verhindern, besteht die Möglichkeit den Senderkreis
		einzuschränken. Dazu muss die &ucsUCRV; <envar>mail/postfix/policy/listfilter</envar> auf
		dem Mailserver auf <literal>yes</literal> gesetzt und Postfix neu gestartet werden.
		Unter <guimenu>Erweiterte Einstellungen</guimenu> können
		dann <guimenu>Benutzer, die berechtigt sind, E-Mails an diese Liste zu versenden</guimenu>
		und <guimenu>Gruppen, die berechtigt sind, E-Mails an diese Liste zu versenden</guimenu>
		festgelegt werden. Ist hier ein Feld gesetzt, ist das Senden nur den berechtigten
		Nutzern/Gruppen erlaubt.
	  </para>
	</section>

	<section id="mail::management::mailgroups">
	  <title>Verwaltung von Mailgruppen</title>
	  <para>
		Es besteht die Möglichkeit eine Mailgruppe zu bilden: Dabei wird einer Benutzer-Gruppe
		eine E-Mail-Adresse zugewiesen. E-Mails an diese Adresse werden dann allen
		Gruppenmitgliedern an ihre primäre E-Mail-Adresse zugestellt.
	  </para>

	  <para>
		  Mailgruppen werden im UMC-Modul <emphasis>Gruppen</emphasis> verwaltet
		  (siehe auch <xref linkend="groups"/>).
	  </para>

	  <para>
		Die E-Mail-Adresse der Mailgruppe wird im Eingabefeld <guimenu>Mail-Adresse</guimenu>
		unter <guimenu>Erweiterte Einstellungen</guimenu> festgelegt. Der Domänenteil der
		Adresse muss einer der verwalteten Mail-Domänen entsprechen.
	  </para>

	  <para>
		In der Grundeinstellung kann jeder an die Mailgruppe schreiben. Um
		Missbrauch zu verhindern, besteht die Möglichkeit den Senderkreis
		einzuschränken. Dazu muss die &ucsUCRV; <envar>mail/postfix/policy/listfilter</envar> auf
		dem Mailserver auf <literal>yes</literal> gesetzt und Postfix neu gestartet werden.
	  </para>

	  <para>
		Unter <guimenu>Erweiterte Einstellungen</guimenu>
		können <guimenu>Benutzer, die berechtigt sind, E-Mails an diese Gruppe zu versenden</guimenu>
		und <guimenu>Gruppen, die berechtigt sind, E-Mails an diese Gruppe zu versenden</guimenu>
		festgelegt werden. Ist hier ein Feld gesetzt, ist das Senden nur den berechtigten
		Nutzern/Gruppen erlaubt.
	  </para>
	</section>

	<section id="mail::management::sharedfolder">
	  <title>Verwaltung von globalen IMAP-Ordnern</title>
	  <para>
		Ein gemeinsamer Zugriff auf E-Mails ist in vielen Arbeitsgruppen die
		Grundlage der Zusammenarbeit. Mit UCS können Benutzer sehr
		einfach Ordner in Ihren eigenen Postfächern anlegen und Berechtigungen
		vergeben, so dass es weiteren Benutzern gestattet ist, E-Mails in diesen
		Ordnern zu lesen oder weitere E-Mails in diesen Ordnern abzulegen.
	  </para>
	  <para>
		Alternativ können eigene IMAP-Ordner für Benutzer oder
		Benutzergruppen freigegeben werden. Ein solcher Ordner wird als globaler
		IMAP-Ordner bezeichnet.
		Globale IMAP-Ordner werden im UMC-Modul <emphasis>Mail</emphasis>
		mit dem Objekttyp <guimenu>Mail-Ordner (IMAP)</guimenu> verwaltet.
	  </para>
		<para>
			Globale IMAP-Ordner können nicht umbenannt werden. Die &ucsUCRV;
			<envar>mail/dovecot/mailbox/rename</envar> kommt daher nicht zur Anwendung. Nur wenn
			<envar>mail/dovecot/mailbox/delete</envar> auf <literal>yes</literal> gesetzt ist (Standard ist <literal>no</literal>),
			wird ein globaler IMAP-Ordner beim Löschen im UMC-Modul
			<emphasis>Mail</emphasis> auch tatsächlich von der Festplatte gelöscht.
		</para>

		<figure id="mail-sharedfolder">
		  <title>Einrichtung eines globalen IMAP-Ordners</title>
		  <graphic scalefit="1" width="100%" fileref="illustrations44/mail_imapfolder_de.png"/>
		</figure>

		<table>
		  <title>Reiter 'Allgemein'</title>
		  <tgroup cols="2">
			<colspec colnum="1" colname="col1" colwidth="1*"/>
			<colspec colnum="2" colname="col2" colwidth="2*"/>
			<thead>
			  <row>
				<entry>Attribut</entry>
				<entry>Beschreibung</entry>
			  </row>
			</thead>
			<tbody>

			  <row>
				<entry>Name (*)</entry>
				<entry>Der Name, unter dem der IMAP-Ordner im E-Mail-Client
					verfügbar ist. Der Name unterscheidet sich je nach dem,
					ob eine E-Mail-Adresse konfiguriert wird (siehe Zeile
					"Mail-Adresse" unten) oder nicht. Wird keine Mail-Adresse
					konfiguriert, erscheint der IMAP-Ordner im Client als
					<literal>name@domain/INBOX</literal>. Wird eine Mail-Adresse
					verwendet, wird der Name die Form
					<literal>shared/name@domain</literal> haben.
				</entry>
			  </row>

			  <row>
				<entry>Mail-Domäne (*)</entry>
				<entry>Jeder globale IMAP-Ordner ist einer Mail-Domäne zugeordnet. Die Verwaltung der
				Domänen ist in <xref linkend="mail::management::domains"/> dokumentiert.</entry>
			  </row>

			  <row>
				<entry>Mail Home Server (*)</entry>
				<entry>
				  Ein IMAP-Ordner ist einem Mail Home Server zugeordnet. Weitere
				  Hinweise finden sich in <xref linkend="mail::homeserver"/>.
				</entry>
			  </row>

			  <row>
				<entry>Maximale Quota in MB</entry>
				<entry>
				  Mit dieser Einstellung kann die maximale Gesamtgröße aller E-Mails
				  in diesem Ordner festgelegt werden.
				</entry>
			  </row>

			  <row>
				<entry>Mail-Adresse</entry>
				<entry>
				  <para>
					Hier kann eine E-Mail-Adresse angegeben werden, durch die E-Mails direkt an
					den IMAP-Ordner gesendet werden können. Ist hier keine Adresse gesetzt, so
					kann nur aus E-Mail-Clients heraus in den Ordner geschrieben werden.
				  </para>
				  <para>
					Der Domänenanteil der E-Mail-Adresse muss in &ucsUMC; registriert sein (siehe
					<xref linkend="mail::management::domains"/>).
				  </para>
				</entry>
			  </row>
			</tbody>
		  </tgroup>
		</table>

		<table>
		  <title>Reiter 'Zugriffsrechte'</title>
		  <tgroup cols="2">
			<colspec colnum="1" colname="col1" colwidth="1*"/>
			<colspec colnum="2" colname="col2" colwidth="2*"/>
			<thead>
			  <row>
				<entry>Attribut</entry>
				<entry>Beschreibung</entry>
			  </row>
			</thead>
			<tbody>

			  <row>
				<entry>Name (*)</entry>
				<entry>
				  <para>
					Hier können Zugriffsberechtigungen auf Basis von Benutzern oder Gruppen
					vergeben werden. Benutzer werden mit Ihrem Benutzernamen
					eingetragen, als Gruppen werden die in &ucsUMC; angelegten Gruppen
					verwendet.
				  </para>
				  <para>
					Die Zugriffsrechte haben folgende Auswirkungen für einzelne Benutzer oder
					Mitglieder der angegebenen Gruppe:
				  </para>
				  <variablelist>
					  <varlistentry>
						  <term>Keine</term>
						  <listitem>
							  <simpara>
								  Es ist kein Zugriff möglich. Der Ordner wird nicht in der Ordnerliste angezeigt.
							  </simpara>
						  </listitem>
					  </varlistentry>
					  <varlistentry>
						  <term>lesen</term>
						  <listitem>
							  <simpara>Es darf nur lesend auf bestehende Einträge zugegriffen werden.</simpara>
						  </listitem>
					  </varlistentry>
					  <varlistentry>
						  <term>anhängen</term>
						  <listitem>
							  <simpara>
								  Bestehende Einträge dürfen nicht verändert werden, nur neue Einträge erzeugt
								  werden.
							  </simpara>
						  </listitem>
					  </varlistentry>
					  <varlistentry>
						  <term>schreiben</term>
						  <listitem>
							  <simpara>
								  Neue Einträge in diesem Ordner anlegen, bestehende verändern oder bestehende
								  löschen ist erlaubt.
							  </simpara>
						  </listitem>
					  </varlistentry>
					  <varlistentry>
						  <term>senden</term>
						  <listitem>
							  <simpara>
								  Eine E-Mail an diesen Ordner als Empfänger senden ist zugelassen. Dies wird
								  nicht von jedem Client unterstützt.
							  </simpara>
						  </listitem>
					  </varlistentry>
					  <varlistentry>
						  <term>alles</term>
						  <listitem>
							  <simpara>
								  Umfasst alle Berechtigungen von 'schreiben' und erlaubt zusätzlich das Ändern
								  von Zugriffsrechten.
							  </simpara>
						  </listitem>
					  </varlistentry>
				  </variablelist>
				</entry>
			  </row>
			</tbody>
		  </tgroup>
		</table>
	</section>

	<section id="mail:Mail-Quota">
	  <title>Mail-Quota</title>
	  <para>
		Die Größe der Benutzerpostfächer kann über Mail-Quotas eingeschränkt
		werden, bei deren Erreichen vom Mailserver keine weiteren E-Mails für
		das Postfach angenommen werden, bis der Benutzer alte Mails aus seinem
		Konto entfernt hat.
	  </para>

	  <para>
		Die Grenze wird in Megabytes im Feld <guimenu>Mail-Quota</guimenu> festgelegt, die
		unter <guimenu>Erweiterte Einstellungen &ar; Mail</guimenu> verwaltet
		wird. Der Standardwert ist <literal>0</literal> und bedeutet, dass keine Beschränkung aktiv ist.
		Für das Zuweisen einer Quota an mehrere Benutzer auf einmal, kann der
		Mehrfachbearbeitungsmodus von &ucsUMC; verwendet  werden, siehe
		<xref linkend="central:user-interface:edit"/>.
	  </para>

	  <para>
		Der Benutzer kann ab einer bestimmten erreichten Postfachgröße gewarnt werden
		und erhält dann eine Mail mit dem Hinweis, dass seine
		Speicherressourcen nahezu ausgelastet sind.
		Der Administrator kann den Schwellwert in Prozent, den Betreff der
		Nachricht und ihren Inhalt angeben:
		<itemizedlist>
		  <listitem>
			<para>
			  In der &ucsUCRV; <envar>mail/dovecot/quota/warning/text/PROZENT=TEXT</envar> kann
			  der Schwellwert konfiguriert werden, ab dem eine Warnmeldung ausgegeben werden
			  soll. <literal>PROZENT</literal> muss als Zahl zwischen 0 und 100 ohne Prozentzeichen angegeben
			  werden, TEXT wird der Inhalt der E-Mail.
			</para>
			<para>
			  Wenn <literal>TEXT</literal> die Zeichenkette <literal>$PERCENT</literal> enthält, wird diese in der
			  E-Mail mit dem überschrittenen Wert ersetzt.
			</para>
			<para>
			  Der Wert der &ucsUCRV; <envar>mail/dovecot/quota/warning/subject</envar>
			  wird als Betreff der E-Mails verwendet.
			</para>
		  </listitem>
			<listitem>
				<para>
					Bei der Installation des Mail-Server-Paketes werden Betreff und
zwei Warn-Nachrichten automatisch konfiguriert:
					<itemizedlist>
						<listitem>
							<para>
								<envar>mail/dovecot/quota/warning/subject</envar> wird gesetzt auf <literal>Quota-Warning</literal>
							</para>
						</listitem>
						<listitem>
							<para>
								<envar>mail/dovecot/quota/warning/text/80</envar> wird gesetzt auf <literal>Your mailbox has filled up to over $PERCENT%.</literal>
							</para>
						</listitem>
						<listitem>
							<para>
								<envar>mail/dovecot/quota/warning/text/95</envar> wird gesetzt auf <literal>Attention: Your mailbox has already filled up to over $PERCENT%. Please delete some messages or contact the administrator.</literal>
							</para>
						</listitem>
					</itemizedlist>
				</para>
			</listitem>
		</itemizedlist>
	  </para>
	</section>
  </section>

  <section id="mail::spam">
	<title>Spamerkennung und -filterung</title>
	<para>
	  Unerwünschte und nicht angeforderte E-Mails werden als Spam bezeichnet. Zur
	  automatisierten Erkennung solcher E-Mails integriert UCS die Software
	  SpamAssassin und Postgrey. SpamAssassin versucht anhand von Heuristiken über Herkunft, Form
	  und Inhalt einer E-Mail zu erkennen, ob sie erwünscht ist oder nicht.
	  Postgrey ist ein Policy Server für Postfix der "Greylisting" implementiert.
	  Greylisting ist eine Spam-Erkennungsmethode die E-Mail beim ersten Zustellversuch eines
	  externen Servers ablehnt. Mailserver von Spamversendern unternehmen häufig keinen zweiten
	  Zustellversuch, während legitime Server dies tun.
	  Die Integration erfolgt über die Pakete <package>univention-spamassassin</package> und
	  <package>univention-postgrey</package>, die bei der Einrichtung des Mailserver-Pakets
	  automatisch eingerichtet werden.
	</para>

	<para>
	  SpamAssassin arbeitet mit einem Punktesystem, das mit steigender Punktzahl eine
	  höhere Wahrscheinlichkeit für Spam ausdrückt. Punkte werden nach verschiedenen
	  Kriterien vergeben, die beispielsweise auf Schlagworte innerhalb der E-Mail
	  oder fehlerhafte Codierungen ansprechen.
	  In der Grundeinstellung werden nur Mails bis zu einer Größe von 300 Kilobyte
	  geprüft. Dies kann mit der &ucsUCRV; <envar>mail/antispam/bodysizelimit</envar>
	  konfiguriert werden.
	  E-Mails, die als Spam klassifiziert wurden - also eine bestimmte Anzahl
	  Punkte überschreiten - werden bei der Auslieferung durch Dovecot nicht im
	  Posteingang des Empfängers, sondern im darunter liegenden Ordner
	  <emphasis>Spam</emphasis> abgelegt. Der Name des Ordners kann mit der
	  &ucsUCRV; <envar>mail/dovecot/folder/spam</envar> konfiguriert werden.
	  Die Filterung erfolgt durch ein Sieve-Skript, das beim Anlegen des
	  IMAP-Postfachs eines Benutzers automatisch generiert wird.
	</para>

	<para>
	  Der in die Sieve-Skripte eingetragene Schwellwert, ab der E-Mails als Spam
	  deklariert werden, ist mit der &ucsUCRV;
	  <envar>mail/antispam/requiredhits</envar> konfigurierbar. Die Voreinstellung
	  (<literal>5</literal>) muss in der Regel nicht angepasst werden. Je nach Erfahrung im eigenen
	  Umfeld kann dieser Wert aber auch niedriger angesetzt werden. Es muss dann
	  jedoch mit mehr E-Mails gerechnet werden, die fälschlich als Spam erkannt
	  wurden. Die Änderung des Schwellwerts wirkt sich nicht auf bestehende Benutzer
	  aus, diese können den Wert aber im Horde-Webclient selbst anpassen (siehe
	  <xref linkend="mail::horde::filter"/>).
	</para>

	<para>
	  Zusätzlich gibt es die Möglichkeit, E-Mails mit einem Bayes-Klassifikator
	  bewerten zu lassen. Dieser vergleicht eine eingehende E-Mail mit statistischen
	  Daten, die er aus bereits verarbeiteten E-Mails gewonnen hat und kann so seine
	  Bewertung an die Mailgewohnheiten anpassen. Die Bayes-Klassifizierung wird vom
	  Benutzer selbst gesteuert, in dem nicht vom System aber vom Benutzer als Spam erkannte E-Mails in den
	  Unterordner <emphasis>Spam</emphasis> verschoben und eine Auswahl legitimer Mails in den
	  Unterordner <emphasis>Ham</emphasis> (<envar>mail/dovecot/folder/ham</envar>) kopiert werden. Diese Ordner werden täglich
	  ausgewertet und noch nicht erfasste oder bisher falsch klassifizierte Daten in
	  einer gemeinsamen Datenbank erfasst. Diese Auswertung ist in der
	  Grundeinstellung aktiviert und kann mit der &ucsUCRV;
	  <envar>mail/antispam/learndaily</envar> konfiguriert werden.
	</para>

	<para>
	  Die Spam-Filterung kann durch Setzen der &ucsUCRV;
	  <envar>mail/antivir/spam</envar> auf <literal>no</literal> deaktiviert
	  werden.
	  Bei Änderungen an Univention Configuration Registry-Variablen, die die
	  Spamerkennung betreffen, muss der AMaViS-Dienst und Postfix neu gestartet
	  werden.
	</para>
  </section>

  <section id="mail::viren">
	<title>Viren- und Malwareerkennung</title>
	<para>
	  Die UCS-Maildienste integrieren eine Viren- und Malwareerkennung über das Paket
	  <package>univention-antivir-mail</package>, das bei der Einrichtung des
	  Mailserver-Pakets automatisch eingerichtet wird. Der Virenscan kann mit der
	  &ucsUCRV; <envar>mail/antivir</envar> deaktiviert werden.
	</para>

	<para>
	  Alle ein- und ausgehenden E-Mails werden auf Viren geprüft. Wird ein Virus
	  erkannt, wird die E-Mail unter Quarantäne gestellt, d.h. auf dem Server
	  unerreichbar für den Benutzer abgelegt. Der ursprüngliche Empfänger erhält eine
	  Benachrichtigung per E-Mail über diese Maßnahme. Bei Bedarf kann der
	  Administrator die E-Mail aus dem Verzeichnis
	  <filename class="directory">/var/lib/amavis/virusmails/</filename> wiederherstellen oder
	  löschen. Eine automatische Löschung erfolgt nicht.
	</para>

	<para>
	  Die Software <application>AMaViSd-new</application> dient als Schnittstelle zwischen dem Mailserver und
	  verschiedenen Virenscannern. Der freie Virenscanner ClamAV ist im Paket
	  enthalten und nach der Installation sofort einsatzbereit. Die für die
	  Virenerkennung nötigen Signaturen werden automatisch und kostenfrei durch den
	  Freshclam-Dienst bezogen und aktualisiert.
	</para>

	<para>
	  Alternativ oder zusätzlich können andere Virenscanner in AMaViS eingebunden
	  werden.
	  Nach Änderungen an der AMaViS- oder ClamAV-Konfiguration müssen Postfix und
	  AMaViS neu gestartet werden.
	</para>
  </section>

	<section id="mail::dnsbl">
		<title>Identifikation von Spam Quellen mit <foreignphrase>DNS basierten Blackhole List</foreignphrase> (DNSBL)</title>
		<para>
			Eine weitere Möglichkeit gegen Spam vorzugehen ist die Verwendung von <foreignphrase>DNS-based Blackhole List</foreignphrase> (<acronym>DNSBL</acronym>) bzw. <foreignphrase>Real-time Blackhole List</foreignphrase> (<acronym>RBL</acronym>).
			DNSBL sind Listen von IP Adressen, von denen der Betreiber denkt, dass sie (potentiell) Quellen von Spam sind.
			Die Listen werden per DNS abgefragt.
			Ist dem DNS-Server die IP des sendenden E-Mail-Servers bekannt, so wird die Nachricht abgelehnt.
			Der Check einer IP-Adresse ist schnell und vergleichsweise ressourcenschonend.
			Er findet <emphasis>vor</emphasis> dem Annehmen der Nachricht statt.
			Erst nach dem Empfang findet die aufwändige Inhaltsüberprüfung mit SpamAssassin und Anti-Virus statt.
			Postfix hat eine eingebaute Unterstützung für DNSBL (<ulink url="http://www.postfix.org/postconf.5.html#reject_rbl_client"/>).
		</para>
		<para>
			Im Internet existieren DNSBL von verschiedenen Projekten und Firmen.
			Bitte informieren Sie sich auf deren Webseiten über Konditionen und Preise.
		</para>
		<para>
			Um DNSBL mit Postfix zu verwenden muss die &ucsUCRV; <envar>mail/postfix/smtpd/restrictions/recipient/<replaceable>SEQUENZ</replaceable>=<replaceable>REGEL</replaceable></envar> gesetzt werden.
			Mit ihr können Empfangsbeschränkungen über die Postfix-Option <property>smtpd_recipient_restrictions</property> konfiguriert werden (siehe <ulink url="http://www.postfix.org/postconf.5.html#smtpd_recipient_restrictions"/>).
			Die Sequenznummer dient der alphanumerisch Sortierung mehrerer Regeln, über die die Reihenfolge beeinflusst werden kann.
		</para>
		<tip>
			<para>
				Existierende <property>smtpd_recipient_restrictions</property> Regeln können wie folgt aufgelistet werden:
				<programlisting language="sh">ucr search --brief mail/postfix/smtpd/restrictions/recipient</programlisting>
			</para>
		</tip>
		<para>
			In einer unveränderten &ucsUCS; Postfix Installation sollten die DNSBL am Ende der <property>smtpd_recipient_restrictions</property> Regeln angehängt werden.
			Zum Beispiel so:
			<programlisting language="sh">ucr set mail/postfix/smtpd/restrictions/recipient/80="reject_rbl_client ix.dnsbl.manitu.net"</programlisting>
		</para>
	</section>

  <section id="mail::fetchmail">
	<title>Integration von Fetchmail zum Abrufen von Mail von externen Postfächern</title>
	  <para>
		Im Regelfall nimmt der UCS-Maildienst Mails für die Benutzer des UCS-Domäne direkt über SMTP
		entgegen. UCS bietet zusätzlich eine optionale Integration der Software Fetchmail zum Abrufen von Emails von
		externen POP3 oder IMAP-Postfächern.
	  </para>
	  <para>
		Fetchmail kann über das Univention App Center installiert werden; dort muss die Applikation
		<guimenu>Fetchmail</guimenu> ausgewählt werden und auf <guimenu>Installieren</guimenu>
		geklickt werden.
	  </para>
	  <para>
		Nach Abschluss der Installation finden sich in der Benutzerverwaltung im Reiter
		<guimenu>Erweiterte Einstellungen &ar; Mailabruf von externen Servern</guimenu> zusätzliche
		Eingabefelder, mit denen der Mailabruf von einem externen Server konfiguriert werden
		kann. Die Mails werden dabei in die Postfächer der jeweiligen Benutzer eingeliefert (die
		primäre E-Mail-Adresse muss dafür konfiguriert sein).
	  </para>
	  <para>
		Der Abruf erfolgt alle zwanzig Minuten sobald mindestens ein Postfach für den Abruf
		konfiguriert wurde. Nach der initialen Konfiguration eines Benutzers muss Fetchmail im
		UMC-Modul <guimenu>Systemdienste</guimenu> gestartet werden. Dort kann der Start
		des Dienstes auch deaktiviert werden (alternativ durch Setzen der &ucsUCRV;
		<envar>fetchmail/autostart</envar> auf <literal>false</literal>).
	  </para>

		<table>
		  <title>Reiter 'Mailabruf von externen Servern'</title>
		  <tgroup cols="2">
			<colspec colnum="1" colname="col1" colwidth="1*"/>
			<colspec colnum="2" colname="col2" colwidth="2*"/>
			<thead>
			  <row>
				<entry>Attribut</entry>
				<entry>Beschreibung</entry>
			  </row>
			</thead>
			<tbody>

			  <row>
				<entry>Benutzername</entry>
				<entry>Der Benutzername, der für den Abruf der Mail an den Mailserver übergeben
				werden soll.</entry>
			  </row>

			  <row>
				<entry>Passwort</entry>
				<entry>Das Passwort, das für den Mailabruf verwendet werden soll.</entry>
			  </row>

			  <row>
				<entry>Protokoll</entry>
				<entry>Der Abruf kann über die Protokolle IMAP oder POP3 erfolgen.</entry>
			  </row>

			  <row>
				<entry>Externer Mailserver</entry>
				<entry>Der Name des Mailservers, von dem die Mails abgerufen werden sollen.</entry>
			  </row>

			  <row>
				<entry>Verbindung verschlüsseln (SSL/TLS)</entry>
				<entry>Ist diese Option aktiviert, erfolgt der Mailabruf verschlüsselt (sofern dies
				vom Mailserver unterstützt wird).</entry>
			  </row>

			  <row>
				<entry>Mails auf dem Server nicht löschen</entry>
				<entry>In der Grundeinstellungen werden die abgerufenen Mails nach dem Transfer auf
				dem Server gelöscht. Ist diese Option aktiviert, kann dies unterbunden werden.</entry>
			  </row>

			</tbody>
		  </tgroup>
		</table>
  </section>


  <section id="mail::serverconfig::general">
	<title>Konfiguration des Mailservers</title>

	<section id="mail::serverconfig::relay">
	  <title>Konfiguration eines Relay-Hosts für den Mailversand</title>

	  <para>
		In der Grundeinstellung baut Postfix beim Versenden einer E-Mail an eine
		nicht-lokale Adresse eine direkte SMTP-Verbindung an den für diese Domain
		zuständigen Mailserver auf. Dieser Server wird durch eine Abfrage des
		MX-Records im DNS ermittelt.
	  </para>

	  <para>
		Alternativ kann auch ein Mail-Relay-Server zu Einsatz kommen, also ein Server
		der die Mails entgegen nimmt und den weiteren Versand abwickelt. Ein solcher
		Mail-Relay-Server kann beispielsweise von einer übergeordneten Konzernzentrale
		oder vom Internet-Provider bereitgestellt werden. Ein Relay-Server muss als
		vollqualifizierter Domänenname (FQDN) in die &ucsUCRV;
		<envar>mail/relayhost</envar> eingetragen werden.
	  </para>

	  <para>
		Ist für den Versand die Authentifizierung gegenüber dem Relay-Host notwendig,
		muss die &ucsUCRV; <envar>mail/relayauth</envar> auf <literal>yes</literal>
		gesetzt und die Datei <filename>/etc/postfix/smtp_auth</filename> bearbeitet
		werden. In dieser Datei muss der Relay-Host, der Benutzername und das Passwort
		in einer Zeile hinterlegt werden:
	  </para>
		<programlisting>
<replaceable>FQDN-Relayhost</replaceable>	<replaceable>Benutzername</replaceable>:<replaceable>Passwort</replaceable>
		</programlisting>
		<para>
		Anschließend muss für diese Datei
		</para>
		<programlisting language="sh">
postmap /etc/postfix/smtp_auth
		</programlisting>

	  <para>
		aufgerufen werden, damit die Änderungen durch Postfix übernommen
		werden.
	  </para>
	  <note>
		  <para>
			  Um eine verschlüsselte Verbindung bei der Verwendung eines Relay-Hosts sicherzustellen,
			  muss die Postfix-Option <literal>smtp_tls_security_level=encrypt</literal> gesetzt sein.
			  &ucsUCS; setzt diese Option automatisch, wenn <envar>mail/relayhost</envar> gesetzt und
			  <envar>mail/relayauth</envar> auf <literal>yes</literal> gesetzt ist und
			  <envar>mail/postfix/tls/client/level</envar> nicht auf <literal>none</literal> stehen.
		  </para>
	  </note>
	</section>

	<section id="mail::serverconfig::mailsize">
	  <title>Konfiguration der maximalen E-Mailgröße</title>

	  <para>
		Mit der &ucsUCRV; <envar>mail/messagesizelimit</envar> kann die maximale Größe
		in Byte für ein- und ausgehende E-Mails festgelegt werden. Die voreingestellte
		Maximalgröße beträgt 10240000 Byte. Nach Änderung der Einstellung muss Postfix neu gestartet werden.
		Wird <literal>0</literal> als Wert konfiguriert, so wird die Begrenzung aufgehoben. Es ist
		zu beachten, dass Emailanhänge durch die Base64-Kodierung um ca. ein Drittel vergrössert
		werden.
	  </para>

	  <para>
		Wird Horde (siehe <xref linkend="mail::horde"/>) eingesetzt, müssen außerdem die
		&ucsUCR;-Variablen <envar>php/limit/filesize</envar> und <envar>php/limit/postsize</envar>
		angepasst werden. Als Wert muss in beide Variablen die maximale Größe in Megabyte
		eingetragen werden. Anschließend muss der Apache-Webserver neu gestartet werden.
	  </para>
	</section>

	<section id="mail::serverconfig::archivefolder">
	  <title>Konfiguration einer Blindkopie zur Anbindung von E-Mail-Archivierungslösungen</title>

	  <para>
		Wird die &ucsUCRV; <envar>mail/archivefolder</envar> auf eine E-Mail-Adresse
		gesetzt, sendet Postfix eine Blindkopie aller ein- und ausgehenden E-Mails an
		diese Adresse. So kann eine Archivierung aller E-Mails erreicht
		werden. Die E-Mail-Adresse muss bereits existieren. Sie kann entweder
		eine in &ucsUCS; registrierte E-Mail-Adresse eines Benutzers sein,
		oder von einem externen Dienst bereitgestellt werden. Standardmäßig
		ist die Variable nicht gesetzt.
	  </para>

	  <para>
		Anschließend muss Postfix neu gestartet werden.
	  </para>
	</section>

	<section id="mail::serverconfig::softbounce">
	  <title>Konfiguration von Softbounces</title>

	  <para>
		Bei einer Reihe von Fehlersituationen (z.B. bei nicht vorhandenen
		Benutzern) kann es zu einem Bounce der betroffenen Mail kommen, d.h. die Mail
		wird an den Absender zurückgesendet. Mit dem Setzen der &ucsUCRV;
		<envar>mail/postfix/softbounce</envar> auf <literal>yes</literal> werden
		Mails nie mit einem Bounce zurückgesendet, sondern immer weiterhin in der Queue
		vorgehalten. Diese Einstellung ist insbesondere für Konfigurationsarbeiten am
		Mailserver sehr nützlich.
	  </para>
	</section>

	<section id="mail::serverconfig::smtpports">
		<title>Konfiguration der SMTP Ports</title>
		<para>
			Auf einem &ucsUCS;-Mailserver ist Postfix so konfiguriert, dass es auf
			Verbindungen an drei Ports wartet:
		</para>
		<itemizedlist>
			<listitem>
				<para>
					Port 25 (<systemitem class="service">SMTP</systemitem>) sollte nur von
					anderen Mailservern verwendet werden. Standardmäßig ist die
					Authentifikation an diesem Port deaktiviert. Wenn das Einliefern von
					E-Mails an Port 25 erlaubt werden soll, kann die &ucsUCRV;
					<envar>mail/postfix/mastercf/options/smtp/smtpd_sasl_auth_enable=yes</envar>
					gesetzt werden.
				</para>
			</listitem>
			<listitem>
				<para>
					Port 465 (<systemitem class="service">SMTPS</systemitem>) erlaubt die
					Authentifikation gegenüber dem Mailserver und das Einliefern von E-Mails über eine mit SSL verschlüsselte
					Verbindung. <systemitem class="service">SMTPS</systemitem> wurde zugunsten
					von Port 587 als veraltet erklärt, wird jedoch für Altsysteme aktiviert gelassen.
				</para>
			</listitem>
			<listitem>
				<para>
					Port 587 (<systemitem class="service">Submission</systemitem>) erlaubt
					die Authentifikation gegenüber dem Mailserver und das Einliefern von E-Mails über eine TLS-verschlüsselte
					Verbindung. Die Verwendung von STARTTLS wird erzwungen.
				</para>
			</listitem>
		</itemizedlist>
		<para>
			Der <systemitem class="service">Submission</systemitem>-Port sollte von
			E-Mail-Clients bevorzugt verwendet werden. Die Verwendung der Ports 25
			und 465 zur Einlieferung von E-Mails ist überholt.
		</para>
	</section>

	<section id="mail::serverconfig::postscreen">
		<title>Konfiguration zusätzlicher Prüfungen durch <application>postscreen</application></title>
		<para>
			Bei der Verwendung eines Mailservers, der direkt vom Internet aus erreichbar ist, besteht immer die Gefahr,
			dass Versender von Spam oder defekte Mailserver kontinuierlich versuchen, auf dem UCS-System ungewollte
			Mails (z.B. Spam) abzuliefern.
		</para>
		<para>
			Um die Last des Mailservers für solche Fälle zu reduzieren, bringt Postfix einen eigenen Dienst mit dem Namen
			<application>postscreen</application> mit, der Postfix vorgeschaltet wird und die eingehenden
			SMTP-Verbindungen annimmt. Mit diesen Verbindungen werden zunächst einige leichtgewichtige Tests
			durchgeführt. Ist das Ergebnis positiv, wird die Verbindung an Postfix durchgereicht. Im negativen Fall
			wird die SMTP-Verbindung beendet und somit die eingehende Mail abgelehnt, bevor sie im Verantwortungsbereich
			des UCS Mailservers angekommen ist.
		</para>
		<para>
			In der Standardeinstellung ist <application>postscreen</application> nicht aktiv. Durch das Setzen der &ucsUCRV;
			<envar>mail/postfix/postscreen/enabled</envar> auf den Wert <literal>yes</literal> kann <application>postscreen</application>
			aktiviert werden.
		</para>
		<para>
			Über diverse UCR-Variablen mit dem Präfix <envar>mail/postfix/postscreen/</envar> können weitere
			Einstellungen vorgenommen werden. Eine Liste der UCR-Variablen nebst Beschreibungen können z.B. auf
			der Kommandozeile über den Befehl <command>ucr search --verbose mail/postfix/postscreen/</command>
			abgerufen werden.
		</para>
		<note>
			<para>
				Nach jeder Änderung einer UCR-Variable für <application>postscreen</application> sollte die Konfiguration von Postfix und
				<application>postscreen</application> neu geladen werden, was über den Befehl <command>service postfix reload</command>
				ausgelöst werden kann.
			</para>
		</note>
	</section>

	<section id="mail::serverconfig::maincflocal">
		<title>Eigene Anpassung der Postfix Konfiguration</title>
		<para>
			Die Konfiguration von Postfix, welche sich in der Datei <filename>/etc/postfix/main.cf</filename> befindet, wird über &ucsUCR;-Variablen definiert.
			Eine Erweiterung der Konfiguration, die über die vorhandenen &ucsUCR;-Variablen hinaus geht, ist ebenso möglich.
		</para>
		<para>
			Existiert die Datei <filename>/etc/postfix/main.cf.local</filename>, so wird ihr Inhalt an die Datei <filename>main.cf</filename> angehängt. Damit Änderungen an <filename>main.cf.local</filename> nach <filename>main.cf</filename> übernommen werden, muss der folgende Befehl ausgeführt werden:
			<programlisting language="sh">
ucr commit /etc/postfix/main.cf
			</programlisting>
			Zum Übernehmen der Änderungen durch den Postfix Dienst muss dieser neu geladen werden:
			<programlisting language="sh">
service postfix reload
			</programlisting>
		</para>
		<para>
			Wird in der Datei <filename>main.cf.local</filename> eine Postfix Variable gesetzt, die zuvor auch in <filename>main.cf</filename> gesetzt wurde, so schreibt Postfix eine Warnung in die Logdatei <filename>/var/log/mail.log</filename>.
		</para>
		<note>
			<para>
				Wenn das Verhalten des E-Mail-Servers nicht der Erwartung entspricht, sollten zuerst die Einstellungen, die durch <filename>main.cf.local</filename> aktiviert wurden, rückgängig gemacht werden.
				Dazu muss die Datei umbenannt oder ihr Inhalt auskommentiert werden.
				Im Anschluss müssen die beiden oben genannten Kommandos ausgeführt werden.
				Die Konfiguration entspricht dann wieder der Standardkonfiguration von UCS.
			</para>
		</note>
	</section>

	<section id="mail::renamedusers">
	  <title>Handhabung der Postfächer bei Änderung der E-Mail-Adresse und
	  Löschung von Benutzerkonten</title>

	  <para>
		Das Postfach eines Benutzers ist mit der primären E-Mail-Adresse verknüpft und
		nicht mit dem Benutzernamen. Mit der &ucsUCRV;
		<envar>mail/dovecot/mailbox/rename</envar> kann das Verhalten bei der Änderung
		der primären E-Mail-Adresse konfiguriert werden.
	  </para>

		<itemizedlist>
		  <listitem>
			<simpara>
			  Ist die Variable auf <literal>yes</literal> gesetzt, wird das
			  IMAP-Postfach des Benutzers umbenannt. Dies ist seit UCS 3.0 die
			  Standardeinstellung.
			</simpara>
		  </listitem>
		  <listitem>
			<simpara>
			  Bei der Einstellung <literal>no</literal>, sind nach dem
			  Ändern der primären E-Mail-Adresse eines Benutzers seine bisherigen E-Mails
			  nicht mehr erreichbar! Wird einem anderen Benutzer eine ehemals vergebene
			  primäre E-Mail-Adresse zugewiesen, bekommt dieser Zugriff auf die alte
			  IMAP-Struktur dieses Postfachs.
			</simpara>
		  </listitem>
		</itemizedlist>

	  <para>
		Mit der &ucsUCRV; <envar>mail/dovecot/mailbox/delete</envar> kann konfiguriert
		werden, ob IMAP-Postfächer automatisch gelöscht werden sollen. Der Wert <literal>yes</literal> aktiviert die Löschung des betroffenen IMAP-Postfachs bei folgenden Aktionen:
		<itemizedlist>
			<listitem>
				<simpara>
					dem Löschen des Benutzerkontos
				</simpara>
			</listitem>
			<listitem>
				<simpara>
					dem Entfernen der primären Mailadresse von einem Benutzerkonto
				</simpara>
			</listitem>
			<listitem>
				<simpara>
					dem Ändern des Mail Home Servers auf ein anderes System
				</simpara>
			</listitem>
		</itemizedlist>
		In der Grundeinstellung (<literal>no</literal>) bleiben die
		Postfächer bei diesen Aktionen erhalten und müssen ggf. manuell gelöscht werden.
	  </para>

	<para>
		Aus der Kombination der beiden Variablen ergeben sich folgende vier Fälle, wenn E-Mail-Adressen geändert werden:
		<table>
			<title>Umbenennung von E-Mail-Adressen</title>
			<tgroup cols="2">
				<colspec colnum="1" colname="col1" colwidth="1*"/>
				<colspec colnum="2" colname="col2" colwidth="2*"/>
				<thead>
					<row>
						<entry><envar>mail/dovecot/mailbox/…</envar></entry>
						<entry>Bedeutung</entry>
					</row>
				</thead>
				<tbody>
					<row>
						<entry>
							<literal>rename=yes</literal> und <literal>delete=no</literal> (Standard)
						</entry>
						<entry>Die bestehende Mailbox wird umbenannt. E-Mails bleiben erhalten
							und sind unter dem neuen Namen erreichbar.
						</entry>
					</row>
					<row>
						<entry>
							<literal>rename=yes</literal> und <literal>delete=yes</literal>
						</entry>
						<entry>Die bestehende Mailbox wird umbenannt. E-Mails bleiben erhalten
							und sind unter dem neuen Namen erreichbar.
						</entry>
					</row>
					<row>
						<entry>
							<literal>rename=no</literal> und <literal>delete=no</literal>
						</entry>
						<entry>Eine neue, leere Mailbox wird erzeugt. Die alte bleibt unter dem
							alten Namen auf der Festplatte erhalten und ist damit vorerst für
							Benutzer nicht zu erreichen.
						</entry>
					</row>
					<row>
						<entry>
							<literal>rename=no</literal> und <literal>delete=yes</literal>
						</entry>
						<entry>Eine neue, leere Mailbox wird erzeugt. Die alte Mailbox wird inkl. aller enthaltenen Mails von
							der Festplatte gelöscht.
						</entry>
					</row>
				</tbody>
			</tgroup>
		</table>
	</para>

	</section>

	<section id="mail::homeserver">
	  <title>Verteilung einer Installation auf mehrere Mailserver</title>

	  <para>
		Das UCS-Mailsystem bietet die Möglichkeit die Benutzer auf mehrere Mailserver
		zu verteilen. Dazu wird jedem Benutzer ein sogenannter Mail Home Server
		zugewiesen, auf dem die Maildaten des Benutzers abgelegt werden. Beim
		Zustellen einer E-Mail wird der zuständige Home Server automatisch aus dem
		LDAP-Verzeichnis ermittelt.
	  </para>

	  <para>
		Es ist zu beachten, dass globale IMAP-Ordner (siehe <xref
		linkend="mail::management::sharedfolder"/>) einem Mail Home Server zugeordnet
		sind.
	  </para>

	  <para>
		Beim ändern des Mail Home Servers eines Benutzers werden dessen E-Mails <emphasis>nicht</emphasis>
		automatisch auf den neuen Server verschoben.
	  </para>
	</section>

	<section id="mail::serverconfig::nfs">
		<title>Mailserver-Speicher auf NFS</title>
		<para>
			Dovecot unterstützt das Speichern von E-Mails und Index-Dateien auf
			Cluster-Dateisystemen und NFS. Einige Einstellungen sind jedoch nötig, um
			Datenverluste in bestimmten Situationen zu vermeiden.
		</para>
		<para>
			Die folgenden Einstellungen gehen davon aus, dass auf Mailboxen nicht
			gleichzeitig von mehreren Servern aus zugegriffen wird. Das ist der Fall,
			wenn jedem Benutzer ein Mail Home Server zugeordnet ist.
		</para>
		<para>
			<itemizedlist>
				<listitem><simpara><envar>mail/dovecot/process/mmap_disable</envar><literal> = yes</literal></simpara></listitem>
				<listitem><simpara><envar>mail/dovecot/process/dotlock_use_excl</envar><literal> = yes</literal></simpara></listitem>
				<listitem><simpara><envar>mail/dovecot/process/mail_fsync</envar><literal> = always</literal></simpara></listitem>
			</itemizedlist>
		</para>
		<para>
			Um eine bessere Performance zu erreichen, können Index-Dateien statt
			zusammen mit den Nachrichten im NFS auch auf der lokalen Festplatte
			gespeichert werden. Sie sind dann unter
			<filename class="directory">/var/lib/dovecot/index/</filename> zu finden.
			Setzen Sie dafür die &ucsUCRV; <envar>mail/dovecot/location/separate_index</envar><literal> = yes</literal>.
		</para>
		<para>
			Mit diesen Einstellungen sollte normalerweise alles problemlos
			funktionieren. Die im Einsatz befindlichen Server- und Client-Systeme
			sind jedoch so vielfältig, dass hier noch ein paar Hinweise folgen, wie
			bei Schwierigkeiten weiter vorgegangen werden kann:
			<itemizedlist>
				<listitem><simpara>Wenn NFSv2 im Einsatz ist (nicht der Fall, wenn der NFS-Server ein &ucsUCS; ist), setzen Sie bitte <envar>mail/dovecot/process/dotlock_use_excl</envar><literal> = no</literal>.</simpara></listitem>
				<listitem><simpara>Falls kein lockd eingesetzt wird (nicht der Fall auf &ucsUCS;-Systemen) oder falls trotz des Einsatzes von lockd Locking-Fehler auftreten, setzen Sie <envar>mail/dovecot/process/lock_method</envar><literal> = dotlock</literal>. Dies verringert die Performance, aber behebt die meisten Locking-bezogenen Probleme.</simpara></listitem>
				<listitem><simpara>Dovecot kann mit <envar>mail/dovecot/process/mail_nfs_storage</envar><literal> = yes</literal> angewiesen werden, wenn nötig, den NFS Cache zu leeren. Dies funktioniert jedoch nicht immer, daher kann es zu sporadischen Fehlern kommen. Das gleiche gilt für das Leeren des NFS-Cache nach dem Schreiben von Index-Dateien: <envar>mail/dovecot/process/mail_nfs_index</envar><literal> = yes</literal>.</simpara></listitem>
				<listitem><simpara>In der Documentation des Dovecot Servers sind weitere Hinweise zu finden: <xref linkend="dovecot-wiki-clusterfs"/> <xref linkend="dovecot-wiki-nfs"/></simpara></listitem>
			</itemizedlist>
		</para>
	</section>

	<section id="mail::serverconfig::limits">
		<title>Beschränkung der Verbindungsanzahl</title>
		<para>
			In der Standardeinstellung in UCS wird Dovecot für jeweils maximal 400 gleichzeitige Verbindungen per IMAP und POP3 ausgeliefert.
			Diese reichen sicher aus, um 100 gleichzeitig eingeloggte IMAP-Benutzer zu bedienen, unter Umständen deutlich mehr.
			Wie viele IMAP-Verbindungen Benutzer gleichzeitig geöffnet haben, hängt von den eingesetzten Clients ab.
			Webmail öffnet nur einzelne, kurzlebige Verbindungen.
			Desktop E-Mail-Programme halten über lange Zeit mehrere Verbindungen offen.
			Mobile Clients halten über lange Zeit wenige Verbindungen offen, aber beenden diese oft nicht von sich aus, so dass sie unnötig lang Ressourcen belegen.
			Die Beschränkungen dienen primär dazu, einem Denial-of-service-Angriff durch sehr viele geöffnete Prozesse und Netzwerkverbindungen zu widerstehen.
		</para>
		<para>
			Um die in diesem Augenblick offenen Verbindungen zu sehen, kann folgender Befehl ausgeführt werden:
			<programlisting language="sh">doveadm who</programlisting>
			Um die Gesamtanzahl auszugeben:
			<programlisting language="sh">doveadm who -1 | wc -l</programlisting>
		</para>
		<para>
			Um die Beschränkungen zu verändern, können die &ucsUCRV;n <envar>mail/dovecot/limits/*</envar> angepasst werden.
			Der Vorgang ist auf Grund des komplexen Zusammenspiels dieser Variablen nur halb automatisch.
			Die Bedeutung aller Variablen kann in der Dovecot Dokumentation nachgelesen werden: <xref linkend="dovecot-wiki-services"/>.
		</para>
		<para>
			Da bei Dovecot verschiedene Prozesse für Login und Zugriff auf die E-Mail-Dateien zuständig sind, können diese getrennt konfiguriert werden.
			Zusätzlich wird getrennt konfiguriert wie viele Verbindungen zu einem Dienst erlaubt sind und wie viele Prozesse für einen Dienst gestartet werden.
			Durch das Setzen von <envar>mail/dovecot/limits/default_client_limit</envar><literal> = 3000</literal> würde die Beschränkung für die Anzahl an Verbindungen zu den POP3- und IMAP-Diensten verändert, nicht jedoch für die erlaubte Anzahl an Prozessen.
			In der &ucsUCS; Standardeinstellung läuft Dovecot im <foreignphrase>High-security mode</foreignphrase>:
			Jede Verbindung wird von einem separaten Login-Prozess betreut.
			Da standardmäßig nur 400 Prozesse erlaubt sind, können auch nicht mehr Verbindungen geöffnet werden.
		</para>
		<para>
			Um 3000 Verbindungen von Benutzern zu ihren E-Mails zu erlauben, muss daher eine weitere &ucsUCRV; gesetzt werden:
			<programlisting language="sh">
ucr set mail/dovecot/limits/default_client_limit=3000
ucr set mail/dovecot/limits/default_process_limit=3000
doveadm reload
			</programlisting>
		</para>
		<para>
			Ein Blick in <filename>/var/log/dovecot.info</filename> offenbart nun eine Warnung:
<screen>
config: Warning: service auth { client_limit=2000 } is lower than required under max. load (15000)
config: Warning: service anvil { client_limit=1603 } is lower than required under max. load (12003)
</screen>
			Die Dienste <literal>auth</literal> (Zuständig für Login und SSL-Verbindungen) sowie <literal>anvil</literal> (Zuständig für Statistiken) haben noch das Standardlimit.
			Es werden zwar je 3000 POP3- und IMAP-Verbindungen und -Prozesse erlaubt, aber die Anzahl der Prozesse für Login und SSL ist nun zu niedrig um sie alle zu bedienen.
			Dies wird dazu führen, dass Logins fehlschlagen.
		</para>
		<para>
			Die hohen Werte kommen dadurch zustande, dass mit <literal>default_client_limit</literal> und <literal>default_process_limit</literal> nicht nur die Beschränkungen von IMAP und POP3 erhöht werden, sondern auch einiger weiterer Dienste wie <literal>lmtp</literal> und <literal>managesieve-login</literal>.
			Diese Dienste können nun mehr zu überwachende Prozesse starten und theoretisch mehr Authentifizierungen durchführen, wodurch sich die maximale Anzahl gleichzeitiger Verbindungen zu den Diensten <literal>auth</literal> und <literal>anvil</literal> erhöht.
		</para>
		<para>
			Die Werte für die Dienste müssen nun der Fehlermeldung entsprechend angepasst werden:
<programlisting language="sh">
ucr set mail/dovecot/limits/auth/client_limit=15000
ucr set mail/dovecot/limits/anvil/client_limit=12003
doveadm reload
</programlisting>
			Ein Blick in <filename>/var/log/dovecot.info</filename> offenbart nun noch eine letzte Warnung:
<screen>
master: Warning: fd limit (ulimit -n) is lower than required under max. load (2000 &lt; 15000),…
 because of service auth { client_limit }
</screen>
			Das vom Linux-Kernel kontrolliere <literal>ulimit</literal> (die erlaubte Anzahl gleichzeitig geöffneter Dateien/Verbindungen pro Prozess) wird nur bei einem Neustart des Dovecot-Dienstes verändert, daher:
<programlisting language="sh">
invoke-rc.d dovecot restart
</programlisting>
			Nun erscheint keine Fehlermeldung mehr, und IMAP- und POP3-Server akzeptieren nun beide je 3000 Verbindungen.
		</para>
		<para>
			&ucsUCS; konfiguriert Dovecot so, dass es standardmäßig im <foreignphrase>High-security mode</foreignphrase> läuft.
			In Installationen mit 10.000en Benutzern kann Dovecot im <foreignphrase>High-performance mode</foreignphrase> betrieben werden.
			Der Performance-Leitfaden beschreibt, wie dieser konfiguriert werden kann: <biblioref linkend="ucs-performance-guide"/>.
		</para>
	</section>

  </section>

  <section id="mail:clients">
	<title>Konfiguration von Mail-Clients für den Mailserver</title>

	<para>
	  Um einen Mail-Client mit dem UCS-Mailserver zu verwenden wird die Verwendung von IMAP
	  empfohlen. Durch STARTTLS wird bei Verwendung von SMTP (für den Mailversand) und IMAP (für den
	  Mailabruf/-synchronisation) nach einer initialen Aushandlungsphase auf eine TLS-gesicherte
	  Verbindung umgeschaltet. Als Authentifizierungsmethode sollte <emphasis>Passwort (plain text)</emphasis>
	  in Verbindung mit <emphasis>STARTTLS</emphasis> verwendet werden. Die Benennung der Methode
	  unterscheidet sich je nach Mail-Client. Der folgende Screenshot zeigt exemplarisch die Einrichtung von
	  Mozilla Thunderbird:
	</para>

	  <figure id="mail:clients:thunderbird">
		<title>Einrichtung von Mozilla Thunderbird</title>
		<graphic scalefit="1" align="center" width="80%" fileref="illustrations44/thunderbird_de.png"/>
	  </figure>
  </section>


  <section id="mail::horde">
	<title>Webmail und Verwaltung von E-Mail-Filtern mit Horde</title>

	<para>
	  UCS integriert mehrere Applikationen des Horde-Frameworks für den Webzugriff
	  auf E-Mails und zur webbasierten Verwaltung von serverseitigen
	  E-Mail-Filterregeln auf Basis von Sieve. Horde kann über das Univention App Center installiert
	  werden (siehe <xref linkend="software:appcenter"/>).
	</para>

	<section id="mail:Anmeldung_und_Übersicht">
	  <title>Anmeldung und Übersicht</title>
	  <para>
		Die Horde-Anmeldemaske ist auf der Übersichtswebseite (siehe <xref linkend="central-management-umc:login"/>) unter
		<guimenu>Horde Webclient</guimenu> verlinkt und kann auch direkt unter
		<uri>http://<replaceable>SERVERNAME</replaceable>/horde/</uri> erreicht werden.
	  </para>

		<figure id="horde-login">
		  <title>Anmeldung an Horde</title>
		  <graphic scalefit="1" align="center" width="35%" fileref="illustrations44/login_de.png"/>
		</figure>

	  <para>
		Als <guimenu>Benutzername</guimenu> kann entweder der UCS-Benutzername oder die
		primäre E-Mail-Adresse eingegeben werden. Das Webmail-Interface kann in
		verschiedenen Darstellungsvarianten verwendet werden. Die gewünschte Variante
		kann unter <guimenu>Modus</guimenu> ausgewählt werden. Für
		Standard-Workstations wird die Verwendung des dynamischen Interfaces
		empfohlen. Die weitere Dokumentation orientiert sich an dieser Variante.
		Die Auswahl der <guimenu>Sprache</guimenu> hat bei vielen Browsern keine Auswirkung, da die
		bevorzugte Spracheinstellung des Browsers Vorrang hat.
	  </para>

	  <para>
		In der oberen Bildleiste finden sich mehrere Menüpunkte (z.B. <guimenu>Webmail</guimenu>
		oder <guimenu>Adressbuch</guimenu>), mit denen zwischen den einzelnen Modulen gewechselt
		werden kann.
	  </para>

	  <para>
		Durch Klick auf das Zahnrad-Symbol kann Horde vom Benutzer personalisiert werden.
	  </para>
	</section>

	<section id="mail:Webbasierter_Mailzugriff">
	  <title>Webbasierter Mailzugriff</title>

	  <para>
		Horde bietet alle Standardfunktionen eines E-Mail-Clients, wie das Versenden,
		Weiterleiten oder Löschen von E-Mails. E-Mails können in Ordner einsortiert
		werden und werden standardmäßig im <guimenu>Posteingang</guimenu> abgelegt.
		Beim ersten Versenden einer E-Mail wird automatisch ein
		<emphasis>Gesendet</emphasis>-Ordner erstellt.
	  </para>

		<figure id="horde-inbox">
		  <title>Webmail (Posteingang)</title>
		  <graphic scalefit="1" width="95%" fileref="illustrations44/inbox_de.png"/>
		</figure>

	  <para>
		Horde unterscheidet zwei Arten von Löschungen: Eine mit
		<guimenu>Löschen</guimenu> entfernte E-Mail wird zuerst in den Ordner
		<emphasis>Papierkorb</emphasis> verschoben. Sie kann von dort wieder in andere Ordner
		verschoben werden, solange der Papierkorb nicht mit <guimenu>Leeren</guimenu> geleert wird.
	  </para>
	</section>

	<section id="mail:Adressbuch">
	  <title>Adressbuch</title>

	  <para>
		In diesem Modul werden E-Mail-Adressen und weitere Kontaktdaten verwaltet. Die
		hier erfassten Informationen werden in einer Horde-eigenen SQL-Datenbank
		gespeichert.
	  </para>

		<figure id="horde-address">
		  <title>Adressbuch für Webmail</title>
		  <graphic scalefit="1" width="100%" fileref="illustrations44/addressbook_de.png"/>
		</figure>

	  <para>
		Mit der einfachen oder erweiterten Suche gefundene Kontaktdaten lassen sich in
		eigene Adressbücher kopieren und dort bearbeiten. Neue Kontakte können über den
		Menü-Punkt <guimenu>Neuer Kontakt</guimenu> eingetragen werden. Über
		<guimenu>Meine Adressbücher</guimenu> können auch zusätzliche persönliche
		Adressbücher erstellt werden.
	  </para>

	  <para>
		Über den Menü-Punkt <guimenu>Liste</guimenu> lässt sich der Inhalt von
		Adressbüchern anzeigen. Die Listen lassen sich durch Klick auf einen
		gewünschten Spaltenkopf (Name, Vorname, etc.) alphabetisch sortieren. Ein
		Klick auf das Lupen-Symbol in der Kopfzeile des jeweiligen Adressbuches (direkt
		neben dem Adressbuchnamen) öffnet ein Suchfeld, durch das man einfach innerhalb
		des angezeigten Adressbuchs suchen kann. Aus einer Liste können einzelne
		Adressen zur anschließenden Verwendung durch ein Kreuz in der ersten Spalte
		markiert werden, z.B. um sie als Datei in einem bestimmten Dateiformat zu
		exportieren oder in ein anderes Adressbuch zu kopieren.
	  </para>
	</section>

	<section id="mail::horde::filter">
	  <title>E-Mail-Filter</title>

	  <para>
		Dovecot unterstützt serverseitige Filterskripte, die in einer eigenen
		Skriptsprache namens Sieve geschrieben werden. Das Filter-Modul erlaubt die
		Generierung dieser Filterskripte. Sie gelten allgemein, greifen also auch für
		Benutzer, die über einen Standard-Mail-Client auf ihre Postfächer zugreifen.
	  </para>

		<figure id="horde-filter">
		  <title>Filterverwaltung in Horde</title>
		  <graphic scalefit="1" width="100%" fileref="illustrations44/filter_de.png"/>
		</figure>

	  <para>
		Die Regeln lassen sich unter <guimenu>Webmail &ar; Filter</guimenu> bearbeiten
		und ergänzen. Die Filter werden in der durchnummerierten Reihenfolge auf
		eingehende E-Mails angewandt. Ihre Position lässt sich sowohl über die Pfeile
		rechts als auch durch direkte Eingabe einer Nummer in der Spalte
		<command>Verschieben</command> anpassen. Einzelne Filterregeln können in der
		Spalte <command>Aktiviert</command> an- und abgeschaltet werden.
	  </para>

	  <para>
		Unter <guimenu>Spam</guimenu> kann benutzerbezogen angepasst werden, welcher
		Spam-Schwellwert gelten soll. Der angegebene <guimenu>Spam-Level</guimenu> ist
		der SpamAssassin-Schwellwert. Eine E-Mail, die diesen Wert erreicht, wird in
		den angegebenen Ordner verschoben.
	  </para>

	  <para>
		Unter <guimenu>Abwesenheit</guimenu> lässt sich ein Zeitraum
		festlegen, in dem auf eingehende E-Mails automatisch vom Mailserver mit einer
		Antwort-E-Mail reagiert wird. Text und Betreff der E-Mail ist frei wählbar.
	  </para>

	  <para>
		Über <guimenu>Neue Regel</guimenu> können eigene Regeln erstellt werden,
		bspw. zur automatischen Sortierung von eingehenden E-Mails in themenbezogene
		Mailordner.
	  </para>

	  <para>
		Ein Klick auf <guimenu>Skript</guimenu> zeigt den Quelltext des generierten
		Sieve-Skripts an.
	  </para>
	</section>
  </section>
</chapter>
<!-- vim:set ts=2 sw=2 tw=100 noet ft=docbk:-->
