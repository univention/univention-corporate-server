<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE chapter [
	<!ENTITY % extensions SYSTEM "../stylesheets/macros.ent" >
	<!ENTITY % DocBookDTD PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
	"http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd">
	<!ENTITY % entities SYSTEM "../stylesheets/macros-en.ent" >
	%extensions;
	%DocBookDTD;
	%entities;
]>
<chapter id="mail::general">
  <title>Mail services</title>

  <section id="mail::introduction">
    <title>Introduction</title>
    <para>
	  &ucsUCS; provides mail services that users can access both via standard
	  mail clients such as Thunderbird and via the webmail interface Horde.
    </para>

    <para>
	  Postfix is used for sending and receiving mails. In the basic
	  installation, a configuration equipped for local mail delivery is set up
	  on every UCS system. In this configuration, Postfix only accepts mails
	  from the local server and they can also only be delivered to local system
	  users.
    </para>

    <para>
	  The installation of the mail server component implements a complete mail
	  transport via SMTP (see <xref linkend="mail::installation"/>).
	  Postfix is reconfigured during the installation of the component so that
	  a validity test in the form of a search in the LDAP directory is
	  performed for incoming e-mails. That means that e-mails are only accepted
	  for e-mail addresses defined in the LDAP directory or via an alias.
    </para>

    <para>
	  The IMAP service Cyrus is also installed on the system along with the mail
	  server component. It provides e-mail accounts for the domain users and
	  offers corresponding interfaces for access via e-mail clients.
	  Cyrus is preconfigured for the fetching of e-mails via <systemitem class="protocol">IMAP</systemitem> and <systemitem class="protocol">POP3</systemitem>.
	  Access via POP3 can be deactivated by setting the &ucsUCRV;
	  <envar>mail/cyrus/pop</envar> to <literal>no</literal>. The same
	  applies to IMAP and the &ucsUCRV; <envar>mail/cyrus/imap</envar>.
	  The further configuration of the mail server is performed via &ucsUCR;,
	  as well (see <xref linkend="mail::serverconfig::general"/>).
	</para>

    <para>
	  The management of the user data of the mail server (e.g., e-mail
	  addresses or mailing list) is performed via &ucsUMC; and is documented in
	  <xref linkend="mail::management::general"/> User data are stored in LDAP.
	  The authentication is performed using a user's primary e-mail address,
	  i.e., it must be entered as the user name in mail clients.
	  As soon as a primary e-mail address is assigned to a user in the LDAP
	  directory, a listener module creates an IMAP mailbox on the mail home
	  server.
	  By specifying the mail home server, user e-mail accounts can be
	  distributed over several mail servers, as well
	  (see <xref linkend="mail::homeserver"/>).
    </para>

    <para>
	  Optionally, e-mails received via Postfix can be checked for spam content
	  and viruses before further processing by Cyrus.
	  Spam e-mails are detected by the classification software SpamAssassin
	  (<xref linkend="mail::spam"/>); ClamAV is used for the detection of
	  viruses and other malware (<xref linkend="mail::viren"/>).
    </para>

    <para>
	  In the default setting, e-mails to external domains are delivered
	  directly to the responsible SMTP server of that domain.
	  Its location is performed via the resolution of the MX record in the
	  DNS. Mail sending can also be taken over by the relay host, e.g., on the
	  Internet provider (see <xref linkend="mail::serverconfig::relay"/>).
    </para>

    <para>
	  The Horde framework is available for web-based mail access
	  (see <xref linkend="mail::horde"/>). The UCS mail system does not offer
	  any groupware functionality such as shared calendars or invitations to
	  appointments. However, there are groupware systems based on UCS which
	  integrate in the UCS management system such as Kolab, Zarafa and
	  Open-Xchange. Further information can be found in the Univention App Center
	  (see <xref linkend="software:appcenter"/>).
    </para>
  </section>

  <section id="mail::installation">
	<title>Installation</title>

	<para>
	  A mail server can be installed from the Univention App Center with the application
	  <emphasis>Mail server</emphasis>. Alternatively, the software package
	  <package>univention-mail-server</package> can be installed. Additional information can be found in
	  <xref linkend="computers::softwaremanagement::installsoftware"/>.
	  A mail server can be installed on all server system roles. The use of a
	  domain controller is recommended because of frequent LDAP accesses.
	</para>

	<para>
	  The runtime data of the Cyrus server are stored in the
	  <filename class="directory">/var/spool/cyrus/</filename> directory. This directory
	  should not be operated on a NFS share.
	</para>

	<para>
	  The webmail interface Horde can be installed via the Univention App Center (see <xref
	  linkend="software:appcenter"/>).
	</para>

  </section>

  <section id="mail::management::general">
	<title>Management of the mail server data</title>

	<section id="mail::management::domains">
	  <title>Management of mail domains</title>
	  <para>
		A mail domain is an common namespace for e-mail addresses, mailing
		lists and IMAP group folders. Postfix differentiates between the
		delivery of e-mails between local and external domains. Delivery to
		mailboxes defined in the LDAP directory is only conducted for e-mail
		address from local domains.
		The name of a mail domain may only be composed of lowercase letters,
		the figures 0-9, full stops and hyphens.
	  </para>
	  <para>
		Several mail domains can be managed with UCS. The managed mail domains
		do not need to be the DNS domains of the server - they can be
		selected at will.
		The mail domains registered on a mail server are automatically
		saved in the &ucsUCRV; <envar>mail/hosteddomains</envar>.
	  </para>
	  <para>
		To ensure that external senders can also send e-mails to members of
		the domain, MX records must be created in the configuration of the
		authoritative name servers, which designate the UCS server as mail
		server for the domain. These DNS adjustments are generally performed
		by an Internet provider.
	  </para>
	  <para>
		Mail domains are managed in the UMC module <emphasis>Mail</emphasis>
		with the <guimenu>Mail domain</guimenu> object type
		(see <xref linkend="central:user-interface"/>).
	  </para>
	</section>

	<section id="mail::management::users">
	  <title>Assignment of e-mail addresses to users</title>
	  <para>
		E-mail addresses can consist of the following characters: letters a-z,
		figures 0-9, dots, hyphens and underscores. The address has to begin
		with a letter and must include an @ character.
		At least one mail domain must be registered for to be able to
		assign e-mail addresses (see <xref linkend="mail::management::domains"/>).
	  </para>
	  <para>
		A user can be assigned two different types of e-mail addresses:
	  </para>
		<itemizedlist>
		  <listitem>
			<para>
			  The <emphasis>primary e-mail address</emphasis> is used for authentication on Postfix
			  and Cyrus. Primary e-mail addresses must always be unique. Only one primary e-mail
			  address can be configured for every user. It also defines the user's IMAP mailbox. 
			  If a mail home server is assigned to a user (see <xref linkend="mail::homeserver"/>),
			  the IMAP inbox is automatically created by a Univention directory listener module.
			  The domain part of the e-mail address must be registered in &ucsUMC; (see
			  <xref linkend="mail::management::domains"/>).
			</para>
		  </listitem>
		  <listitem>
			<para>
			  E-mails to <emphasis>alternative e-mail addresses</emphasis> are also delivered to the
			  user's mailbox. As many addresses can be entered as you wish. The
			  alternative e-mail addresses do not have to be unique: if two users
			  have the same e-mail address, they both receive all the e-mails which
			  are sent to this address. The domain part of the
			  e-mail address must be registered in &ucsUMC; (see
			  <xref linkend="mail::management::domains"/>).
			</para>
		  </listitem>
		</itemizedlist>
	  <para>
		E-mail addresses are managed in the UMC module <emphasis>Users</emphasis>
		(see <xref linkend="central:user-interface"/>).
		The <guimenu>primary e-mail address</guimenu> is entered in
		the <guimenu>General</guimenu> tab in the <guimenu>User account</guimenu>
		submenu.
		<guimenu>Alternative e-mail addresses</guimenu> can be entered
		under <guimenu>Advanced settings &ar; Mail</guimenu>.
	  </para>
	  <note>
		<para>
		Once the user account is properly configured authentication to the mail stack 
		is possible (IMAP/SMTP). Please keep in mind that after disabling the account
		or changing the password the login to the mail stack is still possible for 30min
		due to authentication cache of the mail stack.
		To invalidate the authentication cache restart the <systemitem class="service">saslauthd</systemitem>
		service on the mail server. The expiration time of the authentication cache can be 
		configured with the &ucsUCRV; <envar>mail/saslauthd/cache/timeout</envar> on
		the mail server.
		</para>
	  </note>
	</section>

	<section id="mail::management::mailinglists">
	  <title>Management of mailing lists</title>
	  <para>
		Mailing lists are used to exchange e-mails in closed groups. Each
		mailing list has its own e-mail address. If an e-mail is sent to this
		address, it is received by all the members of the mailing list.
	  </para>
	  <para>
		<figure id="mail-mailinglist">
		  <title>Creating a mailing list</title>
		  <graphic scalefit="1" width="90%" align="center" fileref="illustrations40/mail_mailinglist_en.png"/>
		</figure>
	  </para>
	  <para>
		Mail domains are managed in the UMC module <emphasis>Mail</emphasis>
		with the <guimenu>Mailing list</guimenu> object type
		(see <xref linkend="central:user-interface"/>).
		A name of your choice can be entered for the mailing list
		under <guimenu>Name</guimenu>; the entry of a <guimenu>Description</guimenu>
		is optional.
		The e-mail address of the mailing list should be entered as
		the <guimenu>Mail address</guimenu>. The domain part of the address needs
		to be the same as one of the managed mail domains.
		As many addresses as necessary can be entered
		under <guimenu>Members</guimenu>. In contrast to mail groups (see
		<xref linkend="mail::management::mailgroups"/>), external e-mail
		addresses can also be added here.
		The mailing list is available immediately after its creation.
	  </para>
	  <para>
		In the default settings, everyone can write to the mailing list. To
		prevent misuse, there is the possibility of restricting the circle of
		people who can send mails. To do so,
		the &ucsUCRV; <envar>mail/postfix/policy/listfilter</envar> on the mail server must
		be set to <literal>yes</literal> and Postfix restarted.
		<guimenu>Users that are allowed to send e-mails to the list</guimenu>
		and <guimenu>Groups that are allowed to send e-mails to the list</guimenu>
		can be specified under <guimenu>Advanced settings</guimenu>. If a field is set
		here, only authorised users/groups are allowed to send mails.
	  </para>
	</section>

	<section id="mail::management::mailgroups">
	  <title>Management of mail groups</title>
	  <para>
		There is the possibility of creating a mail group: This is where an
		e-mail address is assigned to a group. E-mails to this address are
		delivered to the primary address of each of the group members.
	  </para>
	  <para>
		Mail groups are managed in the UMC module <emphasis>Groups</emphasis>
		(see <xref linkend="central:user-interface"/>).
	  </para>
	  <para>
		The address of the mail group is specified in
		the <guimenu>mail address</guimenu> input field
		under <guimenu>Advanced settings</guimenu>. The domain part of the address
		must be the same as one of the managed mail domains.
	  </para>
	  <para>
		In the default settings, everyone can write to the mail group. To
		prevent misuse, there is the possibility of restricting the circle of
		people who can send mails. To do so,
		the &ucsUCRV; <envar>mail/postfix/policy/listfilter</envar> on the mail server must
		be set to <literal>yes</literal> and Postfix restarted.
	  </para>
	  <para>
		<guimenu>Users that are allowed to send e-mails to the group</guimenu>
		and <guimenu>Groups that are allowed to send e-mails to the group</guimenu> can be specified
		under <guimenu>Advanced settings</guimenu>. If a field is set here,
		only authorised users/groups are allowed to send mails.
	  </para>
	</section>

	<section id="mail::management::sharedfolder">
	  <title>Management of shared IMAP folders</title>
	  <para>
		Shared e-mail access forms the basis for cooperation in many work
		groups. In UCS, users can easily create folders in their own mailboxes
		and assign permissions so that other users may read e-mails in these
		folders or save additional e-mails in them.
	  </para>
	  <para>
		Alternatively, individual IMAP folders can be shared for users or user
		groups. This type of order is described as a shared IMAP folder.
		Shared IMAP folders are managed in the UMC module <emphasis>Mail</emphasis>
		with the <guimenu>Mail folder (IMAP)</guimenu> object type
		(see <xref linkend="central:user-interface"/>).
	  </para>
	  <para>
		<figure id="mail-sharedfolder">
		  <title>Creating a shared IMAP folder</title>
		  <graphic scalefit="1" width="100%" fileref="illustrations40/mail_imapfolder_en.png"/>
		</figure>
	  </para>

	  <table>
		<title>'General' tab</title>
		<tgroup cols="2">
		  <colspec colnum="1" colname="col1" colwidth="1*"/>
		  <colspec colnum="2" colname="col2" colwidth="2*"/>
		  <thead>
			<row>
			  <entry>Attribute</entry>
			  <entry>Description</entry>
			</row>
		  </thead>
		  <tbody>

			<row>
			  <entry>Name (*)</entry>
			  <entry>
				The name under which the IMAP folder is available in the e-mail clients.
			  </entry>
			</row>

			<row>
			  <entry>Mail domain (*)</entry>
			  <entry>
				Every shared IMAP folder is assigned to a mail domain. The management
				of the domains is documented in the <xref linkend="mail::management::domains"/>.
			  </entry>
			</row>

			<row>
			  <entry>Mail home server (*)</entry>
			  <entry>
				An IMAP folder is assigned to a mail home server. Further information
				can be found in <xref linkend="mail::homeserver"/>.
			  </entry>
			</row>

			<row>
			  <entry>Quota in MB</entry>
			  <entry>
				This setting can be used to set the maximum total size of all e-mails
				in this folder.
			  </entry>
			</row>

			<row>
			  <entry>E-Mail address</entry>
			  <entry>
				<para>
				  An e-mail address can be entered here via which e-mails can be sent
				  directly to the IMAP folder. If no address is set here, it is only
				  possible to write in the folder from e-mail clients.
				</para>
				<para>
				  The domain part of the e-mail address must be registered in &ucsUMC; (see
				  <xref linkend="mail::management::domains"/>).
				</para>
				<para>
				  As soon as an e-mail address is entered for a folder, at least the
				  IMAP rights <literal>lrsp</literal> are set for the user <systemitem class="username">anyone</systemitem> so that the
				  IMAP server can save e-mails in the IMAP folder.
				</para>
			  </entry>
			</row>
		  </tbody>
		</tgroup>
	  </table>

	  <table>
		<title>'Access rights' tab</title>
		<tgroup cols="2">
		  <colspec colnum="1" colname="col1" colwidth="1*"/>
		  <colspec colnum="2" colname="col2" colwidth="2*"/>
		  <thead>
			<row>
			  <entry>Attribute</entry>
			  <entry>Description</entry>
			</row>
		  </thead>
		  <tbody>

			<row>
			  <entry>Name (*)</entry>
			  <entry>
				<para>
				  Access permissions based on users or groups can be entered
				  here. Users are entered with their primary e-mail addresses; the groups saved
				  in &ucsUMC; can be used as groups.
				</para>
				<para>
				  The access permissions have the following consequences for individual
				  users or members of the specified group:
				</para>
				<variablelist>
					<varlistentry>
						<term>No access</term>
						<listitem>
							<simpara>
							No access is possible. The folder is not displayed in the folder list.
							</simpara>
						</listitem>
					</varlistentry>
					<varlistentry>
						<term>Read</term>
						<listitem>
							<simpara>
							The user may only perform read access to existing entries.
							</simpara>
						</listitem>
					</varlistentry>
					<varlistentry>
						<term>Append</term>
						<listitem>
							<simpara>
							Existing entries may not be edited; only new entries may be created.
							</simpara>
						</listitem>
					</varlistentry>
					<varlistentry>
						<term>Write</term>
						<listitem>
							<simpara>
							New entries may be created in this directory;
							existing entries may be edited or deleted.
							</simpara>
						</listitem>
					</varlistentry>
					<varlistentry>
						<term>Post</term>
						<listitem>
							<simpara>
							Sending an e-mail to this directory as a
							recipient is permitted. This function is not supported by all the clients.
							</simpara>
						</listitem>
					</varlistentry>
					<varlistentry>
						<term>All</term>
						<listitem>
							<simpara>
							Encompasses all permissions of
							<emphasis>write</emphasis> and also allows the changing of access permissions.
							</simpara>
						</listitem>
					</varlistentry>
				</variablelist>
			  </entry>
			</row>
		  </tbody>
		</tgroup>
	  </table>
	</section>

	<section id="mail:Mail_quota">
	  <title>Mail quota</title>
	  <para>
		The size of the users' mailboxes can be restricted via the mail
		quota. When this is attained, no further e-mails can be accepted for
		the mailbox by the mail server until the user deletes old mails from
		her account.
		The limit is specified by the <emphasis>Mail quota</emphasis> policy, which is
		managed under <emphasis>Policies</emphasis> in the UMC module <emphasis>Users</emphasis>
		(see <xref linkend="central:policies"/>)
		The maximum size of the mailbox of a user is specified in
		the <guimenu>Quota limit (MB)</guimenu> field.
	  </para>
	  <para>
		The user can be warned once a specified portion of the mailbox is
		attained and then receives a message with every incoming mail that his
		available storage space is almost full. This warning is shown by the
		e-mails clients and must thus be supported by them.
		The administrator can enter the threshold in percent or remaining
		diskspace in kB:
		<itemizedlist>
		  <listitem>
			<para>
			  The threshold for when the warning message should be issued can
			  configured in the &ucsUCRV;
			  <envar>mail/cyrus/imap/quotawarnpercent</envar>. The value must be entered as a
			  number between 0 and 100 without the percent sign.
			</para>
		  </listitem>
		  <listitem>
			<para>
			  The &ucsUCRV; <envar>mail/cyrus/imap/quotawarnkb</envar> is
			  used to configure the threshold in kilobytes.
			</para>
		  </listitem>
		</itemizedlist>
	  </para>
	  <para>
		The quota is transferred to the quota settings of the Cyrus server
		during authentication on the mail server. The update interval is
		evaluated so that the quota settings are only updated once this time
		period has expired. This interval can be configured in minutes
		by &ucsUCRV; <envar>mail/cyrus/imap/quotainterval</envar>.
	  </para>
	  <para>
		No limit values are set for the IMAP storage space in the
		default setting. The use of mail quotas can be generally deactivated
		with the &ucsUCRV; <envar>mail/cyrus/imap/quota</envar>.
	  </para>
	</section>
  </section>

  <section id="mail::spam">
	<title>Spam detection and filtering</title>
	<para>
	  Undesirable and unsolicited e-mails are designated as spam. The software
	  SpamAssassin is integrated in UCS for the automatic identification of these
	  e-mails. SpamAssassin attempts to identify whether an e-mail is desirable or
	  not based on heuristics concerning its origin, form and content.
	  Integration occurs via the <package>univention-spamassassin</package>
	  package, which is automatically set up during the installation of the mail
	  server package.
	</para>
	<para>
	  SpamAssassin operates a point system, which uses an increasing number
	  of points to express a high probability of the e-mail being
	  spam. Points are awarded according to different criteria, for example,
	  keywords within the e-mail or incorrect encodings.
	  In the standard configuration only mails with a size of up to 300 kilobytes
	  are scanned, this can be adjusted using
	  the &ucsUCRV; <envar>mail/antispam/bodysizelimit</envar>.
	  E-mails which are classified as spam - because they exceed a certain
	  number of points - are not delivered to the recipient's inbox by
	  Cyrus, but rather in the <emphasis>Spam</emphasis> folder below it.
	  The filtering is performed by a SIEVE script, which is automatically generated when
	  the user is created.
	</para>
	<para>
	  The threshold in these scripts as of which e-mails are declared to be spam can be
	  configured with the &ucsUCRV; <envar>mail/antispam/requiredhits</envar>.
	  The presetting (5) generally does not need to be adjusted.
	  However, depending on experience in the local environment, this
	  value can also be set lower. This will, however, result in more
	  e-mails being incorrectly designated as spam.
	  Changes to the threshold do not apply to existing users, but the users
	  can change the value themselves in the Horde web client (see
	  <xref linkend="mail::horde::filter"/>).
	</para>
	<para>
	  There is also the possibility of evaluating e-mails with a Bayes
	  classifier. This compares an incoming e-mail with statistical data
	  already gathered from processed e-mails and uses this to adapt it's
	  evaluation to the user's e-mail.
	  The Bayes classification is controlled by the user himself, whereby
	  e-mails not identified as spam can be placed in the <emphasis>Spam</emphasis>
	  subfolder and a selection of legitimate e-mails copied into
	  the <emphasis>Ham</emphasis> subfolder. This folder is evaluated daily and data
	  which have not yet been collected or were previously classified
	  incorrectly are collected in a shared database. This evaluation is
	  activated in the default setting and can be configured with
	  the &ucsUCRV; <envar>mail/antispam/learndaily</envar>.
	</para>
	<para>
	  The spam filtering can be deactivated by setting
	  the &ucsUCRV; <envar>mail/antivir/spam</envar> to <literal>no</literal>.
	  When modifying Univention Configuration Registry variables concerning spam
	  detection, the AMaViS service and Postfix must be restarted subsequently.
	</para>
  </section>

  <section id="mail::viren">
	<title>Identification of viruses and malware</title>
	<para>
	  The UCS mail services include virus and malware detection via
	  the <package>univention-antivir-mail</package> package, which is automatically
	  set up during the set up of the mail server package. The virus scan
	  can be deactivated with the &ucsUCRV; <envar>mail/antivir</envar>.
	</para>
	<para>
	  All incoming and outgoing e-mails are scanned for viruses. If the
	  scanner recognises a virus, the e-mail is sent to
	  quarantine. That means that the e-mail is stored on the server where
	  it is not accessible to the user. The original recipient receives a
	  message per e-mail stating that this measure has been taken. If
	  necessary, the administrator can restore or delete this from
	  the <filename class="directory">/var/lib/amavis/virusmails/</filename> directory. Automatic deletion
	  is not performed.
	</para>
	<para>
	  The <application>AMaViSd-new</application> software serves as an interface between the mail server and
	  different virus scanners. The free virus scanner ClamAV is included in
	  the package and enters operation immediately after installation. The
	  signatures required for virus identification are procured and updated
	  automatically and free of charge by the Freshclam service.
	</para>
	<para>
	  Alternatively or in addition, other virus scanners can also be integrated
	  in AMaViS.
	  Postfix and AMaViS need to be restarted following changes to the
	  AMaViS or ClamAV configuration.
	</para>
  </section>

  <section id="mail::fetchmail">
	<title>Integration of Fetchmail for retrieving mail from external mailboxes</title>
	<para>
	  Usually, the UCS mail service accepts mails for the users of the UCS domain directly via
	  SMTP. UCS also offers optional integration of the software Fetchmail for fetching emails from
	  external POP3 or IMAP mailboxes.
	</para>

	<para>
	  Fetchmail can be installed via the Univention App Center; simply select the
	  <guimenu>Fetchmail</guimenu> application and then click on <guimenu>Install</guimenu>.
	</para>

	<para>
	  Once the installation is finished, there are additional input fields in the
	  <guimenu>Advanced settings &ar; Remote mail retrieval</guimenu> tab of the user
	  administration which can be used to configure the collection of mails from an external
	  server. The mails are delivered to the inboxes of the respective users (the primary e-mail
	  address must be configured for that).
    </para>
	<para>
	  The mail is fetched every twenty minutes once at least one e-mail address is configured for
	  mail retrieval. After the initial configuration of a user Fetchmail needs to be started in the
	  UMC module <guimenu>System services</guimenu>. In that module the fetching can
	  also be disabled (alternatively by setting the &ucsUCRV; <envar>fetchmail/autostart</envar>
	  to <literal>false</literal>).
	</para>
	  <table>
		<title>'Remote mail retrieval' tab'</title>
		<tgroup cols="2">
			<colspec colnum="1" colname="col1" colwidth="1*"/>
			<colspec colnum="2" colname="col2" colwidth="2*"/>
			<thead>
			  <row>
				<entry>Attribute</entry>
				<entry>Description</entry>
			  </row>
			</thead>
			<tbody>

			  <row>
				<entry>Username</entry>
				<entry>The user name to be provided to the mail server for fetching mail.</entry>
			  </row>

			  <row>
				<entry>Password</entry>
				<entry>The password to be used for fetching mail.</entry>
			  </row>

			  <row>
				<entry>Protocol</entry>
				<entry>The mail can be fetched via the IMAP or POP3 protocols.</entry>
			  </row>

			  <row>
				<entry>Remote mail server</entry>
				<entry>The name of the mail server from which the e-mails are to be fetched.</entry>
			  </row>

			  <row>
				<entry>Encrypt connection (SSL/TLS)</entry>
				<entry>If this option is enabled, the mail is fetched in an encrypted form (when
				this is supported by the mail server).</entry>
			  </row>

			  <row>
				<entry>Keep mails on the server</entry>
				<entry>In the default settings, the fetched mails are deleted from the server
				following the transfer. If this option is enabled, it can be suppressed.</entry>
			  </row>

			</tbody>
		  </tgroup>
		</table>
  </section>

  <section id="mail::serverconfig::general">
	<title>Configuration of the mail server</title>

	<section id="mail::serverconfig::relay">
	  <title>Configuration of a relay host for sending the e-mails</title>

	  <para>
		In the default setting, Postfix creates a direct SMTP connection to
		the mail server responsible for the domain when an e-mail is sent to
		a non-local address. This server is determined by querying the MX
		record in the DNS.
	  </para>
	  <para>
		Alternatively, a mail relay server can also be used, i.e., a server
		which receives the mails and takes over their further sending. This
		type of mail relay server can be provided by a superordinate corporate
		headquarters or the Internet provider, for example. To set a relay
		host, it must be entered as a fully qualified domain name(FQDN) in
		the &ucsUCRV; <envar>mail/relayhost</envar>.
	  </para>
	  <para>
		If authentication is necessary on the relay host for sending,
		the &ucsUCRV; <envar>mail/relayauth</envar> must be set to <literal>yes</literal> and
		the <filename>/etc/postfix/smtp_auth</filename> file edited. The relay host,
		user name and password must be saved in this file in one line.
	  </para>
		<programlisting>
<replaceable>FQDN-Relayhost</replaceable>			<replaceable>username</replaceable>:<replaceable>password</replaceable>
		</programlisting>
	  <para>
		The command
	  </para>
		<programlisting language="sh">
postmap /etc/postfix/smtp_auth
		</programlisting>
	  <para>
		must then be executed for this file to adopt the changes via Postfix.
	  </para>
	</section>

	<section id="mail::serverconfig::mailsize">
	  <title>Configuration of the maximum mail size</title>

	  <para>
		The &ucsUCRV; <envar>mail/messagesizelimit</envar> can be used to set the maximum
		size in bytes for incoming and outgoing e-mails. Postfix must be restarted after modifying the setting.
		The preset maximum size is 10240000 bytes. If the value is configured to
		<literal>0</literal> the limit is effectively removed.
		Please note that e-mail attachments are enlarged by approximately a third due to the base64
		encoding.
	  </para>

	  <para>
		If Horde (see <xref linkend="mail::horde"/>) is used, the &ucsUCR; variables
		<envar>php/limit/filesize</envar> and <envar>php/limit/postsize</envar> must also be
		adjusted. The maximum size in megabytes must be entered as the value in both variables. Then
		the Apache web server has to be restarted.
	  </para>

	</section>

	<section id="mail::serverconfig::archivefolder">
	  <title>Configuration of a blind carbon copy for mail archiving solutions</title>

	  <para>
		If the &ucsUCRV; <envar>mail/archivefolder</envar> is set to an e-mail address,
		Postfix sends a blind carbon copy of all incoming and outgoing e-mails to
		this address. This results in an archiving of all e-mails. As standard
		the variable is not set. If there is no mailbox for this address, one
		will be created automatically.
	  </para>
	  <para>
		Postfix must then be restarted.
	  </para>
	</section>

	<section id="mail::serverconfig::softbounce">
	  <title>Configuration of soft bounces</title>
	  <para>
		If a number of error situations (e.g., for non-existent users) the
		result may be a mail bounce, i.e., the mail cannot be delivered and is
		returned to the sender. When &ucsUCRV; <envar>mail/postfix/softbounce</envar> is set
		to <literal>yes</literal> e-mails are never returned after a bounce, but instead
		are held in the queue. This setting is particularly useful during
		configuration work on the mail server.
	  </para>
	</section>

	<section id="mail::renamedusers">
	  <title>Handling of mailboxes during e-mail changes and the deletion of user accounts</title>
	  <para>
		A user's mailbox is linked to the primary e-mail address and not to
		the user name. The &ucsUCRV; <envar>mail/cyrus/mailbox/rename</envar> can be used to
		configure the reaction when the primary e-mail address is changed:
	  </para>
		<itemizedlist>
		  <listitem>
			<para>
			  If the variable is set to <literal>yes</literal>, the name of
			  the user's IMAP mailbox is changed. This is the standard setting since UCS 3.0.
			</para>
		  </listitem>
		  <listitem>
			<para>
			  If the setting is <literal>no</literal>, it will not be
			  possible to read previous e-mails any more once the user's primary e-mail
			  address is changed! If another user is assigned a previously used primary
			  e-mail address, she receives access to the old IMAP structure of this mailbox.
			</para>
		  </listitem>
		</itemizedlist>
	  <para>
		The &ucsUCRV; <envar>mail/cyrus/mailbox/delete</envar> can be used to configure, whether
		the IMAP mailbox is also deleted when a user account is deleted. In
		the basic setting, the mailboxes are kept when a user account is
		deleted.
	  </para>
	</section>

	<section id="mail::homeserver">
	  <title>Distribution of an installation on several mail servers</title>
	  <para>
		The UCS mail system offers the possibility of distributing users across
		several mail servers. To this end, each user is assigned a so-called mail home
		server on which the user's mail data are stored. When delivering an e-mail, the
		responsible home server is automatically determined from the LDAP directory.
	  </para>
	  <para>
		It must be observed that global IMAP folders (see <xref
		linkend="mail::management::sharedfolder"/>) are assigned to a mail home server.
	  </para>
	  <para>
		The Cyrus Murder expansion is provided for the implementation of a
		mailbox cluster.
	  </para>
	</section>
  </section>

  <section id="mail:clients">
  	<title>Configuration of mail clients for the mail server</title>

	<para>
	  The use of IMAP is recommended for using a mail client with the UCS mail server. STARTTLS is
	  used to switch to a TLS-secured connection after an initial negotiation phase when using SMTP
	  (for sending mail) and IMAP (for receiving/synchronising mail). <emphasis>Password (plain
	  text)</emphasis> should be used in combination with <emphasis>STARTTLS</emphasis> as the
	  authentication method. The method may have a different name depending on the mail client.
	  The following screenshot shows
	  the setup of Mozilla Thunderbird as an example.
	</para>

  	<para>
  	  <figure id="mail:clients:thunderbird">
  		<title>Setup of Mozilla Thunderbird</title>
  		<graphic scalefit="1" align="center" width="80%" fileref="illustrations40/thunderbird_en.png"/>
  	  </figure>
  	</para>
  </section>

  <section id="mail::horde">
	<title>Webmail and administration of e-mail filters with Horde</title>
	<para>
	  UCS integrates a number of applications from the Horde framework for
	  web access to e-mails and web-based administration of server-side e-mail filter
	  rules based on SIEVE. Horde can be installed via the Univention App Center (see <xref
	  linkend="software:appcenter"/>).
	</para>
	<section id="mail:Login_and_overview">
	  <title>Login and overview</title>
	  <para>
		The Horde login mask is linked on the system overview page (see <xref
		linkend="central-management-umc:login"/>) under <guimenu>Horde web client</guimenu> and can
		be opened directly at <uri>http://SERVERNAME/horde/login.php</uri>.
	  </para>
	  <para>
		<figure id="horde-login">
		  <title>Login on Horde</title>
		  <graphic scalefit="1" align="center" width="35%" fileref="illustrations40/login_en.png"/>
		  </figure>
	  </para>
	  <para>
		Either the UCS user name or the primary e-mail address can be used as the user name. The
		webmail interface can be used in a number of display modes. The preferred version can be
		selected under <guimenu>Mode</guimenu>. We recommend the use of the dynamic interface for
		standard workstations. The remaining documentation refers to this version. Selecting the
		<guimenu>Language</guimenu> has no effect in many web browsers, as the browser's preferred
		language settings take precedence.
	  </para>
	  <para>
		In the top toolbar there are a number or menu points (e.g., <guimenu>Mail</guimenu> and
		<guimenu>Address Book</guimenu>), which can be used to switch between the individual
		modules.
	  </para>
	  <para>
		The user can personalise Horde by clicking the cog symbol.
	  </para>
	</section>

	<section id="mail:Web-based_mail_access">
	  <title>Web-based mail access</title>
	  <para>
		Horde offers all the standard functions of an e-mail client such as the
		sending, forwarding and deletion of e-mails. E-mails can be sorted in folders
		and are stored in <guimenu>Inbox</guimenu> as standard. A <emphasis>Sent</emphasis>
		folder is created automatically the first time an e-mail is sent.
	  </para>
	  <para>
		<figure id="horde-inbox">
		  <title>Web mail (Inbox)</title>
		  <graphic scalefit="1" width="95%" fileref="illustrations40/inbox_en.png"/>
		  </figure>
	  </para>
	  <para>
		Horde differentiates between two types of deletion: An e-mail deleted with
		<guimenu>Delete</guimenu> is initially moved to the <emphasis>Trash</emphasis> folder. From
		there, it can be moved into any other folder as long as the trash can has not been emptied
		with <guimenu>Empty</guimenu>.
	  </para>
	</section>

	<section id="mail:Address_book">
	  <title>Address book</title>
	  <para>
		This module is used to administrate e-mail addresses and additional contact
		information. The information compiled here are saved in Horde's own SQL
		database.
	  </para>
	  <figure id="horde-address">
		<title>Address book for webmail</title>
		<graphic scalefit="1" width="100%" fileref="illustrations40/addressbook_en.png"/>
	  </figure>
	  <para>
		Contact information found using the simple or advanced search can then be
		copied into individual address books and edited there. New contacts can be
		entered via the <guimenu>New Contact</guimenu> menu item. Personal address books
		can also be created via <guimenu>My Address Books</guimenu>.
	  </para>
	  <para>
		The <guimenu>Browse</guimenu> menu item can be used to display the contents of
		address books. The lists can be sorted alphabetically by clicking on the
		preferred column title (surname, first name, etc.). Clicking on the magnifying
		glass in the header of the respective address book (directly next to the name
		of the address book) opens a search field that can be used easily to search
		within the open address book. Individual addresses in a list can be marked
		with an X for subsequent use, i.e., to export them as a file in a certain file
		format or to copy them into another address book.
	  </para>
	</section>

	<section id="mail::horde::filter">
	  <title>E-mail filters</title>
	  <para>
		Cyrus supports server-side filter scripts written in an individual
		script language called SIEVE. The filter module allows the generation
		of these filter scripts. They apply generally and thus also apply for
		users accessing their inboxes via a standard mail client.
	  </para>
	  <figure id="horde-filter">
		<title>Filter management in Horde</title>
		<graphic scalefit="1" width="100%" fileref="illustrations40/filter_en.png"/>
	  </figure>
	  <para>
		Filters can be edited and expanded
		under <guimenu>Mail &ar; Filters</guimenu>. The filters are applied to incoming e-mails
		in the consecutively numbered order. Their position can be altered either
		using the arrows to the right or by entering a number in
		the <command>Move</command> column directly. Individual filter rules can be
		switched on and off in the <command>Enabled</command> column.
	  </para>
	  <para>
		The <guimenu>Spam</guimenu> filter can be used user-specifically to set which spam
		threshold should apply. The specified <guimenu>Spam Level</guimenu> is the
		SpamAssassin threshold. An e-mail which returns this value will be sent to
		the specified folder.
	  </para>
	  <para>
		A <guimenu>Vacation</guimenu> filter can be used to specify a period in which
		incoming e-mails are automatically replied to with an answer e-mail by the
		mail server. The text and subject of the e-mail can be selected as required.
	  </para>
	  <para>
		<guimenu>New Rule</guimenu> can be used to create new rules, e.g., for
		the automatic sorting of incoming mails into topic-specific mail folders.
	  </para>
	  <para>
		Clicking on <guimenu>Script</guimenu> displays the source text of the generated
		SIEVE script.
	  </para>
	</section>
  </section>

</chapter>
