<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE chapter [
	<!ENTITY % extensions SYSTEM "../stylesheets/macros.ent" >
	<!ENTITY % DocBookDTD PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
	"http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd">
	<!ENTITY % entities SYSTEM "../stylesheets/macros-de.ent" >
	%extensions;
	%DocBookDTD;
	%entities;
]>
<chapter id="idmcloud">
  <title>Identity Management Anbindung an Cloud-Dienste</title>
  <section id="idmcloud:general">
	<title>Einführung</title>
	<para>
		UCS bietet ein integriertes Identity Management System. Über Univention Management Console können bspw. Benutzer,
		oder Gruppen sehr einfach administriert werden. Abhängig von den installierten Diensten stehen diese
		Identitäten über unterschiedliche Schnittstellen bereit, bspw. via LDAP.
	</para>
	<para>
		Mit Hilfe von bereitgestellten Erweiterungen, sogenannten Apps, kann das Managementsystem so erweitert werden, dass
		Benutzer oder Benutzergruppen auch direkt in Cloud-Dienste repliziert werden. Im App Center sind u.a. Erweiterung für
		Microsoft Office 365 oder G Suite vorhanden.
	</para>
	<para>
		Dank Single Sign-On (SSO) können sich die Benutzer mit ihrem gewohnten Passwort anmelden und anschließend sofort online
		in der Cloud arbeiten. Dabei bleibt das Passwort im Unternehmensnetzwerk und wird nicht zum Cloud Dienst übertragen.
	</para>
	<para>
		Im folgenden Kapitel ist die Einrichtung des Microsoft Office 365 Connector beschrieben.
	</para>
  </section>

  <section id="idmcloud:o365">
	<title>Microsoft Office 365</title>
	<para>
		Der Microsoft Office 365 Connector ermöglicht die Synchronisation der Benutzer und Gruppen zu einer Azure Active
		Directory Domäne, welche von Office 365 verwendet wird.Dabei lässt sich steuern, welche der in UCS angelegten
		Benutzerkonten Office 365 verwenden dürfen. Die so ausgewählten Benutzer werden entsprechend von UCS in die Azure Active
		Directory Domäne provisiert. Es kann dabei konfiguriert werden, welche Attribute synchronisiert werden und Attributte
		können dabei sogar anonymisiert werden.
	</para>

	<para>
		Die Anmeldung an Office 365 erfolgt über die SAML-SSO-Integration von UCS, d.h. die Authentifizierung erfolgt gegen den
		UCS Server und es werden keine Passwort-Hashes zu Microsofts Azure Cloud übertragen. UCS und Microsoft Azure Active
		Directory müssen dafür keine direkte Verbindung herstellen können, da die Authentifikation ausschließlich über den
		Webbrowser des Clients erfolgt. Dieser sollte aber die DNS-Namen der UCS-Domäne auflösen können, das ist insbesondere
		für Mobilgeräte wichtig zu beachten.
	</para>

	<section id="idmcloud:o365:setup">
		<title>Einrichtung</title>
		<para>
			Für den Einsatz des Microsoft Office 365 Connectors wird ein Microsoft Office 365 Administratorkonto, ein entsprechendes
			Konto im Azure Active Directory sowie eine von Microsoft
			<ulink url="https://azure.microsoft.com/de-de/documentation/articles/active-directory-add-domain/">verifizierte
			Domäne</ulink> benötigt. Die ersten beiden werden zu Testzwecken kostenlos von Microsoft bereitgestellt. Für das
			Konfigurieren des SSO wird jedoch eine eigene Internet-Domäne benötigt, in der TXT‑Records erstellt werden können.
		</para>

		<para>
			Falls noch keine Microsoft Office 365 Subskription vorhanden ist, so kann diese via <ulink url="http://www.office.com"/>
			im Bereich <guimenu>kostenlos testen für Unternehmen</guimenu> konfiguriert werden. Mit einem privaten Microsoft Konto
			ist eine Verbindung nicht möglich.
		</para>

		<para>
			Anschließend sollte eine Anmeldung mit einem <guimenu>Office 365 Administratorkonto</guimenu> im Office 365 Admin Center erfolgen. Im
			der linken Navigationsleiste ganz unten ist <guimenu>Azure AD</guimenu> auszuwählen, welches in einem neuen Fenter das
			<guimenu>Azure Management Portal</guimenu> öffnet.
		</para>

		<para>
			Unter dem Menüpunkt <guimenu>Domänen</guimenu> kann nun die eigene Domäne hinzugefügt und verifiziert werden. Dafür wird
			es notwendig sein, einen TXT-Record im DNS der eigenen Domäne zu erzeugen. Dieser Vorgang kann einige Minuten in
			Anspruch nehmen. Nun sollte der <guimenu>Status</guimenu> der konfigurierten Domäne als
			<guimenu>überprüft</guimenu> angezeigt werden.
		</para>

		<para>
			Nun kann die Microsoft Office 365 App aus dem App Center auf dem UCS System installiert werden. Die Installation dauert
			nur wenige Minuten. Anschließend steht ein Einrichtungsassistent (Wizard) für die Einrichtung zur Verfügung.
			Mit Abschluss des Einrichtungsassistenten ist die Installation abgeschklossen und der Connector ist einsatzbereit.
		</para>
	</section>

	<section id="idmcloud:o365:config">
		<title>Konfiguration</title>
		<para>
			Nach der Einrichtung über durch den Einrichtungsassistenten kann auf dem Reiter <guimenu>Office 365</guimenu>
			konfiguriert werden, dass dieser Benutzer ins Office 365 provisioniert wird. Der Verbrauch und die Zuweisung von
			Lizenzen ist im Office 365 Admin Center zu erkennen.
		</para>

		<para>
			Wird eine Änderung am Benutzer durchgeführt, so werden die Änderungen auch im Office 365 synchronisiert. Es erfolgt
			keine Synchronisation aus dem Azure Active Directory in das UCS System. Das bedeutet Änderungen, die im Azure Active
			Directory oder Office Portal vorgeommen, können durch Änderungen an den gleichen Attributen in UCS unter Umständen
			wieder überschrieben werden.
		</para>

		<para>
			Aufgrund von  Sicherheitsrichtlinien des Azure Active Directory können keine Benutzer oder Gruppen im Azure AD
			währen der Synchronisation gelöscht werden. Sie werden lediglich deakiviert und umbeannt. Die Lizenzen werden im Azure
			Active Directory entzogen, so dass diese für andere Benutzer zur Veräfügung stehen. Benutzer und Gruppen, deren Namen
			mit <guimenu>ZZZ_deleted</guimenu> anfangen, können im Office 365 Admin Center gelöscht werden.
		</para>

		<para>
			Es ist notwendig in Office 365 ein Land für den Benutzer zu konfigurieren. Der Connector nutzt dafür die Angabe des
			LAndes aus den Kontaktdaten des Benutzer oder, wenn nicht gesetzt, die Einstellung des Servers. Mit Hilfe der &ucsUCRV;
			<envar>office365/attributes/usageLocation</envar> kan ein 2-Zeichen-Kürzel, bspw. DE vorgegeben werden.
		</para>

		<para>
			Über die &ucsUCRV; <envar>office365/attributes/sync</envar> wird konfiguriert, welche LDAP Attribute (z. B. Vorname, Nachname, etc.)
			eines Benutzerkontos synchronisiert werden. Es handelt sich um eine kommaseparierte Liste von LDAP Attributen. Die Liste
			kann entsprechend an die Bedürfnisse angepasst werden.
		</para>

		<para>
			Mit der &ucsUCRV; <envar>office365/attributes/anonymize</envar> können kommasepariert LDAP Attribute angegeben werden,
			die zwar im Azure Active Directory angelegt, jedoch mit Zufallswerten gefüllt werden. Die &ucsUCRV;
			<envar>office365/attributes/static/.*</envar> erlauben das Füllen von Attributen auf Microsoft Seite mit einem
			vordefinierten Wert.
		</para>

		<para>
			Mit der &ucsUCRV; <envar>office365/attributes/never</envar> können kommasepariert LDAP Attribute angegeben werden, die
			nicht synchronisiert werden sollen, selbst wenn diese in <envar>office365/attributes/sync</envar> oder
			<envar>office365/attributes/anonymize</envar> auftauchen.
		</para>

		<para>
			Die &ucsUCRV; <envar>office365/attributes/mapping/.*</envar> definieren eine Abbildung der UCS LDAP Attribute zu Azure
			Attributen. Diese Variablen müssen normalerweise nicht verändert werden. Die Synchronisation der Gruppen der
Office 365 Benutzer kann mit der &ucsUCRV; <envar>office365/groups/sync</envar> aktiviert werden.
		</para>

		<para>
			Änderungen an UCR Variablen werden erst nach dem Neustart des Univention Directory Listener umgesetzt.
		</para>


	</section>

	<section id="idmcloud:o365:debug">
		<title>Fehlersuche</title>
		<para>
			Meldungen wärhrend der Einrichtung werden in der folgende Logdatei
			<filename>/var/log/univention/management-console-module-office365.log</filename> protokolliert.
		</para>

		<para>
			Bei Synchronisationsproblemen sollte die Logdatei des Univention Directory Listener geprüft werden:
			<filename>/var/log/univention/listener.log</filename>. Mit Hilfe der &ucsUCRV; <envar>office365/debug/werror</envar>
			kann ensprechend mehr Debug aktiviert werden.
		</para>

	</section>
  </section>

</chapter>
