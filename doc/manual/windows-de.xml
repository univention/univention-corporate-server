<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE chapter [
	<!ENTITY % extensions SYSTEM "../stylesheets/macros.ent" >
	<!ENTITY % DocBookDTD PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
	"http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd">
	<!ENTITY % entities SYSTEM "../stylesheets/macros-de.ent" >
	%extensions;
	%DocBookDTD;
	%entities;
]>
<chapter id="windows:Services_fuer_Windows">
  <title>Services für Windows</title>
  <section id="windows:general">
	<title>Einführung</title>
	<para>
	  UCS kann Active Directory (AD) Dienste anbieten, Mitglied einer Active Directory-Domäne sein oder
	  Objekte zwischen Active Directory-Domänen und einer UCS-Domäne synchronisieren.
	</para>
	<para>
	  Aus Sicht von Windows-Systemen kann UCS die Aufgaben von Windows-Serversystemen übernehmen:
	</para>

	<itemizedlist>
	  <listitem><simpara>
		Domänencontrollerfunktionalität / Authentifizierungsdienste
	  </simpara></listitem>

	  <listitem><simpara>
		Dateidienste
	  </simpara></listitem>

	  <listitem><simpara>
		Druckdienste
	  </simpara></listitem>
	</itemizedlist>

	<para>
	  Alle diese Dienste werden in UCS durch die Software Samba bereitgestellt.
	</para>

	<para>
	  UCS unterstützt zusätzlich die weitgehend automatische Migration einer bestehenden Microsoft Active
	  Directory Domäne zu UCS. Dabei werden alle Benutzer, Gruppen, Rechnerobjekte und
	  Gruppenrichtlinien übernommen ohne das die Windows-Clients erneut der Domäne beitreten
	  müssen. Dies ist in <xref linkend="windows:adtakeover"/> beschrieben.
	</para>

	<para>
	  Microsoft Active Directory-Domänencontroller können aktuell nicht einer UCS-Samba-Domäne
	  beitreten. Diese Funktionalität ist zu einem späteren Zeitpunkt geplant.
	</para>

	<para>
	  Samba kann zum jetzigen Zeitpunkt noch nicht einem Active Directory Forest beitreten.
	</para>

	<para>
	  Eingehende Vertrauensstellungen mit anderen Active Directory Domänen sind konfigurierbar.
	  In dieser Konstellation vertraut die externe Active Directory Domäne den
	  Authentifizierungsentscheidungen der UCS-Domäne (Windows vertraut UCS), so dass sich
	  Benutzer auch an Systemen und Active Directory basierten Diensten
	  in der Windows-Domäne anmelden können (siehe <xref linkend="windows_trust"/>).
	  Ausgehende Vertrauensstellungen mit Active Directory Domänen (UCS vertraut Windows)
	  sind aktuell nicht unterstützt.
	</para>

	<note><para>
	  Die Nutzung von UCS als Windows NT-kompatiblen Domänencontroller ist seit UCS 4.3 nicht mehr
	  unterstützt.
	</para></note>

  </section>

  <section id="windows:addomain">
	<title>Betrieb einer Samba-Domäne auf Basis von Active Directory</title>

	<section id="windows:setup4">
	  <title>Installation</title>

	  <para>
		Samba als AD-Domänencontroller kann auf allen UCS Directory Nodes mit der Applikation
		<emphasis>Active Directory-kompatibler Domänencontroller</emphasis> aus dem Univention App
		Center installiert werden. Alternativ kann das Softwarepaket
		<package>univention-samba4</package> installiert werden. Auf den Systemrollen &ucsPrimaryDN;
		und &ucsBackupDN; muss zusätzlich <package>univention-s4-connector</package> installiert
		werden (anschließend muss der Befehl <command>univention-run-join-scripts</command>
		aufgerufen werden). Weitere Informationen finden sich in <xref
		linkend="computers::softwaremanagement::installsoftware"/>.
	  </para>

	  <para>
		Ein Datei- und Druckserver kann auf UCS Managed Nodes mit der Applikation
		<emphasis>Windows-kompatibler Fileserver</emphasis> aus dem Univention App Center
		installiert werden. Alternativ kann das Softwarepakete <package>univention-samba</package>
		installiert werden (anschließend muss der Befehl
		<command>univention-run-join-scripts</command> aufgerufen werden). Weitere Informationen
		finden sich in <xref linkend="computers::softwaremanagement::installsoftware"/>.
	  </para>

	  <para>
		Samba unterstützt auch den Betrieb als <emphasis>read-only domain controller</emphasis>. Die
		Einrichtung ist in <biblioref linkend="ext-doc-win"/> dokumentiert.
	  </para>
	</section>

	<section id="windows:samba4:services">
	  <title>Dienste einer Samba-Domäne</title>

	  <section id="windows:samba4:services:auth">
		<title>Authentifizierungsdienst</title>

		<para>
		  Benutzeranmeldungen können nur auf Microsoft Windows-Systemen erfolgen, die der
		  Samba-Domäne beigetreten sind. Der Domänenbeitritt  ist in <xref
		  linkend="windows-domaenenbeitritt"/> dokumentiert.
		</para>

		<para>
		  Benutzer, die sich an einem Windows-System anmelden erhalten bei der Anmeldung ein
		  Kerberos-Ticket, mit dem die weitere Authentifizierung durchgeführt wird. Mit diesem
		  Ticket wird dann auf die Ressourcen der Domäne zugegriffen.
		</para>

		<para>
		  Häufige Fehlerquellen bei fehlschlagenden Anmeldungen sind:

		  <itemizedlist>
			<listitem><simpara>
			  Für eine funktionierende Kerberos-Authentifizierung ist eine Synchronisation der
			  Systemzeiten zwischen Windows-Client und Domänencontroller zwingend erforderlich. In
			  der Grundeinstellung wird beim Systemstart die Systemzeit über NTP aktualisiert. Dies
			  kann mit dem Befehl <command>w32tm /resync</command> auch manuell erfolgen.
			</simpara></listitem>

			<listitem><simpara>
			  Während der Anmeldung müssen DNS-Service-Records aufgelöst werden. Der Windows-Client
			  sollte daher als DNS-Nameserver die IP-Adresse des Domänencontrollers verwenden.
			</simpara></listitem>
		  </itemizedlist>
		</para>

	  </section>

	  <section id="windows:samba4:fileservices">
		<title>Dateidienste / File-Server</title>

		<para>
		  Ein Dateiserver stellt zentral benötigte Dateien über das Netz bereit und ermöglicht es
		  unter anderem Benutzerdaten auf einem zentralen Server zu bündeln.
		</para>

		<para>
		  Die in UCS integrierten Dateidienste unterstützen eine Bereitstellung von Freigaben auf
		  Basis von <systemitem class="filesystem">CIFS</systemitem>/<systemitem class="filesystem">SMB</systemitem> (siehe <xref linkend="shares::general"/>). Sofern das unterliegende
		  Dateisystem Access Control Lists (ACLs) unterstützt (verwendbar bei <systemitem class="filesystem">ext3</systemitem>, <systemitem class="filesystem">ext4</systemitem> und <systemitem class="filesystem">XFS</systemitem>)
		  sind ACLs auch von Windows-Clients verwendbar.
		</para>

		<para>
		  Dateidienste können auch von Samba Active Directory-Domänencontrollern, d.h. auf UCS Directory Nodes bereitgestellt
		  werden. Generell wird in Samba-Umgebungen - analog zu den Microsoft-Empfehlungen für Active
		  Directory - empfohlen Domänencontroller- und Datei/Druckdienste zu trennen,
		  d.h. UCS Directory Nodes für die Anmeldung und Managed Nodes für Datei-/Druckdienste zu
		  verwenden. Dies stellt sicher, dass hohe Last auf einem Fileserver nicht zu Störungen im
		  Anmeldedienst führen. Für kleine Umgebungen, in denen keine Möglichkeit für den Betrieb
		  zweier Server gegeben ist, können Datei- und Druckdienste auch mit auf einem
		  Domänencontroller betrieben werden.
		</para>

		<para>
			Samba unterstützt das <systemitem class="protocol">CIFS</systemitem>-Protokoll und den Nachfolger <systemitem class="protocol">SMB2</systemitem>.
			Verwendet man einen Client, der <systemitem class="protocol">SMB2</systemitem> unterstützt (ab <systemitem class="osname">Windows Vista</systemitem>, also auch <systemitem class="osname">Windows 7/8</systemitem>), verbessert sich die
			Performance und die Skalierbarkeit.
		</para>

		<para>
		  Das Protokoll kann über die &ucsUCR;-Variable <envar>samba/max/protocol</envar>
		  konfiguriert werden. Sie muss auf allen Samba-Servern gesetzt und anschließend der/die
		  Samba-Server neu gestartet werden.

		  <itemizedlist>
			<listitem><simpara>
					<literal>NT1</literal> konfiguriert <systemitem class="protocol">CIFS</systemitem> (unterstützt von allen Windows-Versionen)
			</simpara></listitem>

			<listitem><simpara>
					<literal>SMB2</literal> konfiguriert <systemitem class="protocol">SMB2</systemitem> (unterstützt ab <systemitem class="osname">Windows Vista</systemitem>/<systemitem class="osname">Windows 7</systemitem>)
			</simpara></listitem>

			<listitem><simpara>
					<literal>SMB3</literal> konfiguriert <systemitem class="protocol">SMB3</systemitem> (unterstützt ab <systemitem class="osname">Windows 8</systemitem>)
			</simpara></listitem>
		  </itemizedlist>
		</para>
	  </section>


	  <section id="windows:samba4:services:print">
		<title>Druckdienste / Print-Server</title>
		<para>
		  Samba bietet die Möglichkeit, unter Linux eingerichtete Drucker als Netzwerkdrucker für
		  Windows-Clients freizugeben. Die Verwaltung der Druckerfreigaben und die Integration der
		  Druckertreiber ist in <xref linkend="print::general"/> beschrieben.
		</para>

		<para>
		  Druckdienste können auch mit Samba AD-Domänencontrollern bereitgestellt werden. Hierbei
		  sind die in <xref linkend="windows:samba4:fileservices"/> beschriebenen Einschränkungen zu
		  beachten.
		</para>
	  </section>


	  <section id="windows:s4connector">
		<title>Univention S4 Connector</title>
		<para>
		  Samba stellt einen separaten LDAP-Verzeichnisdienst bereit. Die Synchronisation zwischen
		  dem UCS-LDAP und dem Samba-LDAP erfolgt durch einen internen Systemdienst, den Univention
		  S4 Connector. Der Connector ist standardmäßig auf dem &ucsPrimaryDN; aktiviert und benötigt
		  normalerweise keine weitere Konfiguration.
		</para>

		<para>
		  Hinweise zum Status der Synchronisation finden sich in der Logdatei
		  <filename>/var/log/univention/connector-s4.log</filename>. Weitere Informationen zur
		  Fehleranalyse von eventuellen Connectorproblemen finden sich in <u:sdb>1235</u:sdb>.
		</para>

		<para>
		  Mit dem Befehl <command>univention-s4search</command> kann im Samba-Verzeichnisdienst
		  gesucht werden. Wird es als Benutzer <systemitem class="username">root</systemitem> aufgerufen,
		  werden automatisch die nötigen Credentials des Maschinenkontos verwendet:

		  <programlisting>
root@primary:~# univention-s4search sAMAccountName=Administrator
# record 1
dn: CN=Administrator,CN=Users,DC=example,DC=com
objectClass: top
objectClass: person
objectClass: organizationalPerson
objectClass: user
cn: Administrator
instanceType: 4
(..)
		  </programlisting>
		</para>
	  </section>


	  <section id="windows:multimaster">
		<title>DRS-Replikation der Verzeichnisdaten</title>

		<para>
		  Samba/AD-Domänen verwenden das Directory Replication System (DRS) zur Replikation der
		  Verzeichnisdaten. DRS erlaubt Multimasterreplikation, d.h. die schreibenden Änderungen
		  mehrerer Samba/AD-Domänencontroller werden auf Protokollebene synchronisiert. Die Verwendung von
		  Snapshots in Virtualisierungslösungen sollte daher beim Einsatz von Samba/AD vermieden und
		  Samba/AD auf einem Server betrieben werden, der durchgehend eingeschaltet bleibt.
		</para>

		<para>
		  Mit jedem weiteren Samba/AD-Domänencontroller steigt die Komplexität der
		  Multimasterreplikation. Es sollte daher geprüft werden, ob weitere
		  Samba/AD-Domänencontroller auf Basis von UCS Directory Nodes nötig sind
		  oder für neue Server nicht ein UCS Managed Node die bessere Wahl ist.
		</para>

		<para>
			Hinweise zur Analyse von DRS-Replikationsproblemen finden sich in <u:sdb>1235</u:sdb>.
		</para>
	  </section>


	  <section id="windows:sysvolshare">
		<title>Synchronisation der SYSVOL-Freigabe</title>
		<para>
		  Die SYSVOL-Freigabe ist eine Freigabe, die in Active Directory/Samba Gruppenrichtlinien
		  und Anmeldeskripte bereitstellt. Sie wird zwischen allen Domänencontrollern synchronisiert
		  und im Verzeichnis <filename class="directory">/var/lib/samba/sysvol/</filename> gespeichert.
		</para>

		<para>
		  In Microsoft Active Directory wird die SYSVOL-Freigabe durch den File Replication Service
		  (eingeführt mit Windows 2000), bzw. durch das Distributed File System (ab <systemitem class="osname">Windows 2008 R2</systemitem>)
		  synchronisiert. Diese Replikationsmethoden sind in Samba noch nicht vollständig
		  implementiert. Die Synchronisation zwischen den Samba/AD-Domänencontrollern erfolgt in UCS
		  durch einen Cron-Job (standardmäßig alle fünf Minuten, konfigurierbar durch die &ucsUCRV;
		  <envar>samba4/sysvol/sync/cron</envar>.
		</para>
	  </section>
	</section>


	<section id="windows:samba4:desktopmanagement">
	  <title>Konfiguration und Management von Windows-Desktops</title>

	  <section id="gruppenrichtlinien">
		<title>Gruppenrichtlinien</title>

		<section id="gpo:intro">
		  <title>Einführung</title>

		  <para>
			Gruppenrichtlinien sind eine Active Directory-Funktion, die die zentrale Konfiguration von
			Vorgaben für Rechner und Benutzer erlaubt. Gruppenrichtlinien werden auch von
			Samba/AD-Domänen unterstützt. Die Richtlinien greifen nur auf Windows-Clients; Linux- oder
			Mac OS-Systeme werten die Richtlinien nicht aus.
		  </para>

		  <para>
			Gruppenrichtlinien werden ausgehend von der englischen Bezeichnung <emphasis>Group policy
			objects</emphasis> auch oft als GPOs bezeichnet. Genauer gesagt kann ein
			Gruppenrichtlinienobjekt eine Reihe von Richtlinien beinhalten. Trotz ihres Namens
			lassen sich Gruppenrichtlinienobjekte nicht direkt bestimmten Benutzergruppen zuweisen,
			sondern sie werden vielmehr mit bestimmten AD-Verwaltungseinheiten (Domänen, Sites oder
			Organisationseinheiten) im Samba-Verzeichnisdienst (Samba AD/DS) verknüpft und beziehen
			sich dadurch auf untergeordnete Objekte. Eine gruppen- oder benutzerspezifische
			Auswertung ist nur indirekt über die <emphasis>Sicherheitseinstellungen</emphasis> eines
			Gruppenrichtlinienobjekts möglich, in denen sich das Recht <emphasis>Gruppenrichtlinie
			übernehmen</emphasis> gezielt auf bestimmte Gruppen, Benutzer oder Computer einschränken
			lässt.
		  </para>

		  <para>
			Grundsätzlich sind die <emphasis>Gruppenrichtlinien</emphasis> (<foreignphrase>Group
			Policies</foreignphrase> (GPO)) von den sehr ähnlich benannten
			<emphasis>Gruppenrichtlinieneinstellungen</emphasis> (<foreignphrase>Group Policy
			Preferences</foreignphrase> (GPP)) zu unterscheiden:
			<itemizedlist>
			  <listitem><simpara>
		        Die über <emphasis>Gruppenrichtlinien</emphasis> (GPOs) getroffenen Vorgaben sind
				bindend, während sich über <emphasis>Gruppenrichtlinieneinstellungen</emphasis>
				(GPPs) nur Präferenzen in die Registry von Windows-Clients eintragen lassen, die
				aber unter Umständen am Client überschrieben werden können.
			  </simpara></listitem>

			  <listitem><simpara>
		        Die über <emphasis>Gruppenrichtlinien</emphasis> (GPOs) getroffenen Vorgaben werden
				zudem dynamisch auf die Zielobjekte angewendet, wo hingegen die über
				<emphasis>Gruppenrichtlinieneinstellungen</emphasis> (GPPs) getroffenen
				Einstellungen statisch in die Registry von Windows-Clients eintragen werden (man
				spricht hier auch von <phrase>Tattooing</phrase>).
			  </simpara></listitem>
			</itemizedlist>
		    Aus diesen Gründen sind <emphasis>Gruppenrichtlinien</emphasis> (GPOs) in den meisten
			Fällen den <emphasis>Gruppenrichtlinieneinstellungen</emphasis> (GPPs)
			vorzuziehen. Dieses Kapitel bezieht sich im weiteren ausschließlich auf
			<emphasis>Gruppenrichtlinien</emphasis> (GPOs).
		  </para>

		  <para>
			Gruppenrichtlinien werden im Gegensatz zu den UCS-Richtlinien (siehe <xref
			linkend="central:policies"/>) nicht in &ucsUMC;, sondern mit einem  separaten Editor
			konfiguriert, mit der <emphasis>Gruppenrichtlinienverwaltung</emphasis>, die Teil der
			<foreignphrase>Remote Server Administration Tools</foreignphrase> (RSAT) ist. Die Einrichtung ist
			in <xref linkend="gpo:install"/> dokumentiert.
		  </para>

		  <para>
			Es existieren zwei Arten von Richtlinien:

			<itemizedlist>
			  <listitem><simpara>
				<emphasis>Benutzerrichtlinien</emphasis> konfigurieren die Einstellungen eines
				Benutzers, z.B. die Vorkonfiguration des Desktops. Auch Anwendungen können über Gruppenrichtlinien konfiguriert
				werden (z.B. die Startseite des Microsoft Internet Explorers oder Einstellungen in LibreOffice).
			  </simpara></listitem>

			  <listitem><simpara>
				<emphasis>Computer-Richtlinien</emphasis> definieren die Einstellungen von
				Windows-Clients.
			  </simpara></listitem>
			</itemizedlist>
		  </para>

		  <para>
			Computerrichtlinien werden erstmals beim Systemstart ausgewertet, Benutzerrichtlinien bei
			der Anmeldung. Die Richtlinien werden auch für angemeldete Benutzer/laufende Systeme
			fortlaufend ausgewertet und aktualisiert (in der Grundeinstellung alle 90-120 Minuten,
			der Zeitraum wird zur Vermeidung von Lastspitzen nach dem Zufallsprinzip variiert).
		  </para>

		  <para>
			Die Auswertung der Gruppenrichtlinien kann durch Aufruf des Befehls
			<command>gpupdate /force</command> auch gezielt gestartet werden.
		  </para>

		  <para>
			Einige Richtlinien - z.B. zur Installation von Software oder für Anmeldeskripte - werden
			nur bei der Anmeldung (Benutzerrichtlinien) oder beim Systemstart (Rechnerrichtlinien)
			ausgewertet.
		  </para>

		  <para>
			Die meisten Gruppenrichtlinien setzen nur einen Wert in der Windows-Registry, der dann
			von Windows oder einer Applikation ausgewertet wird. Da Standardbenutzer keine
			Einstellungen in dem entsprechenden Teil der Windows Registry editieren können, können so auch eingeschränkte
			Benutzer-Desktops konfiguriert werden, in denen z.B. Benutzer den Windows Task Manager
			nicht aufrufen dürfen.
		  </para>

		  <para>
			Die Gruppenrichtlinien werden in der SYSVOL-Freigabe gespeichert, siehe <xref
			linkend="windows:sysvolshare"/>. Verknüpft mit Benutzer- und Rechnerkonten werden sie im
			Samba-Verzeichnisdienst.
		  </para>

		</section>

		<section id="gpo:install">
		  <title>Installation der Gruppenrichtlinienverwaltung</title>

		  <para>
			Die Gruppenrichtlinienverwaltung kann als Teil der
			<emphasis>Remote Server Administration Tools</emphasis> auf Windows Clients installiert werden.
			Sie können für Windows 7 unter
			<footnote><para><ulink url="http://www.microsoft.com/en-us/download/details.aspx?id=7887"/></para></footnote>,
			für Windows 8 unter
			<emphasis>Remote Server Administration Tools (RSAT) for Windows 8</emphasis>
			<footnote><para><ulink url="http://www.microsoft.com/de-de/download/details.aspx?id=28972"/></para></footnote>
			oder für Windows 10 unter
			<emphasis>Remote Server Administration Tools (RSAT) for Windows 10</emphasis>
			<footnote><para><ulink url="https://www.microsoft.com/en-us/download/details.aspx?id=45520"/></para></footnote>
			bezogen werden.
		  </para>

			<figure id="windows:gpo:activate"><title>Aktivierung der Gruppenrichtlinienverwaltung</title>
			<graphic scalefit="1" width="90%" align="center" fileref="illustrations50/gpo-activate-de.png"/>
			</figure>

		  <para>
			Nach der Installation muss die Gruppenrichtlinienverwaltung in der Windows-Systemsteuerung
			noch aktiviert werden, in dem unter <guimenu>Start &ar; Systemsteuerung &ar; Programme &ar;
			Windows-Funktionen aktivieren und deaktivieren &ar; Remoteserver-Verwaltungstools &ar;
			Featureverwaltungs-Tools</guimenu> die Option <guimenu>Tools für die
			Gruppenrichtlinienverwaltung</guimenu> aktiviert wird.
		  </para>

		  <para>
			Nach der Aktivierung kann die Gruppenrichtlinienverwaltung unter <guimenu>Start &ar;
			Verwaltung &ar; Gruppenrichtlinienverwaltung</guimenu> aufgerufen werden.
		  </para>

		</section>

		<section id="gpo:config">
		  <title>Konfiguration von Richtlinien mit der Gruppenrichtlinienverwaltung</title>

		  <para>
			Gruppenrichtlinien können nur von Benutzern konfiguriert werden, die Mitglied der Gruppe
			<systemitem class="groupname">Domain Admins</systemitem> sind (z.B. der
			<systemitem class="username">Administrator</systemitem>). Bei der Anmeldung muss beachtet werden, dass keine
			Anmeldung mit dem lokalen Administrator-Konto erfolgt, sondern mit dem
			Administrator-Konto der Domäne. Die Gruppenrichtlinienverwaltung kann auf einem beliebigen
			System der Domäne aufgerufen werden.
		  </para>

		  <para>
			Wenn mehr als ein Samba-Domänencontroller eingesetzt wird, muss die Replikation der
			GPO-Daten berücksichtigt werden, siehe <xref linkend="gpo:gposync"/>.
		  </para>
		  <para>
			Es gibt zwei prinzipielle Möglichkeiten GPOs zu erstellen:

			<itemizedlist>
			  <listitem><simpara>
				Sie können im <guimenu>Gruppenrichtlinienobjekte</guimenu>-Order angelegt und dann mit
				verschiedenen Positionen im LDAP verknüpft werden. Dies ist sinnvoll, wenn eine
				Richtlinie mit mehreren Positionen im LDAP verknüpft werden soll.
			  </simpara></listitem>

			  <listitem><simpara>
				Die GPO kann ad hoc an einer LDAP-Position erstellt und dabei direkt verknüpft
				werden. Für kleine und mittlere Domänen ist das der einfachere Weg. Auch ad hoc
				erstellte Domänen werden im  <guimenu>Gruppenrichtlinienobjekte</guimenu>-Ordner angezeigt.
			  </simpara></listitem>
			</itemizedlist>
		  </para>

		  <para>
			Eine Richtlinie kann drei Zustände annehmen; sie kann aktiviert,
			deaktiviert oder nicht gesetzt sein. Die Auswirkung bezieht sich immer auf die
			Formulierung der Richtlinie. Wenn diese beispielsweise <guimenu>Deaktiviere Feature
			xy</guimenu> heißt, muss die Richtlinie aktiviert werden um das Feature
			abzuschalten. Einige Richtlinien haben zusätzliche Optionen, z.B. könnte die Richtlinie
			<guimenu>Aktiviere Mail-Quota</guimenu> eine zusätzliche Option mitbringen um die
			Speichermenge zu verwalten.
		  </para>

			<figure id="windows:gpo:edit"><title>Bearbeiten einer Richtlinie</title>
			<graphic scalefit="1" width="80%" align="center" fileref="illustrations50/gpo-edit-policy-de.png"/>
			</figure>

		  <para>
			Zwei Standard-Richtlinienobjekte sind vordefiniert:

			<itemizedlist>
			  <listitem><simpara>
				Das <emphasis>Default Domain Policy</emphasis> Objekt kann verwendet werden, um globale
				Richtlinien für alle Benutzer und Rechner der gesamten Domäne zu konfigurieren.
			  </simpara></listitem>

			  <listitem><simpara>
				Das <emphasis>Default Domain Controllers Policy</emphasis> Objekt hat in einer Samba-Domäne
				keine Verwendung (in einer Microsoft AD-Domäne würden die Richtlinien für
				Microsoft-Domänencontroller über dieses Objekt erfolgen). Die Konfiguration der
				Samba-Domänencontroller erfolgt in UCS weitgehend über &ucsUCR;.
			  </simpara></listitem>
			</itemizedlist>
		  </para>

		  <para>
			AD-Domänen können in Sites strukturiert werden. Dies kann z.B. verwendet werden um
			Standorte in einer Domäne zu gruppieren. Im Hauptmenü der Gruppenrichtlinienverwaltung
			werden alle Sites aufgeführt. Dort findet sich auch eine Liste von Domänen. Die
			aktuellen Samba-Versionen unterstützen keine Forest-Domänen, so dass hier immer nur eine
			Domäne angezeigt wird.
		  </para>

		  <para>
			Eine Domäne kann in verschiedene Organisations-Einheiten (OUs) strukturiert werden. Dies kann z.B. verwendet
			werden, um die Mitarbeiter der Buchhaltung und die Benutzer der Verwaltung in
			unterschiedlichen LDAP-Positionen zu speichern.
		  </para>

		  <para>
			Gruppenrichtlinien können sich gegenseitig überlagern. Es gilt das Prinzip der
			Vererbung, d.h. höherliegende Richtlinien überschreiben die untergeordneten. Die
			effektiven Richtlinien für einen Benutzer können sowohl mit dem Modellierungsassistenten
			der Gruppenrichtlinienverwaltung als auch an der Windows-Kommandozeile mit dem Befehl
			<command>gpresult /user BENUTZERNAME /v </command> auf dem Windows-Client angezeigt
			werden:
		  </para>

			<figure id="windows:gpo:user"><title>Auswertung der GPO für den Benutzer <systemitem class="username">user01</systemitem></title>
			<graphic scalefit="1" width="80%" align="center" fileref="illustrations50/gpo-gpresult-de.png"/>
			</figure>

		  <para>
			Die Richtlinien werden in folgender Reihenfolge ausgewertet:

			<itemizedlist>
			  <listitem><simpara>
				Richtlinien der <emphasis>Default Domain Policy</emphasis> gelten als
				Grundeinstellung für alle Benutzer und Rechner der gesamten Domäne.
			  </simpara></listitem>

			  <listitem><simpara>
				Mit einer OU verknüpfte Richtlinien überschreiben Richtlinien aus der Default Domain
				Policy. Sind OUs weiter verschachtelt, greifen im Konfliktfall die jeweils "untersten"
				Richtlinien, d.h. die, die näher am Zielobjekt verknüpft sind. Es gilt folgende
				Auswertungsreihenfolge:
				</simpara>
				<itemizedlist>
				  <listitem><simpara>
					Zuweisung einer Richtlinie zu einer Active Directory-Site
				  </simpara></listitem>

				  <listitem><simpara>
					Vorgaben der Default Domain Policy
				  </simpara></listitem>

				  <listitem><simpara>
					Zuweisung einer Richtlinie zu einer Organisationseinheit / OU (jede
					unterliegende OU überstimmt wiederum Richtlinien aus übergeordneten OUs)
				  </simpara></listitem>
				</itemizedlist>
			  </listitem>
			</itemizedlist>
		  </para>

		  <para>
			Ein Beispiel: Eine Firma verbietet allgemein den Zugriff auf den Windows Task
			Manager. Dazu wird im <emphasis>Default Domain Policy</emphasis>-Objekt die Richtlinie
			<guimenu>Zugriff auf Task Manager unterbinden</guimenu> aktiviert. Für einige technisch
			versierte Benutzer soll der Task Manager dennoch verfügbar sein. Diese Benutzer sind
			in der OU <emphasis>Technik</emphasis> abgelegt. Nun wird ein zusätzliches
			Gruppenrichtlinienobjekt angelegt, in dem Richtlinie <guimenu>Zugriff auf Task Manager
			unterbinden</guimenu> auf <emphasis>deaktiviert</emphasis> gesetzt wird. Dieses neue GPO
			wird mit der OU <emphasis>Technik</emphasis> verbunden.
		  </para>

		</section>

		<section id="gpo:gposync">
		  <title>Konfiguration von Gruppenrichtlinien in Umgebungen mit mehr als einem
		  Samba-Domänencontroller</title>
		  <para>
			Eine Gruppenrichtlinie besteht technisch aus zwei Teilen: Zum einen gibt es ein
			Verzeichnis im Dateisystem der Domänencontroller, das die eigentlichen
			Richtlinien-Dateien enthält, die auf dem Windows-System umgesetzt werden sollen
			(gespeichert in der SYSVOL-Freigabe (siehe <xref linkend="windows:sysvolshare"/>)).
			Zum anderen gibt es ein gleichnamiges Objekt im LDAP-Baum des Samba-Verzeichnisdienstes
			(Samba AD/DS), das üblicherweise unter einem LDAP-Container namens <emphasis>Group
			Policy Objects</emphasis> abgelegt ist.
		  </para>

		  <para>
			Während die LDAP-Replikation zwischen Domänencontrollern innerhalb weniger Sekunden
			umgesetzt ist, werden die Dateien in der SYSVOL-Freigabe in der Grundeinstellung nur alle fünf Minuten
			repliziert. Es ist zu beachten, dass die Anwendung von neu konfigurierten
			Gruppenrichtlinien in diesem Zeitraum fehlschlagen kann, falls ein Client zufällig einen
			Domänencontroller konsultiert, der noch nicht die aktuellen Dateien zu sich repliziert
			hat.
		  </para>
		</section>

		<section id="gpo:adm">
			<title>Administrative Vorlagen (<acronym>ADMX</acronym>/<acronym>ADM</acronym>)</title>
		  <para>
			Die in der Gruppenrichtlinienverwaltung angezeigten Richtlinien können durch sogenannte <emphasis>Administrative
			Vorlagen</emphasis> erweitert werden. In einer solchen Vorlage wird definiert unter
			welchem Namen die Richtlinie in der Gruppenrichtlinienverwaltung erscheinen soll und welcher
			Wert dadurch in der Windows-Registry gesetzt wird. Administrative Vorlagen werden in
			sogenannten <emphasis>ADMX-Dateien</emphasis> (früher <emphasis>ADM-Dateien</emphasis>)
			gespeichert <biblioref linkend="admx-reference"/>. ADMX-Dateien bieten unter anderem
			den Vorteil, dass sie zentral über mehrere Domänencontroller bereitgestellt werden können, damit
			die Gruppenrichtlinienverwaltung an allen Windows-Clients die gleichen
			Konfigurationsmöglichkeiten zeigt <biblioref linkend="admx-central"/>.
		  </para>

		  <para>
			Das folgende Beispiel für eine ADM-Datei definiert eine Rechner-Richtlinie, in der ein
			Registry-Key des (fiktiven) Univention RDP-Client konfiguriert wird.
			ADM-Dateien können über Third-Party-Werkzeuge in das neuere ADMX-Format umgewandelt werden.
			Weiterführende Informationen zum Format von ADM-Dateien sind unter <biblioref
			linkend="microsoft-adm-templates"/> und <biblioref linkend="adm-templates-howto"/> zu
			finden. Die administrativen Vorlagen müssen die Dateiendung <filename class="extension">.adm</filename> verwenden:

			<programlisting language="sh">
CLASS MACHINE
CATEGORY "Univention"
POLICY "RDP-Client"
KEYNAME "Univention\RDP\StorageRedirect"
EXPLAIN "Ist diese Option aktiviert, wird Soundausgabe im RDP-Client aktiviert"
VALUENAME "Sound-Weiterleitung"
VALUEON "Aktiviert"
VALUEOFF "Deaktiviert"
END POLICY
END CATEGORY
			</programlisting>
		  </para>

			<figure id="windows:gpo:admin"><title>Die eingebundene administrative Vorlage</title>
			<graphic scalefit="1" width="80%" align="center" fileref="illustrations50/gpo-adm-template-de.png"/>
			</figure>

		  <para>
			Die ADM-Datei kann anschließend in das ADMX-Format umgewandelt oder aber direkt über die Gruppenrichtlinienverwaltung importiert
			werden. Dazu wird im Kontextmenü der <guimenu>Administrativen Vorlagen</guimenu> die
			Option <guimenu>Vorlagen hinzufügen &ar; entfernen</guimenu> aufgerufen. Mit
			<guimenu>Hinzufügen</guimenu> kann dann eine ADM-Datei importiert werden. Die
			administrativen Vorlagen werden ebenfalls in der SYSVOL-Freigabe gespeichert und
			repliziert, wodurch die Gruppenrichtlinienverwaltung von den Windows-Clients aus auf sie zugreifen kann.
		  </para>
		</section>

		<section id="gpo:wmifilter">
		  <title>Anwendung von Richtlinien auf Basis von Rechnereigenschaften (WMI-Filter)</title>
		  <para>
			Richtlinien können auch auf Basis von Systemeigenschaften konfiguriert werden. Diese
			Eigenschaften werden über die Windows Management Instrumentation-Schnittstelle (WMI)
			bereitgestellt. Der darauf aufbauende Mechanismus wird als <emphasis>WMI-Filterung</emphasis> bezeichnet.
			Damit ist es beispielsweise möglich eine Richtlinie nur auf PCs mit einer 64
			Bit-Prozessor-Architektur oder mit min. 8 GB RAM anzuwenden. Ändert sich eine
			Eigenschaft eines Systems (z.B. weil mehr Speicher eingebaut wurde), wird der jeweilige
			Filter automatisch vom Client neu ausgewertet.
		  </para>

		  <para>
			Die WMI-Filter werden in der Domänenstruktur im Container <guimenu>WMI-Filter</guimenu>
			angezeigt. Mit <guimenu>Neu</guimenu> kann ein weiterer Filter definiert werden. Unter
			<guimenu>Abfragen</guimenu> werden die Filterregeln definiert. Die Regeln werden in
			einer SQL-ähnlichen Syntax definiert. Regel-Beispiele finden sich in <biblioref
			linkend="microsoft-wmi-filter"/> und  <biblioref linkend="add-wmi-filters"/>.
		  </para>

		</section>

	  </section>

	  <section id="netlogon-freigabe:samba4">
		<title>Anmeldeskripte / NETLOGON-Freigabe</title>
		<para>
		  Die NETLOGON-Freigabe dient der Bereitstellung von Anmeldeskripten in Windows-Domänen. Die
		  Anmeldeskripte werden nach der erfolgreichen Anmeldung eines Benutzers ausgeführt und
		  ermöglichen die Anpassung der Arbeitsumgebung des Benutzers. Die Skripte müssen in einem
		  für Windows ausführbaren Format gespeichert werden, wie z.B. <filename class="extension">bat</filename>.
		</para>

		<para>
		  Die Anmeldeskripte werden unter
		  <filename class="directory">/var/lib/samba/sysvol/<replaceable>Domänenname</replaceable>/scripts/</filename> abgelegt und
		  werden unter dem Freigabennamen <emphasis>NETLOGON</emphasis> bereitgestellt. Die
		  NETLOGON-Freigabe wird im Rahmen der SYSVOL-Replikation repliziert.
		  Der Dateiname des Skripts muss relativ zu diesem Verzeichnis angegeben werden.
		</para>

		<para>
		  Das Anmeldeskript kann pro Benutzer zugewiesen werden, siehe <xref linkend="users::management"/>.
		</para>
	  </section>


	  <section id="windows:serverhome:samba4">
		<title>Konfiguration des Servers, auf dem das Heimatverzeichnis abgelegt wird</title>

		<para>
		  Das Heimatverzeichnis wird benutzerbezogen in &ucsUMC; definiert siehe <xref
		  linkend="users::management"/>. Dies erfolgt mit der Einstellung
		  <guimenu>Windows-Heimatverzeichnis</guimenu>,
		  z.B. <filename class="directory">\\ucs-file-server\meier</filename>.
		</para>

		<para>
		  Für das Zuweisen des Heimatverzeichnis-Servers an mehrere Benutzer auf einmal kann der
		  Mehrfachbearbeitungsmodus von &ucsUMC; verwendet  werden, siehe <xref
		  linkend="central:user-interface:edit"/>.
		</para>
	  </section>


	  <section id="windows:roamingprofiles:samba4">
		<title>Servergespeicherte Profile</title>

		<para>
		  Samba unterstützt servergespeicherte Profile, d.h. Einstellungen der Benutzer werden auf
		  einem Server gespeichert. In diesem Verzeichnis werden auch die Dateien gespeichert, die
		  der Benutzer im Ordner <emphasis>Eigene Dateien</emphasis> speichert. Sie werden
		  zwischenzeitlich lokal auf dem Windows-Rechner vorgehalten und erst bei der Abmeldung auf
		  den Samba-Server synchronisiert.
		</para>

		<para>
		  In Samba-Domänen mit Active Directory-Support werden in der Voreinstellung keine
		  serverseitigen Profile verwendet.
		</para>

		<para>
		  Das Profilverzeichnis kann über eine Gruppenrichtlinie konfiguriert werden, die unter
		  <guimenu>Computerkonfiguration &ar; Richtlinien &ar; Administrative Vorlagen &ar; System
		  &ar; Benutzerprofile &ar; Pfad des servergespeicherten Profils für alle Benutzer
		  festlegen</guimenu> zu finden ist. Wenn hier z.B. der UNC-Pfad
		  <filename class="directory">%LOGONSERVER%\%USERNAME%\windows-profiles\default</filename> eingetragen
		  wird, dann werden die Verzeichnisse <filename class="directory">windows-profiles\default.V<replaceable>?</replaceable>*</filename>
		  im Heimatverzeichnis des Benutzers auf dem jeweils gewählten Logonserver verwendet.
		</para>

		<para>
		  Alternativ kann das Profilverzeichnis individuell für einzelne Benutzerkonten definiert werden.
		  Das ist in der &ucsUMC; im Abschnitt <guimenu>Konto</guimenu> des Benutzerkontos über das Feld
		  <guimenuitem>Profilverzeichnis</guimenuitem> möglich.
		  Der entsprechende UDM-Attributname heißt <property>profilepath</property>.
		  Mit OpenLDAP als Backend wird dies im LDAP-Attribut <property>sambaProfilePath</property> gespeichert.
		</para>

		<para>
		  Wird der Profilpfad in &ucsUMC; geändert, wird ein neues Profilverzeichnis
		  angelegt. Die Daten aus dem alten Profilverzeichnis bleiben dabei erhalten und können
		  manuell in das neue Profilverzeichnis kopiert beziehungsweise verschoben
		  werden. Abschließend kann das alte Profilverzeichnis gelöscht werden.
		</para>

		<note>
		  <para>
			Der Administrator-Benutzer greift standardmäßig mit root-Berechtigungen auf Freigaben
			zu. Wenn dadurch das Profilverzeichnis mit root als Benutzer angelegt wird, sollte es
			manuell mit dem Befehl <command>chown</command> an den Administrator vergeben werden.
		  </para>
		</note>
	  </section>

	</section>

  </section>












<section id="ad-connector:general">
  <title>Active Directory-Verbindung</title>

  <section id="ad-connector:einfuehrung">
	<title>Einführung</title>

	<para>
	  &ucsUCS; kann auf zwei unterschiedliche Arten mit einer bestehenden Active Directory-Domäne (AD-Domäne) zusammen
	  betrieben werden. Beide Varianten lassen sich durch die Applikation <emphasis>Active Directory-Verbindung</emphasis> aus dem Univention App Center einrichten (siehe <xref linkend="computers::softwaremanagement::installsoftware"/>). Diese steht auf einem &ucsPrimaryDN; und &ucsBackupDN; zur Verfügung.
	</para>

	<para>
	  Die beiden Varianten sind:
	  <itemizedlist>
	    <listitem><simpara>
	      UCS als Teil (Domänen-Mitglied) einer AD-Domäne (siehe <xref linkend="ad-connector:ad-member-einrichtung"/>)
	    </simpara></listitem>
	    <listitem><simpara>
	      Synchronisation von Kontendaten zwischen einer AD-Domäne und einer UCS-Domäne (siehe <xref linkend="ad-connector:ad-connector-einrichtung"/>)
	    </simpara></listitem>
	  </itemizedlist>
	</para>

	<para>
	  In beiden Modi wird unter UCS der Active Directory-Verbindungsdienst verwendet (kurz UCS AD-Connector), der Verzeichnisdienstobjekte zwischen einem
	  Windows 2012/2016/2019-Server mit Active Directory (AD) und dem OpenLDAP-Verzeichnis aus &ucsUCS; synchronisieren kann.
	</para>

	<para>
	  Im ersten Fall, der Konfiguration eines UCS-Serversystems als Mitglied einer AD-Domäne, dient das AD als führender Verzeichnisdienst
	  und das jeweilige UCS-System tritt dem Vertrauenskontext der AD-Domäne
	  bei. Durch die Domänenmitgliedschaft hat das UCS-System limitierten Zugriff auf Kontodaten der Active
	  Directory-Domäne. Die Einrichtung dieses Betriebsmodus ist im Detail in <xref linkend="ad-connector:ad-member-einrichtung"/> beschrieben.
	</para>

	<para>
	  Der zweite Modus, der sich über die App <emphasis>Active Directory-Verbindung</emphasis>
	  konfigurieren lässt, dient dazu, die UCS Domäne parallel zu einer bestehenden AD-Domäne
	  zu betreiben. In diesem Modus ist jedem Domänen-Benutzer sowohl in der UCS- als auch
	  in der AD-Domäne ein gleichnamiges Benutzerkonto zugeordnet. Durch die
	  Namensidentität und die Synchronisation der verschlüsselten Passwortdaten ermöglicht
	  dieser Modus einen transparenten Zugriff zwischen beiden Domänen. Die Authentifikation eines
	  Benutzers in der UCS-Domäne geschieht in diesem Modus direkt innerhalb der UCS-Domäne und ist damit
	  nicht direkt abhängig von der AD-Domäne. Die Einrichtung diese Betriebsmodus ist im Detail in <xref linkend="ad-connector:ad-connector-einrichtung"/> beschrieben.
	</para>

  </section>

  <section id="ad-connector:ad-member-einrichtung">
  <title>UCS als Mitglied einer Active Directory-Domäne</title>

	<para>
		Bei der Konfiguration eines UCS-Serversystems als Mitglied einer AD-Domäne (<emphasis>AD member</emphasis>-Modus)
		dient das AD als führender Verzeichnisdienst und das jeweilige UCS-System tritt dem Vertrauenskontext der AD-Domäne
		bei. Das UCS-System ist nicht in der Lage selbst als Active Directory Domänencontroller zu arbeiten.
		Durch die Domänenmitgliedschaft hat das UCS-System limitierten Zugriff auf Kontodaten der Active
		Directory-Domäne, die es über den UCS AD-Connector aus dem AD ausliest und lokal in den eigenen OpenLDAP-basierten
		Verzeichnisdienst schreibt. In dieser Konfiguration schreibt der UCS AD-Connector keine Änderungen
	  in das AD.
	</para>

	<para>
	  Der <emphasis>AD member</emphasis>-Modus eignet sich,
	  um eine AD-Domäne durch Applikationen zu erweitern, die auf der UCS-Plattform zur
	  Verfügung stehen. Auf der UCS-Plattform installierte Apps sind dann für Benutzer der
	  AD-Domäne nutzbar. Die Authentifikation erfolgt dabei weiter gegen native
	  Microsoft AD-Domänencontroller.
	</para>

  <para>
		Der Einrichtungsassistent kann direkt bei der UCS Installation durch die Auswahl
		<emphasis>Einer bestehenden Active-Directory-Domäne beitreten</emphasis> gestartet werden.
		Nachträglich kann der Einrichtungsassistent mit der Applikation <emphasis>Active Directory-Verbindung</emphasis>
		aus dem Univention App Center installiert werden. Alternativ kann das Softwarepaket
		<package>univention-ad-connector</package> installiert werden. Weitere Informationen finden sich in
		<xref linkend="computers::softwaremanagement::installsoftware"/>.
  </para>

  <note>
		<itemizedlist>
			<listitem><simpara>Der <emphasis>AD member</emphasis>-Modus kann nur auf einem &ucsPrimaryDN; konfiguriert werden.</simpara></listitem>
			<listitem><simpara>Der Name der DNS-Domäne des UCS-Systems muss mit dem der AD-Domäne übereinstimmen. Die Hostnamen selbst müssen natürlich unterschiedlich sein.</simpara></listitem>
			<listitem><simpara>Alle AD- und UCS-Server in einer Connector-Umgebung sollten dieselbe Zeitzone verwenden.</simpara></listitem>
		</itemizedlist>
  </note>

    <figure id="windows:gpo:mode"><title>Konfiguration des Betriebsmodus als Teil einer AD-Domäne</title>
      <graphic scalefit="1" width="100%" align="center" fileref="illustrations50/admember_1-de.png"/>
    </figure>

  <para>
	Im ersten Dialog der Einrichtungsassistenten ist der Punkt <emphasis>UCS als Teil einer
	AD-Domäne konfigurieren</emphasis> vorausgewählt
	und kann mit <mousebutton>Weiter</mousebutton> bestätigt werden.
  </para>

  <para>
	Im nächsten Dialog wird die Adresse eines AD-Domänencontrollers
	sowie der Name des Standard-Administrator-Kontos der AD-Domäne
	und dessen Passwort abgefragt. Hier sollte das Standard-AD-Administratorkonto
	verwendet werden.
	Der angegebene AD-Domänencontroller muss auch DNS-Dienste für
	die Domäne bereitstellen.
    Durch Betätigen der Schaltfläche <mousebutton>AD-Domäne beitreten</mousebutton> wird der Domänenbeitritt gestartet.
  </para>

    <figure id="windows:ad:join"><title>Domänenbeitritt zu einer AD-Domäne</title>
      <graphic scalefit="1" width="100%" align="center" fileref="illustrations50/admember_2-de.png"/>
    </figure>

  <para>
    Falls die Systemzeit des UCS-Systems mehr als 5 Minuten gegenüber der Systemzeit des AD-Domänencontrollers vorgeht, ist eine manuelle Angleichung der Systemzeiten notwendig. Dies ist notwendig, da die AD-Kerberos-Infrastruktur zur Authentifizierung verwendet wird.
    Systemzeiten sollten dabei nicht zurückgestellt werden, um Inkonsistenzen zu vermeiden.
  </para>

  <para>
    Der Domänenbeitritt läuft automatisch ab.
    Der abschließende Dialog sollte mit <mousebutton>Fertigstellen</mousebutton> bestätigt werden. Danach sollte mit einem Klick auf <mousebutton>Neustart</mousebutton> der UMC-Server neu gestartet werden.
  </para>

  <note>
    <para>
		Nach Einrichtung des <emphasis>AD member</emphasis>-Modus findet die Authentifikation gegen den AD-Domänencontroller statt.
		<emphasis>Daher gilt für den Administrator jetzt das Passwort aus der AD-Domäne.</emphasis>
		Falls einer AD-Domäne mit nicht-englischsprachiger Sprachkonvention beigetreten wurde, dann wird das <systemitem class="username">Administrator</systemitem>-Konto aus UCS während des Domänenbeitritts automatisch in die Schreibweise des AD umbenannt.
		Gleiches gilt für alle Benutzer- und Gruppenobjekte mit <emphasis>Well Known SID</emphasis> (z.B. <systemitem class="groupname">Domain Admins</systemitem>).
    </para>
  </note>

  <warning>
    <para>
      Falls zuvor neben dem &ucsPrimaryDN; weitere UCS-Systeme schon Teil der UCS-Domäne waren, dann müssen diese der Domäne neu beitreten. Dabei erkennen sie, dass der &ucsPrimaryDN; sich im <emphasis>AD member</emphasis>-Modus befindet und treten ebenfalls der Authentifikationsstruktur der AD-Domäne bei und können dann z.B. zusätzlich Samba-Dateifreigaben bereitstellen.
    </para>
  </warning>

  <note>
  	<para>
    Da in diesem Modus die AD-Kerberos-Infrastruktur zur Authentifizierung von Benutzern verwendet wird, ist es essenziell, dass die Systemzeiten von UCS und AD-Domänencontroller synchron sind (mit einer Toleranz von 5 Minuten). Zu diesem Zweck ist unter UCS der AD-Domänencontroller als NTP-Zeitserver konfiguriert.

    	Im Falle von Authentifikationsproblemen sollte immer als erstes die Systemzeit überprüft werden.
    </para>
  </note>

  <para>
    Nach dieser Einrichtung kann das UMC-Modul <emphasis>Active Directory-Verbindung</emphasis> zur weiteren Administration verwendet werden, z.B. um zu prüfen, ob der Dienst läuft und ihn ggf. neu zu starten (siehe <xref linkend="ad-connector:neustart"/>).
  </para>

  <para>
    Um eine verschlüsselte Verbindung zwischen Active Directory und &ucsPrimaryDN; nicht nur für die Authentifikation, sondern auch für den Datenaustausch an sich zu verwenden, kann auf dem AD-Domänencontroller das Root-Zertifikat der Zertifizierungsstelle exportiert und über das UMC-Modul hochgeladen werden. Weitere Informationen dazu liefert <xref linkend="ad-connector:ad-zertifikat"/>.
  </para>

  <para>
    Per Voreinstellung überträgt die so eingerichtete Active Directory-Verbindung keine Passwortdaten aus AD in den UCS-Verzeichnisdienst. Einige Apps aus dem App Center benötigen verschlüsselte Passwortdaten. Sofern eine App diese benötigt, wird ein entsprechender Hinweis im App Center angezeigt.
  </para>

  <para>
	  Im <emphasis>AD member</emphasis>-Modus liest der UCS AD-Connector Objektdaten per Voreinstellung mit den Berechtigungen des Maschinenkontos des &ucsPrimaryDN;s aus dem AD. Für das Auslesen von verschlüsselten Passwortdaten sind dessen Berechtigungen nicht ausreichend.
	  Daher muss in diesem Fall zusätzlich manuell die LDAP-DN eines privilegierten Replikationsbenutzers in die &ucsUCRV; <envar>connector/ad/ldap/binddn</envar> eingetragen werden.
	  Dieser muss im AD Mitglied der Gruppe <systemitem class="groupname">Domänen-Admins</systemitem> sein.
	  Das entsprechende Kennwort muss auf dem &ucsPrimaryDN; in eine Datei gespeichert werden und ihr Dateiname muss in die &ucsUCRV; <envar>connector/ad/ldap/bindpw</envar> eingetragen werden.
	  Falls zu einem späteren Zeitpunkt das Zugriffspasswort geändert wurde, muss das neue Passwort in diese Datei eingetragen werden.
	  Die Zugriffsrechte für die Datei sollten so eingeschränkt werden, dass nur der Besitzer <systemitem class="username">root</systemitem> Zugriff hat.
  </para>
  <para>
  	Die folgenden Kommandos zeigen die Schritte beispielhaft:
  </para>

  <programlisting language="sh">
ucr set connector/ad/ldap/binddn=Administrator
ucr set connector/ad/ldap/bindpw=/etc/univention/connector/password
touch /etc/univention/connector/password
chmod 600 /etc/univention/connector/password
echo -n "Administrator password" > /etc/univention/connector/password
ucr set connector/ad/mapping/user/password/kinit=false
  </programlisting>

  <para>
    Falls gewünscht, kann zu einem späteren Zeitpunkt der AD-Domänencontroller auch durch den &ucsPrimaryDN; abgelöst werden. Dies ist über die Applikation <emphasis>Active Directory Takeover</emphasis> möglich (siehe <xref linkend="windows:adtakeover"/>).
  </para>
  </section>

  <section id="ad-connector:ad-connector-einrichtung">
  <title>Einrichtung des UCS AD-Connectors</title>

  <para>
  	Als Alternative zur Mitgliedschaft in einer AD-Domäne, die im vorherigen Abschnitt beschrieben ist, kann der UCS Active Directory-Connector dazu verwendet werden, Benutzer- und Gruppenobjekte zwischen einer UCS-Domäne und einer AD-Domäne zu synchronisieren. Diese Betriebsart erlaubt über die unidirektionale Synchronisation hinaus auch die bidirektionale Synchronisation. In dieser Betriebsart bestehen beide Domänen parallel und ihre Authentifikationssysteme funktionieren unabhängig. In diesem Betriebsmodus werden per Voreinstellung auch verschlüsselten Passwortdaten synchronisiert.
  </para>

  <para>
    In der Standardeinstellung werden Container, Organisationseinheiten, Benutzer, Gruppen
    und Rechner synchronisiert.
  </para>

  <para>
    Hinweise zu den in der Grundeinstellung konfigurierten Attributen und zu beachtende
    Besonderheiten finden sich in <xref
    linkend="ad-connector:details-zur-vorkonfigurierten-synchronisation"/>.
  </para>

  <para>
    Durch die in beiden Domänen gleichen Benutzereinstellungen können Benutzer transparent auf
    Dienste beider Umgebungen zugreifen. Nachdem eine Domänenanmeldung an einer UCS-Domäne
    durchgeführt wurde, ist anschließend eine Verbindung zu einer Dateifreigabe oder einem
    Exchange-Server mit Active Directory ohne erneute Passwortabfrage möglich. Auf den Ressourcen
    der anderen Domäne finden Benutzer und Administratoren gleichnamige Benutzer und Gruppen vor
    und können so mit den gewohnten Rechtestrukturen arbeiten.
  </para>

  <para>
    Nach dem erstmaligen Start des Connectors wird die Initialisierung vorgenommen. Dabei werden
    alle Einträge aus dem UCS gelesen und entsprechend dem eingestellten Mapping in AD-Objekte
    umgewandelt und auf AD-Seite hinzugefügt, bzw., falls bereits vorhanden,
    modifiziert. Anschließend werden alle Objekte aus dem AD gelesen und in UCS-Objekte
    umgewandelt und entsprechend auf UCS-Seite hinzugefügt bzw. modifiziert. Solange noch
    Änderungen vorliegen, werden die Verzeichnisdienst-Server weiter abgefragt. Der UCS AD-Connector
    kann auch in einem unidirektionalen Modus betrieben werden.
  </para>

  <para>
    Nach dem initialen Sync werden weitere Änderungen in einem festen Intervall abfragt. Dieser
		Wert ist auf fünf Sekunden eingestellt und kann manuell per &ucsUCR;-Variable <envar>connector/ad/poll/sleep</envar>
		angepasst werden.
  </para>

  <para>
    Sollte ein Objekt nicht synchronisiert werden können, so wird dieses Objekt zunächst
    zurückgestellt ("rejected"). Nach einer konfigurierbaren Anzahl von Durchläufen - das
    Intervall kann im per &ucsUCR;-Variable <envar>connector/ad/retryrejected</envar> angepasst werden - wird erneut versucht diese Änderungen wieder
    einzuspielen. Der Standardwert beträgt zehn Durchläufe. Außerdem wird bei einem Neustart des
    UCS AD-Connectors ebenfalls versucht, die zuvor zurückgewiesenen Änderungen erneut zu
    synchronisieren.
  </para>

  <section id="ad-connector:basicsetup">
	<title>Grundkonfiguration des UCS AD-Connectors</title>

	<para>
	  Der UCS AD-Connector wird über den Assistenten <guimenu>Active Directory-Verbindung</guimenu> der
	  &ucsUMC; konfiguriert.
	</para>

	<para>
	  Der Einrichtungsassistent kann mit der Applikation <emphasis>Active Directory-Verbindung</emphasis>
	  aus dem Univention App Center installiert werden. Alternativ kann das Softwarepaket
	  <package>univention-ad-connector</package> installiert werden. Weitere Informationen finden sich in
	  <xref linkend="computers::softwaremanagement::installsoftware"/>.
	</para>

	<note>
	  <para>
	    Alle AD- und UCS-Server in einer Connector-Umgebung müssen dieselbe Zeitzone verwenden.
	  </para>
	</note>

	<warning>
	  <para>
	    Trotz intensiver Tests kann aufgrund der Vielfalt der Konfigurations- und Betriebsvarianten
	    einer AD-Domäne nicht ausgeschlossen werden, dass die Ergebnisse des
	    Synchronisationsvorgangs den Betrieb einer produktiven Domäne beeinträchtigen. Der UCS AD-Connector
	    sollte daher vorab in einer getrennten Umgebung auf die jeweiligen Anforderungen geprüft werden.
	  </para>
	</warning>

	<para>
	  Es ist zu empfehlen, die folgenden Schritte mit einem Webbrowser vom AD-Domänencontroller aus durchzuführen, da Dateien auf den AD-Domänencontroller herunter geladen und in &ucsUMC; hochgeladen werden müssen.
	</para>

	<para>
	  Internet Explorer 6 - der auf Windows 2003-Systemen vorinstalliert ist - wird durch &ucsUMC;
	  nicht unterstützt. Hier sollte zuerst eine Aktualisierung des Browsers durchgeführt oder ein
	  alternativer Browser installiert werden.
	</para>

	<para>
	  Im ersten Dialog der Einrichtungsassistenten muss der Punkt <emphasis>Synchronisation von Kontendaten zwischen einer AD und dieser UCS-Domäne</emphasis> ausgewählt und mit <mousebutton>Weiter</mousebutton> bestätigt werden.
	</para>

	  <figure id="windows:ad:connector"><title>Konfiguration des UCS AD-Connectors in UMC</title>
	  <graphic scalefit="1" width="100%" align="center" fileref="illustrations50/adconnector_1-de.png"/>
	  </figure>

	<para>
	  Im nächsten Dialog wird die Adresse eines AD-Domänencontrollers abgefragt.
	  Hier kann die IP-Adresse oder ein voll qualifizierter DNS-Name eingegeben werden.
	  Wenn der Rechnername des AD-Systems für das UCS-System nicht auflösbar sein sollte,
	  kann entweder unter UCS der AD DNS-Server als DNS-Forwarder konfiguriert werden
	  oder es kann in der DNS-Verwaltung von &ucsUMC; ein DNS-Host-Record für das
	  AD-System angelegt werden (siehe <xref linkend="networks::dns::hostrecord"/>).
	</para>

	<para>
	  Alternativ kann auch über &ucsUCR; ein statischer Eintrag in <filename>/etc/hosts</filename>
	  aufgenommen werden, z.B. mit
	</para>

	<programlisting language="sh">
ucr set hosts/static/192.0.2.100=w2k8-32.ad.example.com
	</programlisting>

	<para>
	  Im Feld <guimenu>Active Directory-Konto</guimenu> wird der Benutzer konfiguriert, der für
	  den Zugriff auf das AD verwendet wird. Die Einstellung wird in der
	  &ucsUCRV; <envar>connector/ad/ldap/binddn</envar> gespeichert. Der Replikationsbenutzer muss im
	  AD Mitglied der Gruppe <systemitem class="groupname">Domänen-Admins</systemitem> sein.
	</para>

	<para>
	  Das verwendete Kennwort für den Zugriff muss im Feld <guimenu>Active Directory-Passwort</guimenu>
	  eingetragen werden. Es wird auf dem UCS-System lokal in einer Datei gespeichert,
	  die nur für den Benutzer <systemitem class="username">root</systemitem> lesbar ist.
	</para>

	<para>
	  <xref linkend="ad-connector:ad-passwort"/> beschreibt die Schritte, die notwendig sind, falls diese Zugangsdaten zu einem späteren Zeitpunkt angepasst werden müssen.
	</para>

	<para>
	  Nach Klick auf <mousebutton>Weiter</mousebutton> prüft der Einrichtungsassistent die Verbindung zum AD-Domänencontroller.
	  Falls keine SSL/TLS-verschlüsselte Verbindung aufgebaut werden kann wird eine Warnung ausgegeben
	  in der zur Installation einer Zertifizierungsstelle auf dem AD-Domänencontroller geraten wird.
	  Es wird empfohlen diesem Rat zu folgen.
	  UCS 5.0 erfordert TLS 1.2, welches für Windows Server Releases vor 2012R2 manuell auf dem Windows Server aktiviert werden muss.
	  UCS 5.0 unterstüzt das Hashingverfahren SHA1 nicht mehr. Falls für die Erstellung des das AD-Root-Zertifikat oder
	  das Zertifikat des Windows Servers dieses Verfahren verwendet wurde, dann sollten diese ersetzt werden.
	  Nach diesem Schritt kann die Einrichtung durch erneuten Klick auf <mousebutton>Weiter</mousebutton> fortgesetzt werden.
	  Falls weiterhin keine SSL/TLS-verschlüsselte Verbindung aufgebaut werden kann, wird in einem Sicherheitshinweis nachgefragt,
	  ob die Synchronisation ohne SSL-Verschlüsselung eingerichtet werden soll.
	  Falls dies gewünscht ist, kann die Einrichtung durch Klick auf <mousebutton>Fortfahren ohne Verschlüsselung</mousebutton> fortgesetzt werden.
	  In diesem Fall findet die Synchronisation der Verzeichnisdaten unverschlüsselt statt.
	  Falls
	</para>

	<para>
		Falls der AD-Domänencontroller SSL/TLS-verschlüsselte Verbindungen unterstützt, bietet der Einrichtungsassistent im nächsten Schritt das <guimenu>Hochladen des AD-Root-Zertifikats</guimenu> an.
		Dieses Zertifikat muss vorher aus der AD-Zertifizierungsstelle exportiert werden (siehe <xref linkend="ad-connector:ad-zertifikat"/>).
		Falls dieser Schritt hingegen übersprungen wird, kann das Zertifikat auch zu einem späteren Zeitpunkt über das UMC-Modul hochgeladen und die SSL/TLS-Verschlüsselung aktiviert werden (bis dahin werden dann aber alle Verzeichnisdaten unverschlüsselt synchronisiert).
	</para>

	<para>
	  Der Connector kann in verschiedenen Modi betrieben werden, die im nächsten Dialog
	  <guimenu>Konfiguration der Active Directory-Domänensynchronisation</guimenu> ausgewählt werden können.
	  Neben einer bidirektionalen Synchronisation kann auch unidirektional von AD nach UCS
	  oder unidirektional von UCS in das AD repliziert werden.
	  Nach Auswahl des Modus muss auf <mousebutton>Weiter</mousebutton> geklickt werden.
	</para>

	<para>
	  Nach einem Klick auf <mousebutton>Weiter</mousebutton> wird die Konfiguration übernommen und der UCS AD-Connector wird gestartet.
	  Der abschließende Dialog muss dann durch Klick auf <mousebutton>Fertigstellen</mousebutton> geschlossen werden.
	</para>
	<para>
      Nach dieser Einrichtung kann das UMC-Modul <emphasis>Active Directory-Verbindung</emphasis> zur weiteren Administration des UCS Active Directory Connectors verwendet werden, z.B. um zu prüfen, ob der Dienst läuft und ihn ggf. neu zu starten (siehe <xref linkend="ad-connector:neustart"/>).
	</para>

	<note>
	  <para>
			Der Connector kann auch mehrere AD-Domänen mit einer UCS-Domäne synchronisieren;
			dies ist in <xref linkend="ext-doc-win"/> dokumentiert.
	  </para>
	</note>

	 <figure id="windows:ad:dialog"><title>Administrationsdialog für die Active Directory-Verbindung</title>
	 <graphic scalefit="1" width="90%" align="center" fileref="illustrations50/adconnector_2-de.png"/>
	 </figure>

	</section>

<section id="ad-connector:ad-zertifikat">
  <title>Import des SSL-Zertifikats des Active Directory</title>

  <para>
	Auf dem Active Directory-System muss nun ein SSL-Zertifikat erzeugt
	und das Root-Zertifikat exportiert werden, damit eine verschlüsselte Kommunikation
	stattfinden kann. Erzeugt wird das Zertifikat mit dem
	Zertifikatsdienst des Active Directory. Die nötigen Schritte
	sind abhängig von der eingesetzten Windows-Version und werden hier
	beispielhaft für drei Varianten dargestellt.
  </para>

  <para>
	Die verschlüsselte Verbindung zwischen UCS-System und Active Directory
	kann auch deaktiviert werden, indem die
	&ucsUCRV; <envar>connector/ad/ldap/ssl</envar> auf <literal>no</literal> gesetzt wird. Diese
	Einstellung betrifft nicht die Synchronisation der verschlüsselten Passwortdaten.
  </para>

  <section id="windows:Export_unter_Windows_2003">
	<title>Export unter Windows 2003</title>

	<para>
	  Falls der Zertifikatsdienst nicht installiert ist, so kann dieser
	  nachinstalliert werden: <guimenu>Start &ar;
	  Einstellungen &ar; Systemsteuerung &ar; Software &ar; Windows
	  Komponenten, Zertifikatsdienst auswählen &ar; Weiter
	  Stammzertifizierungsstelle des Unternehmens wählen &ar; Weiter, Domänen
	  Namen angeben &ar; Weiter &ar; Weiter</guimenu>. Anschließend sollte der Server neu
	  gestartet werden.
	</para>

	<para>
	  Dieses Zertifikat muss exportiert und auf das UCS System kopiert werden:
	  <guimenu>Zertifizierungsstelle &ar; AD-Domäne &ar;
	  Eigenschaften &ar; Zertifikat anzeigen &ar; Details &ar; In Datei kopieren &ar;
	  DER-codiert-binaer X.509</guimenu>.
	</para>
  </section>

  <section id="windows:Export_unter_Windows_2008">
	<title>Export unter Windows 2008</title>

	<para>
	  Falls der Zertifikatsdienst nicht installiert ist, so muss dieser
	  nachinstalliert werden:
	</para>

	  <figure id="windows:2008:ca"><title>Export des Root-Zertifikats unter Windows 2008</title>
	  <graphic scalefit="1" width="90%" align="center" fileref="illustrations50/adconnector_23-de.png"/>
	  </figure>

	<para>
	  <guimenu>Start &ar; Systemsteuerung &ar; Programme und Funktionen &ar; Windows-Funktionen
	  aktivieren oder deaktivieren &ar; Rollen &ar; Rollen hinzufügen &ar; Weiter
	  &ar; Haken bei Active Directory-Zertifikatsdienste aktivieren &ar; Weiter
	  &ar; Weiter &ar; Zertifizierungsstelle aktivieren &ar; Unternehmen auswählen
	  &ar; Stammzertifierungsstelle auswählen &ar; Neuen privaten Schlüssel
	  erstellen &ar; Weiter &ar; Die vorgeschlagenen Kryptoeinstellungen mit
	  Weiter akzeptieren &ar; Den vorgeschlagenen Namen der
	  Zertifizierungsstelle akzeptieren &ar; Eine beliebige Gültigkeitsdauer
	  auswählen &ar; Weiter &ar; Standardpfad für die Zertifikatsdatenbank
	  akzeptieren</guimenu> . Im abschließenden Dialog erscheint eine Warnmeldung,
	  dass Name und Domäneneinstellung nach Installation der
	  Zertifizierungsstelle nicht mehr geändert werden können. Dies muss
	  mit <guimenu>Installieren</guimenu> bestätigt werden.
	</para>

	<para>
	  Anschließend muss der AD-Server neu gestartet werden.
	</para>

	<para>
	  Dieses Zertifikat muss nun exportiert und auf das UCS System kopiert
	  werden: <guimenu>Start &ar; Programme &ar; Verwaltung &ar; Zertifizierungsstelle</guimenu>.
	  Dort wird eine
	  Rechnerliste angezeigt und unter jedem System die Elemente <guimenu>Gesperrte
	  Zertifikate</guimenu>, <guimenu>Ausgestellte Zertifikate</guimenu>, <guimenu>Ausstehende
	  Anforderungen</guimenu>, <guimenu>Fehlgeschlagene Anforderungen</guimenu> und
	  <guimenu>Zertifikatsvorlagen</guimenu> angezeigt. Hier muss ein Rechtsklick auf den
	  Rechnernamen erfolgen - nicht auf eines der Elemente darunter - und
	  <guimenu>Eigenschaften</guimenu> ausgewählt werden. Das Root-Zertifikat heisst in der Regel
	  <guimenuitem>Zertifikat Nr. 0</guimenuitem>. Dann <guimenu>Zertifikat anzeigen &ar; Details  &ar; In Datei kopieren &ar;
	  DER-codiert-binär X.509 (.CER) &ar; Auswahl eines beliebigen Dateinamens und Speicherpfad
	  &ar; Fertig stellen</guimenu>.
	</para>
  </section>

  <section id="windows:adconn:win2012">
	<title>Export unter Windows Server 2012</title>

	<para>
	  Falls der Zertifikatsdienst nicht installiert ist, so muss dieser
	  nachinstalliert werden:
	</para>

	<para>
	  Der Server-Manager muss geöffnet werden. Dort im Menü <guimenu>Verwalten &ar; Rollen und Features
	  hinzufügen</guimenu> die Rolle <guimenu>Active Directory-Zertifikatsdienste</guimenu>
	  auswählen. Bei der Auswahl der Rollendienste reicht es aus, nur die
	  <guimenu>Zertifizierungsstelle</guimenu> auszuwählen. Anschließend wird im Server-Manager in
	  der oberen Leiste ein gelbes Warndreieck angezeigt. Hier muss die Option <guimenu>Active
	  Directory-Zertifikatsdienste auf dem Zielserver konfigurieren</guimenu> ausgewählt werden. Als
	  zu konfigurierender Rollendienst wird <guimenu>Zertifizierungsstelle</guimenu> ausgewählt. Der
	  Installationstyp ist <guimenu>Unternehmenszertifizierungsstelle &ar;
	  Stammzertifizierungsstelle</guimenu>. Nun muss auf <guimenu>Neuen privaten Schlüssel
	  erstellen</guimenu> geklickt und die vorgeschlagenen Kryptoeinstellungen und der
	  vorgeschlagene Name der Zertifizierungsstelle bestätigt werden. Die Gültigkeitsdauer kann
	  beliebig gewählt werden. Als Datenbankort können die Standardpfade verwendet werden.
	</para>

	<para>
	  Anschließend muss der AD-Server neu gestartet werden.
	</para>

	<para>
	  Dieses Zertifikat muss nun exportiert und auf das UCS-System kopiert
	  werden: <guimenu>Server-Manager &ar; AD-Zertifikatsdienste</guimenu>. Dann ein Rechts-Klick
	  auf den Server und Auswahl von <guimenu>Zertifizierungsstelle</guimenu>. Dort wird eine
	  Rechnerliste angezeigt und unter jedem System die Elemente <guimenu>Gesperrte
	  Zertifikate</guimenu>, <guimenu>Ausgestellte Zertifikate</guimenu>, <guimenu>Ausstehende
	  Anforderungen</guimenu>, <guimenu>Fehlgeschlagene Anforderungen</guimenu> und
	  <guimenu>Zertifikatsvorlagen</guimenu> angezeigt. Hier muss ein Rechtsklick auf den
	  Rechnernamen erfolgen - nicht auf eines der Elemente darunter - und
	  <guimenu>Eigenschaften</guimenu> ausgewählt werden. Das Root-Zertifikat heisst in der Regel
	  <emphasis>Zertifikat Nr. 0</emphasis>. Dann <guimenu>Zertifikat anzeigen &ar; Details  &ar; In Datei kopieren &ar;
	  DER-codiert-binär X.509 (.CER) &ar; Auswahl eines beliebigen Dateinamens und Speicherpfad
	  &ar; Fertig stellen</guimenu>.
	</para>

  </section>


<section id="windows:Kopieren_des_AD-Zertifikats_auf_das_UCS-System"><title>Kopieren des AD-Zertifikats auf das UCS-System</title>
<para>
Nun muss das SSL-AD-Zertifikat über den &ucsUMC;-Assistenten in das
UCS-System importiert werden.
</para>
<para>
Dies erfolgt durch einen Klick auf <mousebutton>Hochladen</mousebutton> im
Untermenü <guimenu>Active Directory-Verbindung SSL-Konfiguration</guimenu>.
</para>
<para>
Hierbei öffnet sich ein Fenster, in dem eine Datei ausgewählt wird.
Das hochgeladene Zertifikat wird dadurch für den UCS AD-Connector verfügbar gemacht.
</para>
</section>
</section>

<section id="ad-connector:neustart"><title>Start/Stopp des Active Directory Connectors</title>
<para>
	Abschließend kann der Connector über <mousebutton>Active Directory-Verbindungsdienst starten</mousebutton>
	gestartet werden und bei Bedarf über <mousebutton>Active Directory-Verbindungsdienst stoppen</mousebutton>
	angehalten werden. Alternativ kann ein Starten/Stoppen auch über Kommandozeile durch die Befehle
	<command>/etc/init.d/univention-ad-connector start</command> und
	<command>/etc/init.d/univention-ad-connector stop</command> erfolgen.
</para>
</section>

<section id="windows:Funktionstest_der_Grundeinstellungen"><title>Funktionstest der Grundeinstellungen</title>
<para>
Die korrekte Grundkonfiguration des Connectors lässt sich prüfen, indem
vom UCS-System aus im Active Directory gesucht wird. Hier kann z.B. mit
<command>univention-adsearch cn=Administrator</command> nach dem
Administrator-Konto im Active Directory gesucht werden.
</para>
<para>
Da <command>univention-adsearch</command> auf die in &ucsUCRV;
gespeicherte Konfiguration zugreift, kann auf diesem Weg die
Erreichbarkeit/Konfiguration des Active Directory-Zugriffs geprüft
werden.
</para>
</section>

<section id="ad-connector:ad-passwort"><title>Änderung des AD-Zugriffspassworts</title>
  <para>
	  Die vom UCS AD-Connector benötigten Zugangsdaten zum Active Directory werden über die &ucsUCRV; <envar>connector/ad/ldap/binddn</envar> und <envar>connector/ad/ldap/bindpw</envar> konfiguriert.
	  Falls das Passwort sich geändert hat oder ein anderes Benutzerkonto verwendet werden soll, können diese Variablen manuell angepasst werden.
	  Über die &ucsUCRV; <envar>connector/ad/ldap/binddn</envar> wird die LDAP-DN eines privilegierten Replikationsbenutzers konfiguriert.
	  Dieser muss im AD Mitglied der Gruppe <systemitem class="groupname">Domänen-Admins</systemitem> sein.
	  Das entsprechende Kennwort muss lokal auf dem UCS-System in eine Datei gespeichert werden, deren Dateiname in der &ucsUCRV; <envar>connector/ad/ldap/bindpw</envar> eingetragen sein muss.
	  Die Zugriffsrechte für die Datei sollten so eingeschränkt werden, dass nur der Besitzer <systemitem class="username">root</systemitem> Zugriff hat.
	  Die folgenden Kommandos zeigen dies beispielhaft:
  </para>

  <programlisting language="sh">
eval "$(ucr shell)"
echo "Updating ${connector_ad_ldap_bindpw?}"
echo "for AD sync user ${connector_ad_ldap_binddn?}"
touch "${connector_ad_ldap_bindpw?}"
chmod 600 "${connector_ad_ldap_bindpw?}"
echo -n "Current AD Syncuser password" > "${connector_ad_ldap_bindpw?}"
  </programlisting>
</section>
</section>

<section id="ad-connector:tools"><title>Werkzeuge / Fehlersuche</title>
<para>
Mit dem UCS AD-Connector werden einige Tools und Logdateien bereitgestellt:
</para>
<section id="ad-connector:univention-adsearch"><title><command>univention-adsearch</command></title>
<para>
Dieses Tool ermöglicht die einfache LDAP-Suche im Active Directory.
In AD gelöschte Objekte werden immer mit angezeigt (diese werden in AD
weiterhin in einem LDAP-Unterbaum vorgehalten). Als erste Option erwartet das Skript
einen LDAP-Filter, die zweite Option kann eine Liste der anzuzeigenden
LDAP-Attribute sein, z.B.:
</para>
<programlisting language="sh">
univention-adsearch cn=administrator cn givenName
</programlisting>
</section>

<section id="ad-connector:univention-adconnector-list-rejected"><title><command>univention-adconnector-list-rejected</command></title>
<para>
Dieses Tool führt die DNs nicht synchronisierter Objekte auf. Zusätzlich wird,
sofern zwischengespeichert, die korrespondierende DN im jeweils anderen LDAP-Verzeichnis
angegeben. Abschließend gibt <property>lastUSN</property> die ID der letzten von AD
synchronisierten Änderung an.
</para>
</section>

<section id="windows:Logdateien"><title>Logdateien</title>
<para>
Zur Fehlersuche bei Synchronisationsproblemen finden sich
entsprechende Meldungen in folgenden Dateien auf dem UCS-System:
</para>
<programlisting>
/var/log/univention/connector-ad.log
/var/log/univention/connector-status.log
</programlisting>
</section>
</section>

<section id="ad-connector:details-zur-vorkonfigurierten-synchronisation"><title>Details zur vorkonfigurierten Synchronisation</title>
<para>
In der Grundeinstellung werden einige Container durch Filter von der
Synchronisation ausgeschlossen. Diese finden sich in der
Konfigurationsdatei <filename>/etc/univention/connector/ad/mapping</filename>
unter der Einstellung <emphasis>global_ignore_subtree</emphasis>.
Sollen einzelne Benutzer von der Synchronisation ausgeschlossen werden, können deren
Benutzername der &ucsUCRV; <envar>connector/ad/mapping/user/ignorelist</envar> hinzugefügt werden.
Für mehr Flexibilität kann auch ein Filter in der &ucsUCRV;
<envar>connector/ad/mapping/user/ignorefilter</envar> angegeben werden. Dieser Filter unterstützt jedoch
nicht die volle LDAP-Filter Syntax. Er ist immer abhängig von Groß- und Kleinschreibung und der
Platzhalter "*" kann nur alleinstehend angegeben werden.
</para>

<section id="ad-connector:container-und-organisationseinheiten"><title>Container und Organisationseinheiten</title>
<para>
Container und Organisationseinheiten werden zusammen mit ihrer Beschreibung
synchronisiert. Die Container <uri>cn=mail</uri> und <uri>cn=kerberos</uri> werden auf beiden
Seiten ignoriert. Bei
Containern sind einige Besonderheiten auf AD-Seite zu beachten. Active
Directory bietet im <guimenu>Manager für Benutzer und Gruppen</guimenu> keine
Möglichkeit, Container anzulegen. AD zeigt diese im erweiterten Modus
aber an (<guimenu>Ansicht &ar; Erweiterte Funktionen</guimenu>).
</para>

<section id="windows:ad-connector:Besonderheiten"><title>Besonderheiten</title>
<itemizedlist>
	<listitem>
		<para>Unter AD gelöschte Container oder Organisationseinheiten werden unter
UCS rekursiv gelöscht, das bedeutet, dass evtl. nicht synchronisierte
Unterobjekte, die in AD nicht zu sehen sind, ebenfalls entfernt
werden.
</para>
</listitem>
</itemizedlist>
</section>
</section>

<section id="ad-connector:gruppen"><title>Gruppen</title>
<para>
Gruppen werden anhand des Gruppennamens synchronisiert, dabei findet
eine Berücksichtigung der primären Gruppe eines Benutzers statt (die
unter AD nur am Benutzer im LDAP hinterlegt wird).
</para>
<para>
Gruppenmitglieder, die im anderen System z.B. aufgrund von Ignore-Filtern
kein Gegenstück haben, werden ignoriert (bleiben also Mitglied der Gruppe).
</para>
<para>
Zusätzlich wird die Beschreibung der Gruppe synchronisiert.
</para>

<section id="windows:gruppen:Besonderheiten"><title>Besonderheiten</title>
<itemizedlist>
<listitem><simpara>Unter AD wird der <emphasis>Prä-Windows 2000 Name</emphasis> (LDAP-Attribut
<property>samAccountName</property>) verwendet, daher kann eine Gruppe im
Active Directory mit anderem Namen erscheinen als unter UCS.
</simpara>
</listitem>
<listitem><simpara>Der Connector ignoriert Gruppen, die im &ucsUDM;
unter <guimenu>Samba Gruppentyp</guimenu> als <emphasis>Bekannte Gruppe</emphasis>
konfiguriert wurden. Eine Synchronisation von SID oder RID findet
nicht statt.
</simpara>
</listitem>
<listitem><simpara>Gruppen, die im &ucsUDM; unter <guimenu>Samba Gruppentyp</guimenu> als <emphasis>Lokale Gruppe</emphasis>
konfiguriert wurden, werden vom Connector als <emphasis>globale Gruppen</emphasis>
in das Active Directory synchronisiert.
</simpara>
</listitem>
<listitem><simpara>Neu angelegte oder verschobene Gruppen werden immer im gleichen
Untercontainer auf der Gegenseite angelegt. Existieren während der
Initialisierung gleichnamige Gruppen in unterschiedlichen Containern,
werden die Mitglieder synchronisiert, nicht jedoch die Position im
LDAP. Wird eine solche Gruppe auf einer Seite verschoben ist der
Zielcontainer auf der anderen Seite identisch, so dass sich die DNs
der Gruppen ab diesem Zeitpunkt nicht mehr unterscheiden.
</simpara>
</listitem>
<listitem>
	<para>Bestimmte Gruppennamen werden anhand einer Mapping-Tabelle umgesetzt, so
dass z.B. die UCS-Gruppe <systemitem class="groupname">Domain Users</systemitem> mit der AD-Gruppe
<systemitem class="groupname">Domänen-Benutzer</systemitem>. synchronisiert wird. Dieses Mapping kann in
englischsprachigen AD-Domänen dazu führen, das die deutschsprachigen
Gruppen angelegt werden und sollte in diesem Fall deaktiviert
werden. Dazu kann die &ucsUCRV; <envar>connector/ad/mapping/group/language</envar>
verwendet werden.
</para>
<para>
Die vollständige Tabelle ist:
</para>
<informaltable>
<?dbhtml table-width="50%" ?>
<?dbfo table-width="50%" ?>
<tgroup cols="2">
<colspec colnum="1" colname="col1" colwidth="1*"/>
<colspec colnum="2" colname="col2" colwidth="1*"/>
<thead>
<row>
<entry><emphasis>UCS-Gruppe</emphasis></entry>
<entry><emphasis>AD-Gruppe</emphasis></entry>
</row>
</thead>
<tbody>
<row>
	<entry><systemitem class="groupname" lang="en">Domain Users</systemitem></entry>
	<entry><systemitem class="groupname" lang="de">Domänen-Benutzer</systemitem></entry>
</row>
<row>
	<entry><systemitem class="groupname" lang="en">Domain Admins</systemitem></entry>
	<entry><systemitem class="groupname" lang="de">Domänen-Admins</systemitem></entry>
</row>
<row>
	<entry><systemitem class="groupname" lang="en">Windows Hosts</systemitem></entry>
	<entry><systemitem class="groupname" lang="de">Domänencomputer</systemitem></entry>
</row>
</tbody>
</tgroup>
</informaltable>
</listitem>
<listitem><simpara>Die Repräsentation von Gruppen in Gruppen unterscheidet sich zwischen
AD und UCS. Sind unter UCS Gruppen Mitglieder von Gruppen, so können
diese Objekte nicht immer auf AD-Seite synchronisiert werden und erscheinen
in der Liste der zurückgewiesenen Objekte. Verschachtelte Gruppen
sollten daher aufgrund der in Active Directory vorliegenden
Einschränkungen immer nur dort zugewiesen werden.
</simpara>
</listitem>
<listitem>
	<simpara>
		Wird im &ucsUDM; eine globale Gruppe <systemitem class="groupname">A</systemitem> als Mitglied einer
		anderen globalen Gruppe <systemitem class="groupname">B</systemitem> aufgenommen, so erscheint diese Mitgliedschaft aufgrund von
		AD-internen Beschränkungen unter <systemitem class="osname">Windows 2000/2003</systemitem> nicht im Active Directory.
		Wird Gruppe <systemitem class="groupname">A</systemitem> anschließend umbenannt, geht die Gruppenmitgliedschaft in Gruppe <systemitem class="groupname">B</systemitem> verloren.
		Ab <systemitem class="osname">Windows 2008</systemitem> besteht diese Einschränkung nicht mehr, dort können im Active Directory auch globale Gruppen verschachtelt werden.
</simpara>
</listitem>
</itemizedlist>
</section>
<section id="windows:gruppen:CustomMappings"><title>Benutzerdefinierte Mappings</title>
<para>
    Es ist auch möglich Mappings zu verändern oder neue hinzuzufügen.
    Dazu muss eine Datei erstellt werden mit dem Namen
    <filename>/etc/univention/connector/ad/localmapping.py</filename>.
    In dieser Datei sollte die folgende Funktion implementiert werden:

<programlisting><![CDATA[
def mapping_hook(ad_mapping):
    return ad_mapping
]]>
</programlisting>

    Der Inhalt der Variable <command>ad_mapping</command> kann damit verändert werden,
    um das Mapping zu beeinflussen. Das resultierende Mapping wird bei Neustart des &ucsADC;
    unter <filename>/var/log/univention/connector-ad-mapping.log</filename> ausgegeben.
</para>
</section>
</section>

<section id="ad-connector:benutzer"><title>Benutzer</title>
<para>
Benutzer werden wie Gruppen anhand des Benutzernamens bzw. anhand des
AD-Prä-Windows 2000 Namens synchronisiert. Direkt übermittelt werden
die Attribute <emphasis>Vorname</emphasis>, <emphasis>Nachname</emphasis>, <emphasis>primäre Gruppe</emphasis> (sofern auf der
anderen Seite vorhanden), <emphasis>Organisation</emphasis>, <emphasis>Beschreibung</emphasis>, <emphasis>Straße</emphasis>, <emphasis>Stadt</emphasis>,
<emphasis>PLZ</emphasis>, <emphasis>Profilpfad</emphasis>, <emphasis>Anmeldeskriptpfad</emphasis>, <emphasis>Deaktiviert</emphasis> und
<emphasis>Kontoablaufdatum</emphasis>. Indirekt werden zusätzlich <emphasis>Passwort</emphasis>,
<emphasis>Passwortablaufdatum</emphasis> und <emphasis>Ändern des Passwortes beim nächsten Login</emphasis>
synchronisiert. Vorbereitet, aber auf Grund unterschiedlicher Syntax in
der Mapping-Konfiguration auskommentiert, sind <emphasis>Primäre Mail-Adresse</emphasis> und
<emphasis>Telefonnummer</emphasis>.
</para>
<para>
Ausgenommen werden die Benutzer <systemitem class="username">root</systemitem> und <systemitem class="username">Administrator</systemitem>.
</para>

<section id="windows:benutzer:Besonderheiten"><title>Besonderheiten</title>
<itemizedlist>
<listitem><simpara>Benutzer werden ebenfalls anhand des Namens identifiziert, so dass für
Benutzer, die vor der ersten Synchronisation auf beiden Seiten
angelegt wurden, hinsichtlich der Position im LDAP das gleiche
Verhalten gilt wie bei Gruppen.
</simpara>
</listitem>
<listitem><simpara>Es kann vorkommen, dass ein unter AD anzulegender Benutzer, dessen
Passwort zurückgewiesen wurde, nach sofortigem erneuten Anlegen aus AD
gelöscht wird. Grund dafür ist, das AD diesen Benutzer zunächst anlegt
und nach dem Abweisen des Passwortes sofort wieder löscht. Werden
diese Operationen nach UCS übertragen, werden sie auch wieder zurück
nach AD übermittelt. Wurde der Benutzer auf AD-Seite schon vor der Rückübertragung
der Operation erneut eingetragen, so wird er nach der Rückübertragung
gelöscht. Das Auftreten dieses Verhaltens ist abhängig von dem
eingestellten Polling-Intervall des Connectors.
</simpara>
</listitem>
<listitem><simpara>AD und UCS legen neue Benutzer per Voreinstellung in eine bestimmte
primäre Gruppe (meist <systemitem class="groupname">Domain Users</systemitem> bzw. <systemitem class="groupname">Domänen Benutzer</systemitem>). Während
der ersten Synchronisation von UCS nach AD werden die Benutzer daher
immer in dieser Gruppe Mitglied.
</simpara>
</listitem>
</itemizedlist>
</section>
</section>
</section>
</section>


<section id="windows:adtakeover">
  <title>Migration einer Active Directory-Domäne zu UCS mit Univention AD Takeover</title>

  <section id="windows:adtakeover:intro">
	<title>Einführung</title>
	<para>
	  UCS unterstützt die Übernahme von Benutzern, Gruppen, Rechnerobjekten und
	  Gruppenrichtlinienobjekten (GPOs) aus einer bestehenden Active Directory (AD)-Domäne. Die
	  Windows-Clients müssen dabei nicht erneut der Domäne beitreten. Diese
	  Übernahme ist ein interaktiver Prozess, der aus drei Phasen besteht:

	  <itemizedlist>
		<listitem><simpara>
		  Kopieren aller Objekte aus Active Directory nach UCS
		</simpara></listitem>

		<listitem><simpara>
		  Kopieren der Gruppenrichtliniendateien aus Active Directory nach UCS
		</simpara></listitem>

		<listitem><simpara>
		  Abschalten des AD-Servers und Zuweisung der FSMO-Rollen auf den UCS Directory Node
		</simpara></listitem>
	  </itemizedlist>
	</para>

	<para>
	  Die folgenden Voraussetzungen müssen für die Übernahme erfüllt sein:

	  <itemizedlist>
		<listitem><simpara>
		  Der UCS Directory Node (&ucsPrimaryDN;) muss mit einem
		  eindeutigen Rechnernamen installiert werden, der nicht in der AD-Domäne vorhanden ist.
		</simpara></listitem>

		<listitem><simpara>
		  Der UCS Directory Node muss mit demselben DNS-Domänennamen, NetBIOS-Domänennamen und
		  Kerberos-Domänennamen installiert werden wie die AD-Domäne. Es wird empfohlen auch
		  die selbe LDAP-Basis-DN zu verwenden.
		</simpara></listitem>

		<listitem><simpara>
		  Der UCS Directory Node muss eine IPv4-Adresse im selben Subnetz wie der zu
		  übernehmende Active Directory-Domänencontroller verwenden.
		</simpara></listitem>
	  </itemizedlist>
	</para>

    <caution>
      <para>
        Sofern das System bereits Mitglied in einer Active Directory Domäne ist (<xref linkend="ad-connector:ad-member-einrichtung"/>),
        wird durch die Installation der <emphasis>Active Directory Takeover</emphasis> Applikation diese Mitgliedschaft entfernt.
        Deshalb sollte die Installation der <emphasis>Takeover</emphasis> Applikation erst kurz vor der eigentlichen
        Übernahme der Active Directory Domäne erfolgen.
      </para>
    </caution>

	<para>
	  Für die Migration muss die Applikation <emphasis>Active Directory Takeover</emphasis> aus dem
	  Univention App Center installiert werden. Sie muss auf dem System installiert werden, auf dem
	  der Univention S4 Connector läuft (siehe <xref linkend="windows:s4connector"/>, normalerweise
	  der &ucsPrimaryDN;).
	</para>

  </section>

  <section id="windows:adtakeover:preparations">
	<title>Vorbereitung</title>
	<para>
	  Es wird empfohlen die folgenden Schritte durchzuführen, bevor die Übernahme initiiert wird:

	  <itemizedlist>
		<listitem><simpara>
		  Ein Backup des/der AD-Server(s) sollte durchgeführt werden.
		</simpara></listitem>

		<listitem><simpara>
		  Sind Benutzeranmeldungen auf dem AD-Server erlaubt (durch Domänenanmeldungen oder
		  Terminalserversitzungen) wird empfohlen diese zu deaktiviert und alle Dienste zu stoppen
		  die Daten verarbeiten (z.B. Mailserver). Dies stellt sicher das durch den Rollback auf ein
		  Backup oder einen Snapshot keine Daten verloren gehen.
		</simpara></listitem>

		<listitem><simpara>
		  Es wird empfohlen auf dem AD-Server dasselbe <systemitem class="username">Administrator</systemitem>-Passwort zu verwenden wie in
		  der UCS-Domäne. Werden verschiedene Passwörter verwendet, wird anhand der Zeitstempel
		  verglichen welches Passwort aktueller ist und dieses verwendet.
		</simpara></listitem>

		<listitem><simpara>
		  In der Grundeinstellung ist das lokale <systemitem class="username">Administrator</systemitem> Konto auf dem
		  AD-Server deaktiviert. Es sollte in der lokalen Benutzerverwaltung aktiviert werden.
		</simpara></listitem>

	  </itemizedlist>
	</para>

	<para>
	  Die Aktivierung des <systemitem class="username">Administrator</systemitem>-Kontos wird empfohlen weil dieses Konto
	  über die nötigen Berechtigungen verfügt um die Gruppenrichtlinien-Dateien in der SYSVOL-Freigabe zu
	  kopieren. Der Benutzer kann entweder im AD-Verwaltungs-Tool für Benutzer und Gruppen
	  oder mit den folgenden Kommandos auf der Kommandozeile aktiviert werden:

	  <programlisting language="sh">
net user administrator /active:yes
net user administrator PASSWORT
	  </programlisting>
	</para>

  </section>

  <section id="windows:adtakeover:migrate">
	<title>Domänenmigration</title>
	<para>
	  Die Übernahme muss auf dem UCS Directory Node gestartet werden, auf dem der Univention S4
	  Connector läuft (normalerweise der &ucsPrimaryDN;). Während der Übernahme sollte Samba nur auf
	  diesem UCS-System laufen. Gibt es weitere UCS Samba/AD Nodes muss Samba auf diesen angehalten
	  werden. Dies ist wichtig um replikationsbedingte Dateninkonsistenzen zu vermeiden.
	</para>

	<para>
	  Andere UCS Samba/AD-Systeme können gestoppt werden, indem auf jedem UCS Directory Node als
	  Benutzer <systemitem class="username">root</systemitem> folgender Befehl ausgeführt wird:

	  <programlisting language="sh">
/etc/init.d/samba4 stop
	  </programlisting>
	</para>

	<para>
	  Nachdem sichergestellt wurde, dass keine anderen Samba/AD-Domänencontroller laufen, kann die
	  Übernahme beginnen. Wurde die UCS-Domäne mit einer UCS-Version vor 3.2 installiert muss zuerst
	  die folgende &ucsUCRV; gesetzt werden:

	  <programlisting language="sh">
ucr set connector/s4/mapping/group/grouptype=false
	  </programlisting>
	</para>

	<para>
	  Die Übernahme erfolgt mit dem &ucsUMC;-Modul <guimenu>Active Directory
	  Takeover</guimenu>. Unter <guimenu>Name oder Adresse des Domänencontrollers</guimenu> muss die
	  IP-Adresse des AD-Systems angegeben werden. Unter <guimenu>Active Directory
	  Administratorkonto</guimenu> muss ein Konto der AD-Domäne angegeben werden, das Mitglied der
	  AD-Gruppe  <systemitem class="groupname">Domain Admins</systemitem> ist (z.B. der
	  <systemitem class="username">Administrator</systemitem>) und unter <guimenu>Active Directory
	  Administratorpasswort</guimenu> das dazugehörige Passwort.
	</para>

	<figure id="windows:ad:takeover1">
	  <title>Erste Phase der Domänenmigration</title>
	  <graphic scalefit="1" width="100%" align="center" fileref="illustrations50/takeover1-de.png"/>
	</figure>

	<para>
	  Das Modul prüft, ob der AD-Domänencontroller erreicht werden kann und zeigt die zu
	  migrierenden Domänendaten an:

	<figure id="windows:ad:takeover2">
	  <title>Übersicht über die zu migrierenden Daten</title>
	  <graphic scalefit="1" width="100%" align="center" fileref="illustrations50/takeover2-de.png"/>
	</figure>
	</para>

	<para>
	  Nach einem Klick auf <guimenu>Weiter</guimenu> werden die folgenden Schritte automatisch
	  durchgeführt. Zusätzliche Informationen werden nach
	  <filename>/var/log/univention/ad-takeover.log</filename>
	  sowie nach <filename>/var/log/univention/management-console-module-adtakeover.log</filename>
	  protokolliert.

	  <itemizedlist>
		<listitem><simpara>
		  Anpassung der Systemzeit des UCS-Systems auf die Systemzeit der Active Directory-Domäne
		  (wenn diese um mehr als drei Minuten nachgeht)
		</simpara></listitem>

		<listitem><simpara>
		  Beitritt des UCS Directory Nodes in die Active Directory-Domäne
		</simpara></listitem>

		<listitem><simpara>
		  Start von Samba und dem Univention S4 Connector zur Replikation der AD-Objekte in das
		  UCS-OpenLDAP-Verzeichnis
		</simpara></listitem>

		<listitem><simpara>
		  Wenn ein Benutzerkonto oder eine Gruppe mit einer "<emphasis>Well Known</emphasis>" RID
		  nach UCS OpenLDAP synchronisiert wird, setzt ein Listener-Modul auf jedem UCS-System
		  lokal eine &ucsUCR; Variable, die dem englischen Namen den nicht-englischen Namen
		  zuordnet. Diese Variablen werden verwendet, um die in den UCS-Konfigurationsdateien
		  verwendeten englischen Begriffe in die im Active Directory verwendeten Namen zu übersetzen.
		  Wenn zum Beispiel <systemitem class="groupname">Domain Admins</systemitem> einen anderen Namen
		  im AD hat, dann wird die &ucsUCR; Variable <envar>groups/default/domainadmins</envar>
		  auf den spezifischen Namen gesetzt
		  (analog für Benutzer, z.B. <envar>users/default/administrator</envar>).
		</simpara></listitem>
	  </itemizedlist>
	</para>

	<para>
	  Nun enthält der UCS Directory Node alle Benutzer, Gruppen und
	  Rechner aus der Active Directory-Domäne. Im nächsten Schritt wird die SYSVOL-Freigabe kopiert,
	  in der u.a. die Gruppenrichtlinien gespeichert werden.
	</para>

	<para>
	  Nun muss eine Anmeldung als <systemitem class="username">Administrator</systemitem> am Active
	  Directory-Domänencontroller erfolgen und dort die Dateien mit den Gruppenrichtlinien aus der
	  SYSVOL-Freigabe des AD-Servers auf den UCS-Server kopiert werden.
	</para>

	<para>
	  Das aufzurufende Kommando wird im UMC-Modul angezeigt. Wenn es erfolgreich aufgerufen wurde,
	  muss mit <guimenu>Weiter</guimenu> bestätigt werden.

	  <figure id="windows:ad:sysvol">
		<title>Kopieren der Sysvol-Freigabe</title>
		<graphic scalefit="1" width="100%" align="center" fileref="illustrations50/takeover3-de.png"/>
	  </figure>

	  Wenn <command>robocopy</command> nicht vorhanden ist, kann es mit den Windows Server 2003
	  Resource Kit Tools nachinstalliert werden. Ab Windows 2008 ist es vorinstalliert.
	</para>

	<para>
	  Hinweis: Die <command>robocopy</command>-Option <parameter class="option">/mir</parameter> spiegelt das Quellverzeichnis mit dem
	  Zielverzeichnis. Es muss beachtet werden das bei einem erneuten Aufruf des Tools Dateien, die
	  im Quellverzeichnis gelöscht wurden auch im Zielverzeichnis gelöscht werden.
	</para>

	<para>
	  Nach erfolgreichem Abschluss dieser Schritte sollten der/die AD-Domänencontroller
	  heruntergefahren werden. Anschließend muss im UMC-Modul auf <guimenu>Weiter</guimenu> geklickt
	  werden.

	  <figure id="windows:ad:shutdown">
		<title>Herunterfahren des/der AD-Systeme</title>
		<graphic scalefit="1" width="100%" align="center" fileref="illustrations50/takeover4-de.png"/>
	  </figure>
	</para>

	<para>
	  Die folgenden Schritte werden nun automatisch durchgeführt:

	  <itemizedlist>
		<listitem><simpara>
		  Übertragung der FSMO-Rollen auf den UCS Directory Node. Diese kennzeichnen verschiedene
		  Aufgaben, die ein Server in einer AD-Domäne übernehmen kann.
		</simpara></listitem>

		<listitem><simpara>
		  Einrichten des Rechnernamens des AD-Servers als DNS-Alias (siehe <xref
		  linkend="ip-config:CNAME-Record_Alias-Records"/>) für den UCS-Server
		</simpara></listitem>

		<listitem><simpara>
		  Konfiguration der IP-Adresse des AD-Servers als zusätzliche virtuelle IP-Adresse des UCS-Servers
		</simpara></listitem>

		<listitem><simpara>
		  Verschiedene Anpassungen, z.B. Entfernen des alten AD-Domänencontroller-Eintrags aus der
		  Samba SAM-Datenbank.
		</simpara></listitem>

		<listitem><simpara>
		  Abschließender Neustart von Samba und DNS-Server
		</simpara></listitem>
	  </itemizedlist>
	</para>

  </section>

  <section id="windows:adtakeover:finalsteps">
	<title>Abschluss der Übernahme</title>
	<para>
	  Abschließend  müssen noch die folgenden Schritte durchgeführt werden:

	  <itemizedlist>
		<listitem><simpara>
		  Der Domänenfunktionslevel der migrierten AD-Domäne muss mit dem folgenden Kommando geprüft
		  werden:
		  </simpara>
		  <programlisting language="sh">
samba-tool domain level show
		  </programlisting>
		  <simpara>
		  Wenn das Kommando die Meldung <foreignphrase>ATTENTION: You run SAMBA 4 on a forest function
		  level lower than Windows 2000 (Native)</foreignphrase> anzeigt müssen die folgenden Befehle
		  aufgerufen werden:
		  </simpara>
		  <programlisting language="sh">
samba-tool domain level raise --forest-level=2003 --domain-level=2003
samba-tool dbcheck --fix --yes
		  </programlisting>
		</listitem>

		<listitem><simpara>
		  Gab es in der migrierten AD-Domäne mehr als einen Domänencontroller, müssen die
		  Rechnerkonten der weiteren Domänencontroller in der Rechnerverwaltung der UMC gelöscht
		  werden. Außerdem müssen sie aus der Samba SAM-Datenbank gelöscht werden. Dies kann
		  erfolgen, indem von einem migrierten Windows-Client eine Anmeldung als Mitglied der Gruppe
		  <systemitem class="groupname">Domain Admins</systemitem> erfolgt und das AD-Verwaltungstool für Benutzer und
		  Computer aufgerufen wird.
		</simpara></listitem>

		<listitem><simpara>
		  Gibt es weitere Samba-Domänencontroller, müssen diese neu der Domäne beitreten.
		</simpara></listitem>

		<listitem><simpara>
		  Alle Windows-Clients müssen neu gestartet werden.
		</simpara></listitem>
	  </itemizedlist>
	</para>
  </section>

  <section id="windows:adtakeover:tests">
	<title>Tests</title>
	<para>
	  Es wird empfohlen nach der Übernahme gründliche Tests mit Windows-Clients durchzuführen, z.B.:

	  <itemizedlist>
		<listitem><simpara>
		  Anmeldung auf einem migrierten Client mit einem migrierten Benutzer
		</simpara></listitem>

		<listitem><simpara>
		  Anmeldung auf einem migrierten Client als Administrator
		</simpara></listitem>

		<listitem><simpara>
		  Test der Gruppenrichtlinien
		</simpara></listitem>

		<listitem><simpara>
		  Domänenbeitritt eines neuen Windows-Clients
		</simpara></listitem>

		<listitem><simpara>
		  Anlegen eines neuen Benutzers und Anmeldung an einem Windows-Client
		</simpara></listitem>
	  </itemizedlist>
	</para>
  </section>

</section>


<section id="windows_trust">
  <title>Vertrauensstellungen</title>
  <para>
	Vertrauensstellungen zwischen Domänen ermöglichen es den Benutzern
	einer Domäne, sich an Rechnern einer anderen Domäne anzumelden.
  </para>

  <para>
	Vertrauensstellungen können unidirektional oder bidirektional eingerichtet werden. Technisch
	entspricht eine bidirektionale Vertrauensstellung zwei unidirektional konfigurierten
	Vertrauensstellungen in beide Richtungen.
  </para>

  <para>
	Die Terminologie von Vertrauensstellungen hängt von der Perspektive der vertrauenden oder
	der vertrauten Domäne ab: Aus Sicht der vertrauenden Domäne ist die Vertrauensstellung
	<emphasis>ausgehend</emphasis> und aus Sicht der vertrauten Domäne <emphasis>eingehend</emphasis>.
  </para>

  <para>
	Ausgehende Vertrauensstellungen (UCS vertraut Windows) werden
	in Samba/AD-Domänen nicht unterstützt. Entsprechend werden auch
	keine bidirektionalen Vertrauensstellungen unterstützt.
  </para>

  <para>
	Während der Einrichtung und Nutzung von Vertrauensstellungen müssen sich die
	Domänencontroller der beiden Domänen über das Netzwerk erreichen und
	gegenseitig per DNS identifizieren können.
	Zumindest die voll qualifizierten DNS Namen der Domänencontroller der
	jeweils anderen Domäne müssen auflösbar sein, damit die Kommunikation
	zwischen den Domänen funktioniert. In beiden Domänen richtet man zu
	diesem Zweck eine bedingtes DNS Weiterleitung ein.
  </para>

  <para>
	  Für das folgende Beispiel sei angenommen, dass der UCS Samba/AD DC &ucsPrimaryDN;
	  <systemitem class="fqdomainname">primary.ucsdom.example</systemitem> die IP-Adresse
	  <systemitem class="ipaddress">192.0.2.10</systemitem> hat und dass der
	  Active Directory Domänencontroller
	  <systemitem class="fqdomainname">dc1.addom.example</systemitem> der entfernten Domäne
	  die IP-Adresse <systemitem class="ipaddress">192.0.2.20</systemitem> hat.
  </para>

  <para>
	  Auf der UCS-Seite lässt sich die bedingte Weiterleitung
	  von DNS-Anfragen mit folgenden Schritten als <systemitem class="username">root</systemitem>
	  einrichten:
  </para>

  <programlisting language="sh"><![CDATA[
cat >> /etc/bind/local.conf.samba4 <<%EOR

zone "addom.example" {
type forward;
forwarders { 192.0.2.20; };
};
%EOR
service bind9 restart
]]>
  </programlisting>

  <para>
	  Der Erfolg kann mit überprüft werden mit <command>host dc1.addom.example</command>.
  </para>


  <para>
	  Zusätzlich kann es sinnvoll sein, für den Domänencontroller der
	  entfernten Active Directory Domäne einen statischen Eintrag in der
	  Datei <filename>/etc/hosts</filename> anzulegen:
  </para>

  <programlisting language="sh">
ucr set hosts/static/192.0.2.20=dc1.addom.example
  </programlisting>

  <para>
	  Auf dem Windows AD DC kann über die <guilabel>DNS-Server Konsole</guilabel>
	  eine sogenannte <phrase>Bedingte Weiterleitung</phrase>
	  (<foreignphrase>Conditional Forwarding</foreignphrase>) für die UCS-Domäne
	  eingerichtet werden.
  </para>

  <para>
	  Nach dieser Vorarbeit kann die Vertrauensstellung
	  direkt von der Kommandozeile des UCS Samba/AD DCs eingerichtet werden.
  </para>

  <para>
	  Vertrauensstellungen können nur auf Domänencontrollern eingerichtet werden,
	  gelten dann aber für die gesamte Domäne.
  </para>

  <para>
	  In Samba/AD Domänen ist diese Konstellation sehr einfach
	  an der Kommandozeile über das Werkzeug <command>samba-tool</command> einzurichten:
  </para>

  <programlisting language="sh">
samba-tool domain trust create addom.example \
           -k no -UADDOM\\Administrator%ADAdminPassword \
           --type=external --direction=incoming
  </programlisting>

  <para>
	Mit folgenden Kommandos kann die Vertrauensstellung überprüft werden:
  </para>

  <programlisting language="sh">
samba-tool domain trust list
wbinfo --ping-dc –domain=addom.example
wbinfo --check-secret –domain=addom.example
  </programlisting>

  <para>
	Nach der Einrichtung sollte sich ein Benutzer an Systemen
	der Windows Active Directory Domäne anmelden können.
	Als Login-Name muss dabei entweder das Format <systemitem class="username">UCSDOM\username</systemitem>
	oder der Kerberos Prinzipal in der Notation
	<systemitem class="username">username@ucsdom.example</systemitem> angegeben werden.
  </para>
</section>

</chapter>
