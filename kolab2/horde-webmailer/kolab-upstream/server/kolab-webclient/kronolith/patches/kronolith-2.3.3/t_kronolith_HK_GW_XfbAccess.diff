From: Gunnar Wrobel <p@rdus.de>
Subject: [PATCH] t/kronolith/HK/GW/XfbAccess

Allows to set the extended free/busy view access parameters via the calendar settings.

Signed-off-by: Gunnar Wrobel <p@rdus.de>

---
 perms.php                 |   48 ++++++++++++++++++
 templates/perms/perms.inc |   55 +++++++++++++++++++++
 2 files changed, 103 insertions(+), 0 deletions(-)

diff --git a/perms.php b/perms.php
index f9bed71..4966bd4 100644
--- a/perms.php
+++ b/perms.php
@@ -15,6 +15,34 @@
 require_once KRONOLITH_BASE . '/lib/base.php';
 require_once 'Horde/Group.php';
 
+function &getFbperms($share) 
+{
+    $fbperms = array();
+    $params = $share->get('params');
+    if (!is_a($params, 'PEAR_Error')) {
+        $params = @unserialize($params);
+        if (isset($params['xfbaccess'])) {
+            $xfbusers = $params['xfbaccess'];
+            foreach ($xfbusers as $user) {
+                $fbperms[$user] = PERMS_READ;
+            }
+        }
+    }
+    return $fbperms;
+}
+
+function setFbperms($share, $xfbusers)
+{
+    $fbperms = array();
+    $params = $share->get('params');
+    if (!is_a($params, 'PEAR_Error')) {
+        $params = @unserialize($params);
+        $params['xfbaccess'] = $xfbusers;
+        $params = serialize($params);
+        $share->set('params', $params);
+    }
+}
+
 $shares = &Horde_Share::singleton('kronolith');
 $groups = &Group::singleton();
 $auth = &Auth::singleton($conf['auth']['driver']);
@@ -36,6 +64,8 @@ case 'edit':
         $notification->push($share, 'horde.error');
     } elseif (isset($share) && Auth::getAuth() != $share->get('owner')) {
         exit('permission denied');
+    } else {
+        $fbperms = getFbperms($share);
     }
     break;
 
@@ -226,6 +256,24 @@ case 'editform':
             }
         }
 
+        // Process free/busy permissions.
+        $fb_names = Util::getFormData('fb_names');
+        $fb_read = Util::getFormData('fb_read');
+
+        $fbperms = getFbperms($share);
+        foreach ($fb_names as $key => $user) {
+            if (empty($user)) {
+                continue;
+            }
+
+            if (!empty($fb_read[$key])) {
+                $fbperms[$user] = PERMS_READ;
+            } else {
+                unset($fbperms[$user]);
+            }
+        }
+        setFbperms($share, array_keys($fbperms));
+
         $result = $share->setPermission($perm, false);
         if (is_a($result, 'PEAR_Error')) {
             $notification->push($result, 'horde.error');
diff --git a/templates/perms/perms.inc b/templates/perms/perms.inc
index 4ca65a6..2174167 100644
--- a/templates/perms/perms.inc
+++ b/templates/perms/perms.inc
@@ -330,6 +330,61 @@ foreach ($userList as $user) {
   <td>&nbsp;</td>
 </tr>
 
+<!-- Extended free/busy Permissions -->
+<tr valign="middle">
+  <td class="header leftAlign">
+    <?php echo Horde::img('user.png', '', '', $registry->getImageDir('horde')) . '&nbsp;' . _("Extended free/busy access") ?>
+  </td>
+  <td class="header" align="center">&nbsp;</td>
+  <td class="header" align="center"><?php echo _("Read") ?></td>
+  <td class="header" align="center">&nbsp;</td>
+  <td class="header" align="center">&nbsp;</td>
+  <td class="header" align="center">&nbsp;</td>
+  <td class="header">&nbsp;</td>
+</tr>
+<?php foreach ($fbperms as $user => $fbperm) { if ($user != $owner) { ?>
+<tr>
+  <td class="light"><?php echo htmlspecialchars(Auth::removeHook($user)) ?><input type="hidden" name="fb_names[<?php echo htmlspecialchars($user) ?>]" value="<?php echo htmlspecialchars($user) ?>" /></td>
+  <td align="center">&nbsp;</td>
+  <td align="center">
+    <input type="checkbox" id="fb_read_<?php echo str_replace('@', '_', htmlspecialchars($user)) ?>" name="fb_read[<?php echo htmlspecialchars($user) ?>]"<?php echo ($fbperm & PERMS_READ) ? ' checked="checked"' : '' ?> />
+    <label for="fb_read_<?php echo str_replace('@', '_', htmlspecialchars($user)) ?>" class="hidden"><?php echo _("Read") ?></label>
+  </td>
+  <td align="center">&nbsp;</td>
+  <td align="center">&nbsp;</td>
+  <td align="center">&nbsp;</td>
+  <td>&nbsp;</td>
+</tr>
+<?php } } ?>
+<!-- New extended free/busy row -->
+<tr>
+<?php if ($auth->hasCapability('list')): ?>
+  <td class="light">
+    <label for="fb_names_new" class="hidden"><?php echo _("Select a user to add:") ?></label>
+    <select id="fb_names_new" name="fb_names[||new]">
+      <option value=""><?php echo _("Select a user to add:") ?></option>
+    <?php foreach ($userList as $user) { if (!isset($fbperms[$user])) { ?>
+      <option value="<?php echo htmlspecialchars($user) ?>"><?php echo htmlspecialchars(Auth::removeHook($user)) ?></option>
+    <?php } } ?>
+    </select>
+  </td>
+<?php else: ?>
+  <td class="light">
+    <label for="fb_names_new" class="hidden"><?php echo _("User to add:") ?></label>
+    <input type="text" id="fb_names_new" name="fb_names[||new]" />
+  </td>
+<?php endif; ?>
+  <td align="center">&nbsp;</td>
+  <td align="center">
+    <input type="checkbox" id="fb_read_new" name="fb_read[||new]" />
+    <label for="fb_read_new" class="hidden"><?php echo _("Read") ?></label>
+  </td>
+  <td align="center">&nbsp;</td>
+  <td align="center">&nbsp;</td>
+  <td align="center">&nbsp;</td>
+  <td>&nbsp;</td>
+</tr>
+
 <tr>
  <td colspan="7">&nbsp;</td>
 </tr>
--- a/po/de_DE.po	2010-03-05 14:12:23.870442274 +0100
+++ b/po/de_DE.po	2010-03-05 14:26:38.598825847 +0100
@@ -2709,3 +2709,6 @@
 
 msgid "no one"
 msgstr "niemanden"
+
+msgid "Extended free/busy access"
+msgstr "Erweiterter Frei/Gebucht Zugriff"

-- 
tg: (0175a71..) t/kronolith/HK/GW/XfbAccess (depends on: t/kronolith/HK/GW/FbviewRelevance)
-- 
TOPGIT patch commit log
=======================

commit 2d1588fad36f7b13bb534d70f14aa4f75ef8d35f
Author: Gunnar Wrobel <p@rdus.de>
Date:   Sun Feb 1 22:29:11 2009 +0000

    Added patch kronolith/HK-GW-Fbview_xfb_access.patch from the mercurial release queue.
