#!/usr/share/ucs-test/runner bash
## desc: "Checking domain join and ntlm authentication"
## exposure: safe
## packages:
##  - winbind
##  - univention-config
##  - univention-directory-manager-tools
##  - univention-samba
## roles-not: 
## - basesystem
## - memberserver
## tags:
##  - basic
##  - apptest
## join: true

. "$TESTLIBPATH/base.sh" || exit 137
. "$TESTLIBPATH/user.sh" || exit 137

username="$(user_randomname)"
password=univention

## delete user
trap 'user_remove "$username"' INT TERM EXIT

echo "----Create Domain Admin"
## create samba domain admin
udm-test users/user create --option posix --option samba \
	--set "primaryGroup=cn=Domain Admins,cn=groups,$ldap_base" \
	--set "password=$password" \
	--set "lastname=$username" \
	--set "username=$username" \
	--position "cn=users,$ldap_base" 
if [ "$?" != 0 ];then
	fail_fast 1 "could not create domain admin"
fi

##wait for the user to be created
echo "----wait for the user to be created"
i=0
while ! output="$(net rpc user info $username -U"$username%$password" 2>&1)"
do
	let i="$i"+1
	sleep 1
	if [ "$i" = 20 ]; then
		echo "$output"
		echo "TIMEOUT: The user which has been created in UDM could not be found in samba after $i seconds"
		break
	fi
done

## start/restart winbind
echo "----restart winbind"
/etc/init.d/winbind restart
if [ "$?" != 0 ];then
	fail_fast 1 "could not restart winbind"
fi

## ntml auth
echo "----ntml auth with a wrong password (should fail)"
ntlm_auth --domain="$windows_domain" --username="$username" --password="${password}2"
if [ "$?" = 0 ];then
	fail_fast 1 "ntlm_auth was sucessful with an wrong password"
fi

echo "----ntml auth with a wrong username (should fail)"
ntlm_auth --domain="$windows_domain" --username="${username}2" --password="${password}"
if [ "$?" = 0 ];then
	fail_fast 1 "ntlm_auth was sucessful with an wrong username"
fi

echo "----ntml auth with correct credentials"
ntlm_auth --domain="$windows_domain" --username="$username" --password="$password"
if [ "$?" != 0 ];then
	fail_fast 1 "ntlm_auth failed"
fi


exit 0
