#!/usr/share/ucs-test/runner python
## desc: Postfix accepts mails on port 25, 465 and 587
## tags: [apptest]
## exposure: dangerous
## packages:
##  - univention-mail-server


import time
from essential.mail import send_mail, check_delivery
from univention.config_registry import handler_set
import univention.testing.ucr as ucr_test
import univention.testing.utils as utils


def main():
	logfiles = ['/var/log/mail.log']
	with ucr_test.UCSTestConfigRegistry() as ucr:
		with utils.FollowLogfile(logfiles=logfiles) as flf:
			fqdn = '%s.%s' % (ucr.get('hostname'), ucr.get('domainname'))
			handler_set(['mail/alias/root=systemmail@%s' % fqdn])
			recipient = 'root@%s' % fqdn

			for kwargs in [
				{"port": 25, "tls": True},
				{"port": 465, "ssl": True},
				{"port": 587, "tls": True}]:
					token = str(time.time())
					send_mail(recipients=recipient, msg=token, **kwargs)
					check_delivery(token, recipient, True)


if __name__ == '__main__':
	main()

# vim: set ft=python ts=4 sw=4 noet :
