#!/usr/share/ucs-test/runner bash
## desc: Checking whether failed.ldif is created with right permissions.
## tags:
##  - replication
## roles:
##  - domaincontroller_backup
##  - domaincontroller_slave
## packages:
##  - univention-config
##  - univention-directory-manager-tools
##  - ldap-utils
## exposure: dangerous

. "$TESTLIBPATH/base.sh" || exit 137

testldif () {
	echo -n "testing $1"

	declare -i PERM="$(stat -c %a "$1")"
	OWNER="$(stat -c %U "$1")"
	declare -i GROUP_PERM="${PERM:1:1}"
	declare -i OTHERS_PERM="${PERM:2:1}"

	if [ "$GROUP_PERM" -gt 0 ]; then
		fail_test 1 "Wrong group permissions $PERM on file $1"
	elif [ "$OTHERS_PERM" -gt 0 ]; then
		fail_test 1 "Wrong other users permissions $PERM on file $1"
	elif [ "$OWNER" != "root" ]; then
		echo "... Wrong owner $OWNER (not root) on file $1"
		fail_test 1
	else
		echo " ... was ok."
	fi
}

#check if master ldap-server can be reached
univention-ldapsearch -h "$ldap_master" -p "$ldap_master_port" -x uid=Administrator |
	grep -q "# numEntries: 1" ||
	exit 120

#START TEST
ldif_path="/var/lib/univention-directory-replication"
ldif="$ldif_path/failed.ldif"

/etc/init.d/slapd stop

# modify $server_role to create failed.ldif file (because slapd is off)
univention-directory-manager "computers/$server_role" modify \
	--binddn "$ldap_hostdn" \
	--bindpwd "$(cat /etc/machine.secret)" \
	--dn "$ldap_hostdn" \
	--set password="$(cat /etc/machine.secret)" ||
	fail_test 1

echo "Wait until failed.ldif is created. Should take max. 6 min..."
# "replication.py" --> "time.sleep(10)" --> (approx. 30*10 seconds) 5 min. waiting for failed.ldif plus 1 minute of tolerance
count=0
while [ $count -le 360 -a ! -e "$ldif" ]
do
	sleep 1s
	count=`expr $count + 1`
done

if ! [ -e "$ldif" ] #failed ldif not exists
then
	fail_test 1 "File not created"
else
	testldif "$ldif"
fi

/etc/init.d/slapd start

for replayed in "$ldif_path"/replayed.ldif_*
do
	testldif "$replayed"
done

# Workaround for Bug #33050
#  https://forge.univention.org/bugzilla/show_bug.cgi?id=33050
ucr commit /etc/samba/smb.conf
for srv in samba smaba4 winbind; do
	test -x /etc/init.d/$srv && invoke-rc.d $srv restart
done

exit "$RETVAL"
