[Global]
docker_image: gitregistry.knut.univention.de/univention/dist/vnc-automate
logfile: autotest-install-net-installer.log

kvm_server: [ENV:KVM_BUILD_SERVER]
kvm_user: [ENV:KVM_USER]
kvm_extra_label: install-test-net-installer-[ENV:UCS_VERSION]

kvm_architecture: amd64
kvm_memory: [ENV:KVM_MEMORY]

kvm_dhcp: false
kvm_network: install-net-nodhcp
kvm_connect: false
kvm_copy_files: false

parallel: true
recover: 5
# 1: setup Master/Primary
# 2: setup Slave/Replica
# 3: run tests on Master/Primary
# 4: run tests on Slave/Replica
# 5: collect results

[pxeclient]
kvm_operating_system: Others
kvm_template: pxeboot
kvm_ucsversion: ucs
command1:
command2:
 RESET
command3:
 LOCAL vncdo -s [SELF_VNC_DISPLAY] key bsp pause 3 type "root" key enter pause 1 type "univention" key enter pause 3
 # Activate the "external" NIC:
 LOCAL vncdo -s [SELF_VNC_DISPLAY] type "ifconfig ens8 up" key enter pause 5
 # Join the domain:
 echo -n "univention" > Administrator_password
 univention-join -dcaccount Administrator -dcpwd Administrator_password
 COPY_FILES
 . utils.sh && add_tech_key_authorized_keys
 . utils.sh && basic_setup
 . utils.sh && assert_packages univention-server-slave
 . utils.sh && assert_join
 # workaround Bug 49042
 ucr unset hosts/static/127.0.1.1
 . utils.sh && do_reboot
 LOCAL sleep 120
 . utils.sh && wait_for_reboot
 ucr set repository/online/server='http://updates-test.knut.univention.de/' repository/online/prefix='' update/secure_apt='yes'
 . utils.sh && set_repository_if_testing "[ENV:RELEASE_UPDATE]"
 . utils.sh && TARGET_VERSION="[ENV:TARGET_VERSION]" ERRATA_UPDATE="[ENV:ERRATA_UPDATE]" RELEASE_UPDATE="[ENV:RELEASE_UPDATE]" jenkins_updates
 . utils.sh && install_ucs_test_checks_from_errata_test
 . utils.sh && run_minimal_tests
command5:
 . utils.sh && prepare_results
 LOCAL utils/utils-local.sh fetch-results [SELF_IP] client
files:
 ~/ec2/scripts/activate-errata-test-scope.sh /root/

[pxeserver]
kvm_operating_system: Others
kvm_template: 50GiB
kvm_ucsversion: empty
kvm_iso: [ENV:SOURCE_ISO]
command1:
  LOCAL utils/installation_test/vnc-install-ucs.py --vnc "[SELF_VNC_DISPLAY]" --language deu --role master --fqdn master.netinstaller.test --ip 192.168.153.[ENV:NETINSTALL_IP1]
  COPY_FILES
  . utils.sh && add_tech_key_authorized_keys
  . utils.sh && basic_setup
  . utils.sh && assert_packages univention-server-master
  . utils.sh && assert_join
  univention-install -y univention-net-installer univention-dhcp
  univention-repository-create -n
  . utils-installation-test.sh && write_slave1_preseed
  udm policies/dhcp_boot create --position "cn=policies,`ucr get ldap/base`" --set "name=pxe_boot" --set "boot_filename=pxelinux.0"
  udm policies/dhcp_routing create --position "cn=policies,`ucr get ldap/base`" --set "name=pxe_routing" --set "routers=192.168.153.1"
  udm policies/dhcp_dns create --position "cn=policies,`ucr get ldap/base`" --set "name=pxe_dns" --set "domain_name=netinstaller.test" --set "domain_name_servers=192.168.153.[ENV:NETINSTALL_IP1]"
  udm dhcp/subnet modify --dn "cn=192.168.153.0,cn=`ucr get domainname`,cn=dhcp,`ucr get ldap/base`" --set "broadcastaddress=192.168.153.255" --set "range=192.168.153.[ENV:NETINSTALL_IP2] 192.168.153.[ENV:NETINSTALL_IP2]" --set "subnet=192.168.153.0" --set "subnetmask=24" --policy-reference "cn=pxe_boot,cn=policies,`ucr get ldap/base`" --policy-reference "cn=pxe_routing,cn=policies,`ucr get ldap/base`" --policy-reference "cn=pxe_dns,cn=policies,`ucr get ldap/base`"
  ucr set pxe/installer/ipappend=15
  udm computers/domaincontroller_slave create --position "cn=dc,cn=computers,`ucr get ldap/base`" --set "name=slave1" --set "dhcpEntryZone=cn=`ucr get domainname`,cn=dhcp,`ucr get ldap/base` 192.168.153.[ENV:NETINSTALL_IP2] [pxeclient_NETWORK_MAC]" --set "dnsEntryZoneForward=zoneName=`ucr get domainname`,cn=dns,`ucr get ldap/base` 192.168.153.[ENV:NETINSTALL_IP2]" --set "dnsEntryZoneReverse=zoneName=153.168.192.in-addr.arpa,cn=dns,`ucr get ldap/base` 192.168.153.[ENV:NETINSTALL_IP2]" --set "domain=`ucr get domainname`" --set "groups=cn=DC Slave Hosts,cn=groups,`ucr get ldap/base`" --set "instprofile=slave1_preseed" --set "ip=192.168.153.[ENV:NETINSTALL_IP2]" --set "mac=[pxeclient_NETWORK_MAC]" --set "name=slave1" --set "network=cn=default,cn=networks,`ucr get ldap/base`" --set "primaryGroup=cn=DC Slave Hosts,cn=groups,`ucr get ldap/base`" --set "reinstall=1" --set "reinstalloption=auto=true priority=critical interface=ens7" --set "serverRole=slave"
command2:
  . utils-installation-test.sh && wait_for_umc 192.168.153.[ENV:NETINSTALL_IP2]
command3:
  ucr set repository/online/server='http://updates-test.knut.univention.de/' repository/online/prefix='' update/secure_apt='yes'
  . utils.sh && set_repository_if_testing "[ENV:RELEASE_UPDATE]"
  . utils.sh && TARGET_VERSION="[ENV:TARGET_VERSION]" ERRATA_UPDATE="[ENV:ERRATA_UPDATE]" RELEASE_UPDATE="[ENV:RELEASE_UPDATE]" jenkins_updates
  . utils.sh && install_ucs_test_checks_from_errata_test
command4:
  . utils.sh && run_minimal_tests
command5:
  . utils.sh && prepare_results
  LOCAL utils/utils-local.sh fetch-results [SELF_IP] server
files:
  ~/ec2/scripts/activate-errata-test-scope.sh /root/
