#!/bin/sh
#
# Univention LDAP Server
#  postinst script for the debian package
#
# Copyright 2001-2010 Univention GmbH
#
# http://www.univention.de/
#
# All rights reserved.
#
# The source code of this program is made available
# under the terms of the GNU Affero General Public License version 3
# (GNU AGPL V3) as published by the Free Software Foundation.
#
# Binary versions of this program provided by Univention to you as
# well as other copyrighted, protected or trademarked materials like
# Logos, graphics, fonts, specific documentations and configurations,
# cryptographic keys etc. are subject to a license agreement between
# you and Univention and not subject to the GNU AGPL V3.
#
# In the case you use this program under the terms of the GNU AGPL V3,
# the program is provided in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public
# License with the Debian GNU/Linux or Univention distribution in file
# /usr/share/common-licenses/AGPL-3; if not, see
# <http://www.gnu.org/licenses/>.

# check for running slapd first
if [ -n "$(pidof slapd)" ]; then
	slapd_was_running=yes
fi

# { # function definitions
stop_slapd ()
{
	if test -x /etc/init.d/slapd; then
		/etc/init.d/slapd stop
		sleep 1
	fi
}

restart_slapd ()
{
	/etc/init.d/slapd stop
	sleep 1
	if [ -n "$(pidof slapd)" ]; then
		killall slapd
		sleep 1
		if [ -n "$(pidof slapd)" ]; then
			killall -9 slapd
			sleep 1
		fi
	fi
	/etc/init.d/slapd start
}
# } # end of function definitions

touch /etc/ldap/rootpw.conf

univention-config-registry set ldap/autostart?yes

#DEBHELPER#

eval `univention-config-registry shell server/role`

if [ "$server_role" = "domaincontroller_master" ]; then
	univention-config-registry set ldap/translogfile?"/var/lib/univention-ldap/listener/listener"
fi

univention-config-registry set ldap/debug/level?0
univention-config-registry set ldap/port?389
univention-config-registry set ldap/database/type?bdb
univention-config-registry set ldap/sizelimit?400000
univention-config-registry set ldap/cachesize?20000
univention-config-registry set ldap/idlcachesize?20000
univention-config-registry set ldap/idletimeout?0
univention-config-registry set ldap/threads?16
univention-config-registry set ldap/acl/user/kolab2/change?yes
univention-config-registry set ldap/acl/user/password/change?no
univention-config-registry set ldap/acl/slavepdc?yes
univention-config-registry set ldap/acl/nestedgroups?yes
univention-config-registry set ldap/database/bdb/db_config_options?"set_flags"
univention-config-registry set ldap/database/bdb/set_flags?"DB_LOG_AUTOREMOVE"
univention-config-registry set ldap/maxopenfiles?4096 # Bug #17705

# this update-block used to be called much later, now it is just here for documentation
if [ "$1" = configure -a -n "$2" ] && dpkg --compare-versions "$2" lt 4.0.11-1; then
	eval `univention-config-registry shell ldap/cachesize`
	if [ "$ldap_cachesize" = "10000000" ]; then
		# adjust to a more moderate setting, other cache layers need memory too
		univention-config-registry set ldap/cachesize=20000
	fi
fi

# UDM Property Attributes
udm_prop_attrs="univentionUDMPropertyVersion,univentionUDMPropertyModule,univentionUDMPropertyShortDescription,univentionUDMPropertyLongDescription,univentionUDMPropertySyntax,univentionUDMPropertyMultivalue,univentionUDMPropertyDefault,univentionUDMPropertyLdapMapping,univentionUDMPropertyObjectClass,univentionUDMPropertyDeleteObjectClass,univentionUDMPropertyValueMayChange,univentionUDMPropertyLayoutTabName,univentionUDMPropertyLayoutOverwriteTab,univentionUDMPropertyLayoutOverwritePosition,univentionUDMPropertyLayoutPosition,univentionUDMPropertyCLIName,univentionUDMPropertyTranslationShortDescription,univentionUDMPropertyTranslationLongDescription,univentionUDMPropertyTranslationTabName,univentionUDMPropertyOptions,univentionUDMPropertyLayoutTabAdvanced,univentionUDMPropertyValueRequired,univentionUDMPropertyHook,univentionUDMPropertyDoNotSearch"
# recommended index settings
recommended_ldap_index_eq="objectClass,uidNumber,gidNumber,memberUid,ou,uid,cn,sn,givenName,mail,description,displayName,sambaSID,sambaPrimaryGroupSID,sambaDomainName,uniqueMember,macAddress,dhcpHWAddress,krb5PrincipalName,aRecord,relativeDomainName,pTRRecord,zoneName,mailPrimaryAddress,mailAlternativeAddress,univentionServerRole,univentionService,kolabHomeServer,automountInformation,sambaAcctFlags,univentionPolicyReference,homeDirectory,$udm_prop_attrs,univentionLicenseModule,cNAMERecord,univentionNagiosHostname,univentionLicenseObject,sambaSIDList,sambaGroupType,univentionShareGid,univentionShareSambaName,univentionShareWriteable,secretary"
recommended_ldap_index_pres="objectClass,uidNumber,gidNumber,memberUid,ou,uid,cn,sn,givenName,mail,description,displayName,uniqueMember,macAddress,dhcpHWAddress,krb5PrincipalName,aRecord,mailPrimaryAddress,mailAlternativeAddress,kolabHomeServer,univentionPolicyReference,homeDirectory,automountInformation,zoneName,relativeDomainName,name,$udm_prop_attrs"
recommended_ldap_index_sub="uid,cn,sn,givenName,mail,description,displayName,mailPrimaryAddress,mailAlternativeAddress,default,zoneName,sambaSID,automountInformation"
recommended_ldap_index_approx="uid,mail,alias,cn,sn,givenName"

univention-config-registry set ldap/index/autorebuild?yes
eval $(univention-config-registry shell ldap/index/autorebuild ldap/replog)

if ! shopt -q nocasematch; then
	RESTORE_NOCASEMATCH=yes
	shopt -s nocasematch
fi

if [[ "$ldap_replog" =~ ^("true"|"yes")$ ]]; then
	test -f /var/lib/univention-ldap/replog/replog || \
		touch /var/lib/univention-ldap/replog/replog
	chmod 0600 /var/lib/univention-ldap/replog/replog
	test -f /var/lib/univention-ldap/replog/replog.lock || \
		touch /var/lib/univention-ldap/replog/replog.lock
fi

merge_csv_unique_sorted() {
	if [ "$(echo $1)" == "none" ]; then
		old=''
	else
		old="$1"
	fi
	echo -n "$(echo  -n "$old,$2" | tr "," "\n" | egrep -v "^$" | sort -u  | tr "\n" "," | sed -e 's/,$//')"
}

if [[ "$ldap_index_autorebuild" =~ ^("true"|"yes")$ ]]; then
	# merge csv lists of current and recommended attributes
	eval $(univention-config-registry shell ldap/index/eq ldap/index/pres ldap/index/sub ldap/index/approx)
	merged_ldap_index_eq="$(merge_csv_unique_sorted "$ldap_index_eq" "$recommended_ldap_index_eq")"
	merged_ldap_index_pres="$(merge_csv_unique_sorted "$ldap_index_pres" "$recommended_ldap_index_pres")"
	merged_ldap_index_sub="$(merge_csv_unique_sorted "$ldap_index_sub" "$recommended_ldap_index_sub")"
	merged_ldap_index_approx="$(merge_csv_unique_sorted "$ldap_index_approx" "$recommended_ldap_index_approx")"

	stop_slapd
	univention-config-registry set ldap/index/eq="$merged_ldap_index_eq" \
                                   ldap/index/pres="$merged_ldap_index_pres" \
                                   ldap/index/sub="$merged_ldap_index_sub" \
                                   ldap/index/approx="$merged_ldap_index_approx"
	# run slapindex and selectively filter out this unsettling warning from stderr
	{ /usr/sbin/slapindex  2>&1 >&3 | sed -e "/Runnig as root\!/,/There's a fair chance slapd will fail to start./d" >&2; } 3>&1
else
	univention-config-registry set ldap/index/eq?"$recommended_ldap_index_eq" \
                                   ldap/index/pres?"$recommended_ldap_index_pres" \
                                   ldap/index/sub?"$recommended_ldap_index_sub" \
                                   ldap/index/approx?"$recommended_ldap_index_approx"
fi
[ -n "$RESTORE_NOCASEMATCH" ] && shopt -u nocasematch

test -f /var/lib/univention-ldap/ldap/DB_CONFIG || univention-config-registry commit /var/lib/univention-ldap/ldap/DB_CONFIG

if [ "$server_role" = "domaincontroller_master" ] || [ "$server_role" = "domaincontroller_backup" ]; then
	/usr/lib/univention-install/01univention-ldap-server-init.inst || true
	/usr/lib/univention-install/10univention-ldap-server.inst || true
fi

## after this line slapd.conf is expected to be updated properly and slapd may restart

if [ "$1" = "configure" -a -n "$2" ];
	then
	if test -x /etc/init.d/slapd
		then
        # always start on master, slapd may be down by schema-conflicts which are cleared by a new slapd.conf-template
		if [ "$server_role" = "domaincontroller_master" ]
			then
			restart_slapd
		else
			#/etc/init.d/slapd crestart
			if [ -n "$slapd_was_running" ]; then
				restart_slapd
			fi
		fi
	fi
else
	if [ "$1" = "configure" ]
		then
		if test -x /etc/init.d/slapd
			then
			/etc/init.d/slapd start
		fi
	fi
fi

if [ "$1" = configure -a -n "$2" ] && dpkg --compare-versions "$2" lt 1.12; then
	eval `univention-config-registry shell hostname ldap/base server/role`
	if [ "$server_role" = "domaincontroller_master" ]; then
		univention-config-registry set ldap/hostdn="cn=$hostname,cn=dc,cn=computers,$ldap_base"
	fi
fi
if [ "$1" = configure -a -n "$2" ] && dpkg --compare-versions "$2" lt 1.18; then
	eval `univention-config-registry shell hostname domainname server/role ldap/base`
	if [ "$server_role" = "domaincontroller_master" ]; then
		/usr/share/univention-admin-tools/univention-dnsedit --ignore-exists $domainname add srv domaincontroller_master tcp 0 0 0 $hostname.$domainname.
	fi
fi

if [ "$1" = configure -a -n "$2" ] && dpkg --compare-versions "$2" lt 1.19; then
	eval `univention-config-registry shell hostname domainname server/role ldap/base`
	if [ "$server_role" = "domaincontroller_master" ]; then
		univention-admin container/cn create --ignore_exists --set name=mac --position="cn=temporary,cn=univention,$ldap_base" || true
	fi
fi

if [ "$1" = "configure" -a -n "$2" ]; then
	eval `univention-config-registry shell hostname domainname server/role ldap/base`
	if [ "$server_role" = "domaincontroller_master" ]; then
		univention-admin container/cn create --ignore_exists --position "cn=computers,$ldap_base" --set name=memberserver || true
	fi
fi

if [ "$1" = configure -a -n "$2" ] && dpkg --compare-versions "$2" lt 1.21; then
	eval `univention-config-registry shell hostname domainname server/role ldap/base`
	if [ "$server_role" = "domaincontroller_master" ]; then
		univention-admin container/cn create --ignore_exists --set name=shares --position="cn=policies,$ldap_base" || true
		univention-admin container/cn create --ignore_exists --set name=userquota --position="cn=shares,cn=policies,$ldap_base" || true
	fi
fi

if [ "$1" = configure -a -n "$2" ] && dpkg --compare-versions "$2" lt 1.25; then
	eval `univention-config-registry shell hostname domainname server/role ldap/base`
	if [ "$server_role" = "domaincontroller_master" ]; then
		univention-admin container/cn create --ignore_exists --set name=packages --position="cn=univention,$ldap_base" || true
		univention-admin container/cn create --ignore_exists --set name=ldap --position="cn=policies,$ldap_base" || true
		univention-admin container/cn create --ignore_exists --set name=update --position="cn=policies,$ldap_base" || true
		univention-admin container/cn create --ignore_exists --set name=installation --position="cn=update,cn=policies,$ldap_base" || true
		univention-admin container/cn create --ignore_exists --set name=packages --position="cn=update,cn=policies,$ldap_base" || true
		univention-admin container/cn create --ignore_exists --set name=repository --position="cn=update,cn=policies,$ldap_base" || true
		univention-admin settings/packages create --superordinate cn=packages,cn=univention,$ldap_base --set name=Univention \
							--append packageList=univention-samba \
							--append packageList=univention-windows-installer \
							--append packageList=univention-dhcp \
							--append packageList=univention-bind \
							--append packageList=univention-bind-proxy \
							--append packageList=univention-thin-client \
							--append packageList=univention-application-server \
							--append packageList=univention-kde \
							--append packageList=univention-ooffice \
							--append packageList=univention-mozilla \
							--append packageList=univention-mozilla-german \
							--append packageList=univention-fax-client \
							--append packageList=univention-fax-server \
							--append packageList=univention-mail-postfix \
							--append packageList=univention-mail-cyrus \
							--append packageList=univention-squid \
							--append packageList=univention-spamassassin \
							--append packageList=univention-admin \
							--append packageList=unidump \
							--append packageList=univention-printserver \
							--append packageList=univention-x-core \
							--append packageList=univention-net-installer \
							--append packageList=univention-printquota \
							--append packageList=univention-isdn \
							--append packageList=univention-5250 \
							--append packageList=univention-samba-slave-pdc

	univention-admin settings/packages create --superordinate cn=packages,cn=univention,$ldap_base --set name=Debian \
							--append packageList=mutt \
							--append packageList=mc \
							--append packageList=build-essential \
							--append packageList=rdesktop
	fi
fi

if [ "$1" = configure -a -n "$2" ] && dpkg --compare-versions "$2" lt 1.37; then
	eval `univention-config-registry shell hostname domainname server/role ldap/base`
	if [ "$server_role" = "domaincontroller_master" ]; then
		univention-admin container/cn create --ignore_exists --set name=mail --position="cn=policies,$ldap_base" || true
	fi
fi

if [ "$1" = configure -a -n "$2" ] && dpkg --compare-versions "$2" lt 1.34; then
	eval `univention-config-registry shell hostname domainname server/role ldap/base`
	if [ "$server_role" = "domaincontroller_master" ]; then
		if [ -e /var/lib/univention-ldap/schema/id/id ]; then
			id=`cat /var/lib/univention-ldap/schema/id/id`
			id=$((id+100))
			echo -n "$id" >/var/lib/univention-ldap/schema/id/id
		fi

		tmp_file=`mktemp`
		echo "dn: $ldap_base"							>>$tmp_file
		echo "changetype: modify"						>>$tmp_file
		echo "add: objectClass"							>>$tmp_file
		echo "objectClass: univentionBase"				>>$tmp_file
		ldapmodify -x -D "cn=admin,$ldap_base" -w `cat /etc/ldap.secret` -f $tmp_file
		rm $tmp_file

		res=`ldapsearch -x -s base -LLL '(&(nisDomain=@*)(associatedDomain=@*))'`
		if [ -n "$res" ]; then
			tmp_file=`mktemp`
			echo "dn: $ldap_base"							>>$tmp_file
			echo "changetype: modify"						>>$tmp_file
			echo "replace: nisDomain"						>>$tmp_file
			echo "nisDomain: $domainname"					>>$tmp_file
			echo "-"										>>$tmp_file
			echo "replace: associatedDomain"				>>$tmp_file
			echo "associatedDomain: $domainname"			>>$tmp_file
			ldapmodify -x -D "cn=admin,$ldap_base" -w `cat /etc/ldap.secret` -f $tmp_file
			rm $tmp_file
		fi
	fi
fi

if [ "$1" = configure -a -n "$2" ] && dpkg --compare-versions "$2" lt 1.28; then
	eval `univention-config-registry shell hostname domainname server/role ldap/base`
	if [ "$server_role" = "domaincontroller_master" ]; then
		#create idmap folder
		univention-admin container/cn create --position "cn=univention,$ldap_base" --set name=idmap

		tmp_file=`mktemp`
		echo "dn: cn=nextUnixId,cn=idmap,cn=univention,$ldap_base"    >>$tmp_file
		echo "objectClass: top"                                       >>$tmp_file
		echo "objectClass: organizationalRole"                        >>$tmp_file
		echo "objectClass: sambaUnixIdPool"                           >>$tmp_file
		echo "cn: nextUnixId"                                         >>$tmp_file
		echo "uidNumber: 55000"                                       >>$tmp_file
		echo "gidNumber: 55000"                                       >>$tmp_file
		ldapadd -x -D "cn=admin,$ldap_base" -w `cat /etc/ldap.secret` -f $tmp_file
		rm $tmp_file
	fi
fi
if [ "$1" = configure -a -n "$2" ] && dpkg --compare-versions "$2" lt 1.34; then
	eval `univention-config-registry shell hostname domainname server/role ldap/base`
	if [ "$server_role" = "domaincontroller_master" ]; then
	univention-admin container/cn create --ignore_exists --set name=printquota --position="cn=shares,cn=policies,$ldap_base" || true
	univention-admin container/cn create --ignore_exists --set name=groupName --position="cn=temporary,cn=univention,$ldap_base" || true
	univention-admin settings/printeruri create --ignore_exists --set name=printeruris --superordinate="cn=cups,cn=univention,$ldap_base" --append printeruri="lpd://" --append printeruri="ipp://" --append printeruri="http://" --append printeruri="usb:/" --append printeruri="socket://" --append printeruri="parallel:/" --append printeruri="file:/" --append printeruri="smb://"|| true

	fi
fi

if [ "$1" = configure -a -n "$2" ] && dpkg --compare-versions "$2" lt 1.34; then
	eval `univention-config-registry shell hostname domainname server/role ldap/base`
	if [ "$server_role" = "domaincontroller_master" ]; then
		univention-admin container/cn create --ignore_exists --set name=samba || true
	fi
fi
if [ "$1" = configure -a -n "$2" ] && dpkg --compare-versions "$2" lt 1.41-28; then
	eval `univention-config-registry shell hostname domainname server/role ldap/base`
	if [ "$server_role" = "domaincontroller_master" ]; then
		univention-admin container/cn create --ignore_exists --set name=admin-settings --position cn=univention,$ldap_base
		univention-admin container/cn create --ignore_exists --set name=services --position cn=univention,$ldap_base
		univention-admin settings/service create --ignore_exists --set name=kolab2 --position cn=services,cn=univention,$ldap_base

		univention-admin container/cn create --ignore_exists --set name=mailPrimaryAddress --position="cn=temporary,cn=univention,$ldap_base"

		univention-admin container/cn create --ignore_exists  --position "$ldap_base" --set name="mail"
		univention-admin container/cn create --ignore_exists  --position "cn=mail,$ldap_base" --set name="folder" --set description="Shared folders (Kolab 2)"  --set mailPath=1
		univention-admin container/cn create --ignore_exists  --position "cn=mail,$ldap_base" --set name="domain"  --set mailPath=1
		univention-admin container/cn create --ignore_exists  --position "cn=mail,$ldap_base" --set name="mailinglists"  --set mailPath=1
		univention-admin container/cn create --ignore_exists  --position "cn=policies,$ldap_base" --set name="mail"  --set policyPath=1
		univention-admin container/cn create --ignore_exists  --position "cn=temporary,cn=univention,$ldap_base" --set name="mail"

		univention-admin settings/directory modify --dn "cn=default containers,cn=univention,$ldap_base" \
			--append policies=cn=policies,$ldap_base \
			--append policies=cn=desktop,cn=policies,$ldap_base \
			--append policies=cn=shares,cn=policies,$ldap_base \
			--append policies=cn=userquota,cn=shares,cn=policies,$ldap_base \
			--append policies=cn=printquota,cn=shares,cn=policies,$ldap_base \
			--append policies=cn=update,cn=policies,$ldap_base \
			--append policies=cn=ldap,cn=policies,$ldap_base \
			--append policies=cn=installation,cn=update,cn=policies,$ldap_base \
			--append policies=cn=packages,cn=update,cn=policies,$ldap_base \
			--append policies=cn=repository,cn=update,cn=policies,$ldap_base \
			--append policies=cn=dhcp,cn=policies,$ldap_base \
			--append policies=cn=boot,cn=dhcp,cn=policies,$ldap_base \
			--append policies=cn=dns,cn=dhcp,cn=policies,$ldap_base \
			--append policies=cn=dnsupdate,cn=dhcp,cn=policies,$ldap_base \
			--append policies=cn=leasetime,cn=dhcp,cn=policies,$ldap_base \
			--append policies=cn=netbios,cn=dhcp,cn=policies,$ldap_base \
			--append policies=cn=routing,cn=dhcp,cn=policies,$ldap_base \
			--append policies=cn=scope,cn=dhcp,cn=policies,$ldap_base \
			--append policies=cn=statements,cn=dhcp,cn=policies,$ldap_base \
			--append policies=cn=sound,cn=policies,$ldap_base \
			--append policies=cn=thinclient,cn=policies,$ldap_base \
			--append policies=cn=xfree,cn=policies,$ldap_base \
			--append policies=cn=mail,cn=policies,$ldap_base \
			--append policies=cn=windowsinstallations,cn=policies,$ldap_base \
			--append policies=cn=users,cn=policies,$ldap_base \
			--append policies=cn=pwhistory,cn=users,cn=policies,$ldap_base

		univention-admin container/cn create --ignore_exists  --position "cn=policies,$ldap_base" --set name="admin"
		univention-admin container/cn create --ignore_exists  --position "cn=admin,cn=policies,$ldap_base" --set name="user" --set policyPath=1
		univention-admin container/cn create --ignore_exists  --position "cn=admin,cn=policies,$ldap_base" --set name="container" --set policyPath=1
	fi
fi

if [ "$1" = configure -a -n "$2" ] && dpkg --compare-versions "$2" lt 1.42-10; then
	eval `univention-config-registry shell server/role ldap/base`
	if [ "$server_role" = "domaincontroller_master" ]; then
		univention-admin container/cn create --ignore_exists			\
			--set name=admin-settings					\
			--position=cn=users,cn=policies,$ldap_base
		univention-admin policies/admin_user create --ignore_exists		\
			--set name=default-users					\
			--position cn=admin-settings,cn=users,cn=policies,$ldap_base	\
			--set listWizards=None						\
			--set listWebModules=modself					\
			--append selfAttributes=kolabVacationText			\
			--append selfAttributes=kolabVacationActive			\
			--append selfAttributes=kolabDeliveryToFolderActive		\
			--append selfAttributes=kolabDeliveryToFolderName		\
			--append selfAttributes=kolabForwardActive			\
			--append selfAttributes=kolabForwardAddress			\
			--append selfAttributes=kolabForwardKeepCopy			\
			--append selfAttributes=kolabVacationAddress			\
			--append selfAttributes=kolabVacationNoReactDomain		\
			--append selfAttributes=kolabInvitationPolicy			\
			--append selfAttributes=kolabForwardUCE				\
			--set mayOverrideSettings=0
		univention-admin policies/admin_user create --ignore_exists		\
			--set name=default-admins					\
			--position cn=admin-settings,cn=users,cn=policies,$ldap_base	\
			--append emptyAttributes=univentionAdminListWizards		\
			--append emptyAttributes=univentionAdminListWebModules		\
			--set mayOverrideSettings=1
	fi
fi

if [ "$1" = configure -a -n "$2" ] && dpkg --compare-versions "$2" lt 1.42-19; then
	eval `univention-config-registry shell server/role ldap/base domainname ldap/hostdn`
	if [ "$server_role" = "domaincontroller_master" ]; then
		univention-admin computers/domaincontroller_master modify --dn "$ldap_hostdn" --set domain=$domainname
	fi
fi
if [ "$1" = configure -a -n "$2" ] && dpkg --compare-versions "$2" lt 1.42-29; then
	eval `univention-config-registry shell server/role ldap/base domainname ldap/hostdn`
	if [ "$server_role" = "domaincontroller_master" ]; then
		ldapsearch -x '(&(objectClass=univentionPolicyUpdate)(!(univentionUpdateActivate=*)))' -LLL | grep ^dn | sed -e 's|dn: ||' | while read dn; do
			temp=`mktemp`
			echo "dn: $dn"                           >>$temp
			echo "changetype: modify"                >>$temp
			echo "replace: univentionUpdateActivate" >>$temp
			echo "univentionUpdateActivate: TRUE"    >>$temp
			ldapmodify -x -D cn=admin,$ldap_base -w $(cat /etc/ldap.secret) -f $temp
			rm -f $temp
		done
	fi
fi
if [ "$1" = configure -a -n "$2" ] && dpkg --compare-versions "$2" lt 1.43-18; then
	eval `univention-config-registry shell server/role ldap/base domainname ldap/hostdn`
	if [ "$server_role" = "domaincontroller_master" ]; then
		/usr/share/univention-ldap/convert_shadowMax.py
	fi

fi

# add DC Backup Hosts to the other computer groups
if [ "$1" = configure -a -n "$2" ] && dpkg --compare-versions "$2" lt 1.43-19.170; then
	eval `univention-config-registry shell server/role ldap/base domainname ldap/hostdn`
	if [ "$server_role" = "domaincontroller_master" ]; then
		univention-admin groups/group modify --dn "cn=DC Backup Hosts,cn=groups,$ldap_base" \
			--append memberOf="cn=DC Slave Hosts,cn=groups,$ldap_base" \
			--append memberOf="cn=Computers,cn=groups,$ldap_base" \
			--append memberOf="cn=Windows Hosts,cn=groups,$ldap_base"

		univention-admin container/cn create --ignore_exists \
			--set name=nfsmounts \
			--position=cn=policies,$ldap_base --set policyPath=1
	fi
fi
if [ "$1" = configure -a -n "$2" ] && dpkg --compare-versions "$2" lt 2.2.3-1; then
	eval `univention-config-registry shell server/role ldap/base domainname ldap/hostdn`
	if [ "$server_role" = "domaincontroller_master" ]; then
		univention-admin container/cn create --ignore_exists \
			--set name=printservers \
			--position=cn=policies,$ldap_base --set policyPath=1
	fi
fi

if [ "$1" = configure -a -n "$2" ] && dpkg --compare-versions "$2" lt 3.0.9-1; then
	eval `univention-config-registry shell server/role ldap/base domainname ldap/hostdn`
	if [ "$server_role" = "domaincontroller_master" ]; then
		univention-directory-manager groups/group modify  --ignore_exists \
			--dn "cn=Domain Users,cn=groups,$ldap_base" \
			--append users="uid=Administrator,cn=users,$ldap_base" || true
	fi
fi

if [ "$1" = configure -a -n "$2" ] && dpkg --compare-versions "$2" lt 5.0.7-1; then
	eval `univention-config-registry shell server/role ldap/base`
	if [ "$server_role" = "domaincontroller_master" ]; then
		univention-admin container/cn create --ignore_exists \
			--set name=config-registry \
			--set policyPath=1 \
			--position=cn=policies,$ldap_base
	fi
fi

if [ "$1" = configure -a -n "$2" ] && dpkg --compare-versions "$2" lt 5.0.8-1; then
	eval `univention-config-registry shell server/role ldap/base`
	if [ "$server_role" = "domaincontroller_master" ]; then
		univention-directory-manager  settings/packages modify \
			--dn cn=Fernwartung,cn=packages,cn=univention,$ldap_base \
			--remove packageList=opnessh-server \
			--append packageList=openssh-server
	fi
fi

# Bug 21187
if [ "$1" = configure -a -n "$2" ] && dpkg --compare-versions "$2" lt 7.0.17-1; then
	if [ "$server_role" = "domaincontroller_master" ]; then
		if univention-directory-manager settings/packages list --filter=name=Univention | grep -iq univention-prinquota; then 
			univention-directory-manager settings/packages modify \
				--dn "cn=Univention,cn=packages,cn=univention,$ldap_base" \
				--remove packageList=univention-prinquota
		fi
		if ! univention-directory-manager settings/packages list --filter=name=Univention | grep -iq univention-printquota; then
			univention-directory-manager settings/packages modify \
				--dn "cn=Univention,cn=packages,cn=univention,$ldap_base" \
				--append packageList=univention-printquota
		fi
	fi
fi

# fix primary group membership of computer objects if neccessary (Bug #21711)
if [ "$1" = "configure" -a -n "$2" ] && dpkg --compare-versions "$2" lt 7.0.18-1; then
	eval "$(ucr shell)"
	if [ ! "$update_fix_computer_primarygroupmembership" = "no" -a ! "$update_fix_computer_primarygroupmembership" = "false" ] ; then
		if [ "$server_role" = "domaincontroller_master" ] ; then
			/usr/share/univention-directory-manager-tools/fix_primary_group_membership -c -f
		fi
	fi
	if [ ! "$update_fix_user_primarygroupmembership" = "no" -a ! "$update_fix_user_primarygroupmembership" = "false" ] ; then
		if [ "$server_role" = "domaincontroller_master" ] ; then
			/usr/share/univention-directory-manager-tools/fix_primary_group_membership -u -f
		fi
	fi
fi

exit 0
