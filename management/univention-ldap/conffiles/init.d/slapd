#!/bin/sh
@%@UCRWARNING=# @%@
### BEGIN INIT INFO
# Provides:          slapd
# Required-Start:    $remote_fs $network $syslog
# Required-Stop:     $remote_fs $network $syslog
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: OpenLDAP standalone server (Lightweight Directory Access Protocol)
### END INIT INFO
#
# Written by Miquel van Smoorenburg <miquels@drinkel.ow.org>.
# Modified for Debian GNU/Linux by Ian Murdock <imurdock@gnu.ai.mit.edu>.
# Modified for Debian by Christoph Lameter <clameter@debian.org>
# Modified for OpenLDAP by Ben Collins <bcollins@debian.org>
# Modified for UCS by Univention <packages@univention.de>


PATH=/bin:/usr/bin:/sbin:/usr/sbin
DAEMON=/usr/sbin/slapd
SLAPDCONF=/etc/ldap/slapd.conf

. /lib/lsb/init-functions

bdbrecover ()
{
	# determine libdb version that back-bdb.so was linked against
	back_bdb_version="$(/usr/bin/ldd /usr/lib/ldap/back_bdb.so | sed -n 's|.*/usr/lib/libdb-\([0-9.]*\).so.*|\1|p')"
	DBRECOVER="/usr/bin/db${back_bdb_version}_recover"
	DBSTAT="/usr/bin/db${back_bdb_version}_stat"
	if [ -e "${DBRECOVER}" ]; then
		if "${DBSTAT}" -e -h /var/lib/univention-ldap/ldap/ | grep -q 'Environment version'; then
			cd /var/lib/univention-ldap/ldap
			"${DBRECOVER}" -h /var/lib/univention-ldap/ldap
		else
			log_action_msg "/var/lib/univention-ldap/ldap BDB Version does not seem to match the one back-bdb uses"
			log_action_msg "Skipping ${DBRECOVER} to avoid damage"
		fi
	else
		log_action_msg "back-bdb was linked against ${back_bdb_version}, but db${back_bdb_version}-util package does not seem to be installed"
		log_action_msg "Skipping ${DBRECOVER}"
	fi
}

check_subschema ()
{
    sleep 5
    tmpfile=`mktemp`
    res=1
	count=0
    while [ $res != 0 ] ; do
        ldapsearch -x -H ldapi:/// -s base -b cn=Subschema 'objectClass=subschema' objectClasses attributeTypes matchingRules matchingRuleUse dITStructureRules dITContentRules nameForms ldapSyntaxes >$tmpfile
		res=$?
        if [ $res != 0 ]; then
			count=$((count+1))
			if [ $count = 2 ]; then
				echo "Failed to search schema"
				exit 1
			fi
            sleep 2
        fi
    done

    @!@
if baseConfig.has_key('ldap/schema/export') and  baseConfig['ldap/schema/export'].lower() in ['yes', 'true']:
        print 'cp $tmpfile /var/www/ldap-schema.txt'
        print 'chmod a+r /var/www/ldap-schema.txt'
    @!@

    md5=`md5sum $tmpfile | awk '{print $1}'`
    if [ ! -d /var/lib/univention-ldap/schema ]; then
        mkdir /var/lib/univention-ldap/schema
    fi
    if [ ! -e /var/lib/univention-ldap/schema/md5 ]; then
        touch /var/lib/univention-ldap/schema/md5
    fi
    md5_old=`cat /var/lib/univention-ldap/schema/md5`
    if [ "$md5" != "$md5_old" ]; then
        if [ ! -d /var/lib/univention-ldap/schema/id ]; then
           mkdir /var/lib/univention-ldap/schema/id
        fi
        if [ ! -e /var/lib/univention-ldap/schema/id/id ]; then
           touch /var/lib/univention-ldap/schema/id/id
        fi
        id=`cat /var/lib/univention-ldap/schema/id/id`
        if [ -z "$id" ]; then
          id=0
        fi
        id=$((id+1))
        echo "$md5" >/var/lib/univention-ldap/schema/md5
        echo "$id" >/var/lib/univention-ldap/schema/id/id
        chown listener /var/lib/univention-ldap/schema/id/id
     else
        id=`cat /var/lib/univention-ldap/schema/id/id`
        if [ -z "$id" ]; then
          echo "1" >/var/lib/univention-ldap/schema/id/id
          chown listener /var/lib/univention-ldap/schema/id/id
        fi
    fi
}

check_replog_file ()
{
test -f /var/lib/univention-ldap/replog/replog || \
	touch /var/lib/univention-ldap/replog/replog
chmod 0600 /var/lib/univention-ldap/replog/replog
test -f /var/lib/univention-ldap/replog/replog.lock || \
	touch /var/lib/univention-ldap/replog/replog.lock
}


if [ -f "$SLAPDCONF" ]; then
    pidfile=`grep ^pidfile $SLAPDCONF | awk '{print $2}'`
    if [ -z "$pidfile" ]; then
	pidfile="/var/run/slapd/slapd.pid"
    fi
else
    exit 0
fi

test -f $DAEMON || exit 0

case "$1" in
  start)
	# check ucr autostart setting
	if [ -f "/usr/share/univention-config-registry/init-autostart.lib" ]; then
	    . "/usr/share/univention-config-registry/init-autostart.lib"
	    check_autostart ldap ldap/autostart
	fi
   @!@
if baseConfig['ldap/database/type'] == 'bdb':
	print 'echo -n "Check database: "'
	print 'bdbrecover'
	print 'echo "done"'
	print 'echo -n "  "'
if configRegistry.get('ldap/replog', '').lower() in ('true', 'yes'):
	print 'check_replog_file'
   @!@

    log_action_msg "Starting ldap server(s): slapd"
	(
@!@
uris=['ldapi:///']
for p in configRegistry.get('slapd/port', '7389').split(','):
	uris.append('ldap://:%s/' % p)
for p in configRegistry.get('slapd/port/ldaps', '7636').split(','):
	uris.append('ldaps://:%s/' % p)
print '\turis="%s"' % ' '.join(uris)
if configRegistry.get('ldap/maxopenfiles'):
	print '\t\tulimit -n %s' % configRegistry['ldap/maxopenfiles']
@!@		start-stop-daemon --start --quiet --pidfile "$pidfile" \
			--exec $DAEMON -- -h "${uris}"
	)

	test -e /var/run/slapd/ldapi && ln -sf /var/run/slapd/ldapi /var/run/ldapi

   @!@
if baseConfig['ldap/server/type']=="master":	   
    print 'check_subschema >/dev/null 2>&1'
   @!@

    echo "."

	if [ -e /var/lib/univention-directory-replication/failed.ldif ]; then
    	log_action_msg "Found failed.ldif. Importing"
		test -x /usr/sbin/univention-directory-replication-resync && /usr/sbin/univention-directory-replication-resync /var/lib/univention-directory-replication/failed.ldif >>/var/log/univention/listener.log 2>&1
		if [ $? = 0 ]; then
			log_action_end_msg 0
		else
			log_action_end_msg 1
			log_action_msg "Please check /var/log/univention/listener.log"
			exit 1
		fi
	fi
	
    ;;
  stop)
    log_action_msg "Stopping ldap server(s): slapd"
	start-stop-daemon --stop --quiet --oknodo --retry 10 \
	    --pidfile "$pidfile" \
	    --exec /usr/sbin/slapd 2>&1
    log_action_end_msg 0
    ;;
  restart|force-reload)
    log_action_msg "Restarting ldap server(s)"
    $0 stop
    sleep 2 # give it some time to die
    $0 start
    ;;
  force-stop)
    log_action_msg "Stopping ldap servers (forced) "
    killall slapd > /dev/null 2>&1
    log_action_end_msg 0
    ;;
  crestart)
	if pidof slapd > /dev/null 2>&1
		then
		$0 restart
	else
		log_action_msg "No slapd process found, no restart needed"
	fi
	;;
  *)
    echo "Usage: $0 {start|stop|restart|force-stop|crestart}"
    exit 1
    ;;
esac

exit 0
